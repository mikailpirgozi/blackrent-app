import { useMemo } from 'react';

import { useAuth } from '../context/AuthContext';
import { usePermissionsContext } from '../context/PermissionsContext';
import { logger } from '@/utils/smartLogger';
import type {
  CompanyPermissions,
  Permission,
  PermissionResult,
  UserCompanyAccess,
  UserRole,
} from '../types';

// üîê FRONTEND ROLE PERMISSIONS MATRIX (fallback pre admin)
export const ROLE_PERMISSIONS: Record<UserRole, Permission[]> = {
  // üëë SUPER_ADMIN - √öpln√© pr√°va na v≈°etko, v≈°etky firmy
  super_admin: [
    {
      resource: '*',
      actions: ['read', 'create', 'update', 'delete'],
      conditions: {},
    },
  ],

  // üëë PLATFORM_ADMIN - √öpln√© pr√°va vo vlastnej platforme
  platform_admin: [
    {
      resource: '*',
      actions: ['read', 'create', 'update', 'delete'],
      conditions: { companyOnly: true },
    },
  ],

  // üë• PLATFORM_EMPLOYEE - Obmedzen√© pr√°va
  platform_employee: [],

  // ‚ö†Ô∏è DEPRECATED ROLES (for backwards compatibility)
  admin: [
    {
      resource: '*',
      actions: ['read', 'create', 'update', 'delete'],
      conditions: {},
    },
  ],

  // üè¢ COMPANY_ADMIN - √öpln√© pr√°va len vo vlastnej firme
  company_admin: [
    {
      resource: '*',
      actions: ['read', 'create', 'update', 'delete'],
      conditions: { companyOnly: true },
    },
  ],

  // Ostatn√© roly sa teraz riadia company-based permissions
  investor: [],
  employee: [],
  temp_worker: [],
  mechanic: [],
  sales_rep: [],
};

// üõ°Ô∏è COMPANY-BASED PERMISSION CHECK FUNCTION
export function hasCompanyPermission(
  userCompanyAccess: UserCompanyAccess[],
  userRole: UserRole,
  resource: string,
  action: 'read' | 'write' | 'delete',
  context?: {
    companyId?: string;
    userId?: string;
  }
): PermissionResult {
  // Admin roles (legacy admin, super_admin) maj√∫ v≈ædy pr√°va
  if (userRole === 'admin' || userRole === 'super_admin') {
    return { hasAccess: true, requiresApproval: false };
  }

  // Company Admin m√° pln√© pr√°va vo svojej firme
  if (userRole === 'company_admin') {
    return { hasAccess: true, requiresApproval: false };
  }

  // Ak nie je zadan√© companyId, skontroluj v≈°etky firmy pou≈æ√≠vateƒæa
  if (!context?.companyId) {
    // M√° pou≈æ√≠vateƒæ pr√≠stup k tomuto resource aspo≈à v jednej firme?
    const hasAnyAccess = userCompanyAccess.some(access => {
      const resourcePermission =
        access.permissions[resource as keyof CompanyPermissions];
      if (!resourcePermission) return false;

      if (action === 'read') return resourcePermission.read;
      if (action === 'write') return resourcePermission.write;
      if (action === 'delete') return resourcePermission.delete;
      return false;
    });

    if (hasAnyAccess) {
      return { hasAccess: true, requiresApproval: false };
    } else {
      return {
        hasAccess: false,
        requiresApproval: false,
        reason: 'Nem√°te opr√°vnenie k tomuto zdroju v ≈æiadnej firme',
      };
    }
  }

  // Kontrola pre konkr√©tnu firmu
  const companyAccess = userCompanyAccess.find(
    access => access.companyId === context.companyId
  );
  if (!companyAccess) {
    return {
      hasAccess: false,
      requiresApproval: false,
      reason: 'Nem√°te pr√≠stup k tejto firme',
    };
  }

  const resourcePermission =
    companyAccess.permissions[resource as keyof CompanyPermissions];
  if (!resourcePermission) {
    return {
      hasAccess: false,
      requiresApproval: false,
      reason: 'Nezn√°my zdroj',
    };
  }

  let hasAccess = false;
  if (action === 'read') hasAccess = resourcePermission.read;
  if (action === 'write') hasAccess = resourcePermission.write;
  if (action === 'delete') hasAccess = resourcePermission.delete;

  if (hasAccess) {
    return { hasAccess: true, requiresApproval: false };
  } else {
    return {
      hasAccess: false,
      requiresApproval: false,
      reason: `Nem√°te opr√°vnenie na '${action}' pre '${resource}' v tejto firme`,
    };
  }
}

// üõ°Ô∏è LEGACY PERMISSION CHECK FUNCTION (pre sp√§tn√∫ kompatibilitu)
export function hasLegacyPermission(
  userRole: UserRole,
  resource: Permission['resource'],
  action: Permission['actions'][0],
  context?: {
    userId?: string;
    companyId?: string;
    resourceOwnerId?: string;
    resourceCompanyId?: string;
    amount?: number;
  }
): PermissionResult {
  // Admin and super_admin maj√∫ v≈ædy pr√°va
  if (userRole === 'admin' || userRole === 'super_admin') {
    return { hasAccess: true, requiresApproval: false };
  }

  // Pre ostatn√© roly vr√°ti false - pou≈æ√≠vaj√∫ sa company permissions
  // Parametre s√∫ zachovan√© pre kompatibilitu
  logger.debug('hasLegacyPermission called for non-admin role:', {
    userRole,
    resource,
    action,
    context,
  });
  return {
    hasAccess: false,
    requiresApproval: false,
    reason: 'Pou≈æ√≠vajte company-based permissions',
  };
}

// üéØ REACT HOOK PRE PERMISSIONS
export function usePermissions() {
  const { state } = useAuth();
  const user = state.user;
  const { userCompanyAccess, permissionsLoading, permissionsError } =
    usePermissionsContext();

  const permissions = useMemo(() => {
    if (!user) {
      return {
        canRead: () => false,
        canCreate: () => false,
        canUpdate: () => false,
        canDelete: () => false,
        hasPermission: (): PermissionResult => ({
          hasAccess: false,
          requiresApproval: false,
          reason: 'Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω',
        }),
        hasCompanyPermission: (): PermissionResult => ({
          hasAccess: false,
          requiresApproval: false,
          reason: 'Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω',
        }),
        getUserPermissions: () => [],
        getUserCompanyAccess: () => [],
        getAccessibleCompanies: () => [],
        currentUser: null,
        isAdmin: false,
        isEmployee: false,
        isTempWorker: false,
        isMechanic: false,
        isSalesRep: false,
        isCompanyOwner: false,
        permissionsLoading: false,
        permissionsError: null,
      };
    }

    return {
      // üîç COMPANY-BASED PERMISSION FUNCTIONS
      canRead: (resource: string, context?: { companyId?: string }) => {
        // Pre investor - automaticky povol√≠ resources definovan√© v backend ROLE_PERMISSIONS
        if (user.role === 'investor') {
          const backendPermissions = [
            'vehicles',
            'rentals',
            'expenses',
            'insurances',
            'companies',
            'finances',
            'protocols',
            'settlements',
            'customers',
          ];
          if (backendPermissions.includes(resource)) {
            return true;
          }
        }
        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          'read',
          context
        ).hasAccess;
      },

      canCreate: (resource: string, context?: { companyId?: string }) => {
        // Pre investor - obmedzen√© create permissions
        if (user.role === 'investor') {
          const writePermissions = ['rentals', 'expenses', 'settlements']; // len niektor√© resources m√¥≈æe vytv√°ra≈•
          if (writePermissions.includes(resource)) {
            return true;
          }
          return false;
        }
        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          'write',
          context
        ).hasAccess;
      },

      canUpdate: (resource: string, context?: { companyId?: string }) => {
        // Pre investor - obmedzen√© update permissions
        if (user.role === 'investor') {
          const updatePermissions = ['companies', 'settlements']; // len svoju firmu a vy√∫ƒçtovania m√¥≈æe upravi≈•
          if (updatePermissions.includes(resource)) {
            return true;
          }
          return false;
        }
        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          'write',
          context
        ).hasAccess;
      },

      canDelete: (resource: string, context?: { companyId?: string }) => {
        // Pre investor - obmedzen√© delete permissions
        if (user.role === 'investor') {
          const deletePermissions = ['settlements']; // len vy√∫ƒçtovania m√¥≈æe maza≈•
          if (deletePermissions.includes(resource)) {
            return true;
          }
          return false;
        }
        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          'delete',
          context
        ).hasAccess;
      },

      // üõ°Ô∏è FULL PERMISSION CHECK
      hasPermission: (
        resource: Permission['resource'],
        action: Permission['actions'][0],
        context?: Record<string, unknown>
      ): PermissionResult => {
        // Pre admin roles (legacy admin, super_admin) pou≈æ√≠vame legacy funkciu (√∫pln√© pr√°va)
        if (user.role === 'admin' || user.role === 'super_admin') {
          return hasLegacyPermission(user.role, resource, action, {
            userId: user.id,
            ...(user.companyId && { companyId: user.companyId }),
            ...context,
          });
        }

        // Pre company_admin pln√© pr√°va vo vlastnej firme
        if (user.role === 'company_admin') {
          return { hasAccess: true, requiresApproval: false };
        }

        // Pre v≈°etk√Ωch ostatn√Ωch (vr√°tane investor) pou≈æ√≠vame company-based permissions
        const actionMap = {
          read: 'read',
          create: 'write',
          update: 'write',
          delete: 'delete',
        } as const;

        const mappedAction = actionMap[action as keyof typeof actionMap];
        if (!mappedAction) {
          return {
            hasAccess: false,
            requiresApproval: false,
            reason: 'Nezn√°ma akcia',
          };
        }

        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          mappedAction,
          {
            userId: user.id,
            ...(user.companyId && { companyId: user.companyId }),
            ...context,
          }
        );
      },

      // üè¢ COMPANY-BASED PERMISSION CHECK
      hasCompanyPermission: (
        resource: string,
        action: 'read' | 'write' | 'delete',
        context?: { companyId?: string }
      ): PermissionResult => {
        // Pre investor pou≈æ√≠vame vlastn√∫ logiku
        if (user.role === 'investor') {
          const backendPermissions = [
            'vehicles',
            'rentals',
            'expenses',
            'insurances',
            'companies',
            'finances',
            'protocols',
            'settlements',
            'customers',
          ];

          if (action === 'read' && backendPermissions.includes(resource)) {
            return { hasAccess: true, requiresApproval: false };
          }

          if (
            action === 'write' &&
            ['rentals', 'expenses', 'companies', 'settlements'].includes(
              resource
            )
          ) {
            return { hasAccess: true, requiresApproval: false };
          }

          if (action === 'delete' && ['settlements'].includes(resource)) {
            return { hasAccess: true, requiresApproval: false };
          }

          return {
            hasAccess: false,
            requiresApproval: false,
            reason: 'Company owner nem√° opr√°vnenie na t√∫to akciu',
          };
        }

        return hasCompanyPermission(
          userCompanyAccess,
          user.role,
          resource,
          action,
          {
            userId: user.id,
            ...context,
          }
        );
      },

      // üìã GET ALL USER PERMISSIONS
      getUserPermissions: () => ROLE_PERMISSIONS[user.role] || [],

      // üè¢ GET USER COMPANY ACCESS
      getUserCompanyAccess: () => userCompanyAccess,

      // üè¢ GET ACCESSIBLE COMPANIES
      getAccessibleCompanies: () =>
        userCompanyAccess.map(access => ({
          id: access.companyId,
          name: access.companyName,
        })),

      // üë§ CURRENT USER INFO
      currentUser: user,

      // üè¢ ROLE CHECKS
      isAdmin: user.role === 'admin',
      isEmployee: user.role === 'employee',
      isTempWorker: user.role === 'temp_worker',
      isMechanic: user.role === 'mechanic',
      isSalesRep: user.role === 'sales_rep',
      isCompanyOwner: user.role === 'investor',

      // üìä LOADING & ERROR STATES
      permissionsLoading,
      permissionsError,
    };
  }, [user, userCompanyAccess, permissionsLoading, permissionsError]);

  return permissions;
}

// üéØ UTILITY FUNCTIONS
export function canUserAccess(
  userRole: UserRole,
  resource: Permission['resource'],
  action: Permission['actions'][0]
): boolean {
  return hasLegacyPermission(userRole, resource, action).hasAccess;
}

export function getUserRoleDisplayName(role: UserRole): string {
  const roleNames: Record<UserRole, string> = {
    super_admin: 'üåü Super Admin',
    platform_admin: 'üëë Platform Admin',
    platform_employee: 'üë• Platform Employee',
    investor: 'üí∞ Investor',
    admin: 'üëë Administr√°tor (Legacy)',
    company_admin: 'üè¢ Company Admin (Legacy)',
    employee: 'üë• Zamestnanec (Legacy)',
    temp_worker: 'üîß Brig√°dnik (Legacy)',
    mechanic: 'üî® Mechanik (Legacy)',
    sales_rep: 'üíº Obchodn√Ω z√°stupca (Legacy)',
  };

  return roleNames[role] || role;
}
