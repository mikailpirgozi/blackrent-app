import{c as _,j as e,a as d,ar as h,H as me,J as ue,T as F,B as S,o as J,I as X,aq as Ie,K as ge,Q as Me,t as ce,at as Be,X as de,R as xe,v as ze,a7 as Se,aC as pe,x as he,M as Ce,N as Re,O as Ee,P as re,a1 as qe,aB as Qe,G as Ge,q as Je,av as Xe}from"./index-DfP_Aygt.js";import{S as _e}from"./Switch-Bee8sYsg.js";const Ye=_(e.jsx("path",{d:"M3.27 3 2 4.27l5 5V13h3v9l3.58-6.14L17.73 20 19 18.73zM17 10h-4l4-8H7v2.18l8.46 8.46z"}),"FlashOff"),Ze=_(e.jsx("path",{d:"M7 2v11h3v9l7-12h-4l4-8z"}),"FlashOn"),et=_(e.jsx("path",{d:"M20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m-8 13c-2.76 0-5-2.24-5-5H5l2.5-2.5L10 13H8c0 2.21 1.79 4 4 4 .58 0 1.13-.13 1.62-.35l.74.74c-.71.37-1.5.61-2.36.61m4.5-2.5L14 13h2c0-2.21-1.79-4-4-4-.58 0-1.13.13-1.62.35l-.74-.73C10.35 8.24 11.14 8 12 8c2.76 0 5 2.24 5 5h2z"}),"FlipCameraIos"),fe=_([e.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),e.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")],"PhotoCamera"),tt=_(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.89-2-2-2m0 16H5V7h14zm-5.5-6c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5M12 9c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5"}),"Preview"),lt=_([e.jsx("path",{d:"m20.38 8.57-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 15.58 6.85l1.85-1.23A10 10 0 0 0 3.35 19a2 2 0 0 0 1.72 1h13.85a2 2 0 0 0 1.74-1 10 10 0 0 0-.27-10.44z"},"0"),e.jsx("path",{d:"M10.59 15.41a2 2 0 0 0 2.83 0l5.66-8.49-8.49 5.66a2 2 0 0 0 0 2.83"},"1")],"SpeedOutlined"),Pe=_(e.jsx("path",{d:"M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3z"}),"VideoCall"),Ae=async(p,x={})=>{const{maxWidth:w=2560,maxHeight:C=1920,quality:l=.92,maxSize:m=1500,format:j="image/jpeg"}=x;return new Promise((B,v)=>{const s=new Image;s.onload=()=>{const c=document.createElement("canvas"),R=c.getContext("2d");if(!R){v(new Error("Canvas context not available"));return}let{width:f,height:u}=s;f>u?f>w&&(u=u*w/f,f=w):u>C&&(f=f*C/u,u=C),c.width=f,c.height=u,R.drawImage(s,0,0,f,u);let N=l;const $=y=>{c.toBlob(A=>{if(!A){v(new Error("Failed to compress image"));return}if(A.size/1024>m&&y>.1){$(y-.1);return}B({compressedBlob:A,originalSize:p.size,compressedSize:A.size,compressionRatio:(p.size-A.size)/p.size*100,width:f,height:u})},j,y)};$(N)},s.onerror=()=>v(new Error("Failed to load image")),s.src=URL.createObjectURL(p)})},Fe={mobile:{maxWidth:1920,maxHeight:1080,quality:.85,maxSize:800,format:"image/jpeg"},protocol:{maxWidth:2560,maxHeight:1920,quality:.92,maxSize:1500,format:"image/jpeg"},highQuality:{maxWidth:3840,maxHeight:2160,quality:.95,maxSize:3e3,format:"image/jpeg"},archive:{maxWidth:4096,maxHeight:3072,quality:.98,maxSize:5e3,format:"image/jpeg"},webpMobile:{maxWidth:1920,maxHeight:1080,quality:.8,maxSize:500,format:"image/webp"},webpProtocol:{maxWidth:2560,maxHeight:1920,quality:.85,maxSize:1e3,format:"image/webp"},webpHighQuality:{maxWidth:3840,maxHeight:2160,quality:.9,maxSize:2e3,format:"image/webp"},webpArchive:{maxWidth:4096,maxHeight:3072,quality:.95,maxSize:3500,format:"image/webp"}},We=()=>new Promise(p=>{const x=new Image;x.onload=x.onerror=()=>{p(x.height===2)},x.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA"}),rt=async(p,x=!0,w="protocol")=>{const C=await We();if(x&&C){const l=`webp${w.charAt(0).toUpperCase()+w.slice(1)}`;return Ae(p,Fe[l])}else return Ae(p,Fe[w])};async function at(p,x={maxSizeInMB:10,quality:.8,maxWidth:1920,maxHeight:1080}){return new Promise((w,C)=>{const l=document.createElement("video"),m=document.createElement("canvas"),j=m.getContext("2d");if(!j){C(new Error("Canvas context not available"));return}l.onloadedmetadata=()=>{const{width:B,height:v}=it(l.videoWidth,l.videoHeight,x.maxWidth||1920,x.maxHeight||1080);m.width=B,m.height=v,j.drawImage(l,0,0,B,v),m.toBlob(s=>{if(!s){C(new Error("Failed to compress video"));return}const c=new File([s],p.name,{type:"video/mp4",lastModified:Date.now()}),R=p.size/(1024*1024),f=c.size/(1024*1024);w({compressedFile:c,originalSizeInMB:R,compressedSizeInMB:f,compressionRatio:R/f})},"video/mp4",x.quality)},l.onerror=()=>{C(new Error("Failed to load video"))},l.src=URL.createObjectURL(p),l.load()})}function it(p,x,w,C){let{width:l,height:m}={width:p,height:x};return l>w&&(m=m*w/l,l=w),m>C&&(l=l*C/m,m=C),{width:l,height:m}}function st({open:p,onClose:x,onCapture:w,title:C="Nat√≠vna kamera",maxPhotos:l=50,currentPhotoCount:m=0}){const j=d.useRef(null),B=d.useRef(null),v=d.useRef(null),[s,c]=d.useState({stream:null,isInitializing:!1,error:null,facingMode:"environment",flashSupported:!1,flashEnabled:!1}),[R,f]=d.useState(!1),[u,N]=d.useState(0),$=d.useCallback(async(n="environment")=>{if(c(o=>({...o,isInitializing:!0,error:null})),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){const o="MediaDevices API nie je podporovan√© v tomto prehliadaƒçi.";console.error("‚ùå",o),c(k=>({...k,isInitializing:!1,error:o,stream:null}));return}try{v.current&&(h.debug("üõë Stopping existing stream..."),v.current.getTracks().forEach(g=>g.stop()),v.current=null);const o={video:{facingMode:n,width:{ideal:1920,max:3840},height:{ideal:1080,max:2160}},audio:!1};h.debug("üì± Requesting camera with constraints:",o);const k=setTimeout(()=>{console.error("‚è∞ Camera initialization timeout"),c(g=>({...g,isInitializing:!1,error:"ƒåasov√Ω limit pre spustenie kamery vypr≈°al. Sk√∫ste to znovu.",stream:null}))},5e3);try{const g=await navigator.mediaDevices.getUserMedia(o);clearTimeout(k),h.debug("‚úÖ Stream z√≠skan√Ω:",g),h.debug("üìπ Video tracks:",g.getVideoTracks());let U=0;const P=10,I=()=>{if(j.current)h.debug("‚úÖ Video ref found, setting up stream"),j.current.srcObject=g,j.current.onloadedmetadata=()=>{h.debug("‚úÖ Video metadata loaded"),j.current&&j.current.play().catch(T=>{console.error("‚ùå Video play error:",T)})};else if(console.warn(`‚ö†Ô∏è Video ref is null, retry ${U+1}/${P}`),U++,U<P)setTimeout(I,100);else{console.error("‚ùå Video ref never became available"),c(T=>({...T,error:"Nepodarilo sa pripoji≈• video element. Sk√∫ste obnovi≈• str√°nku.",isInitializing:!1}));return}};I();const Z=g.getVideoTracks()[0].getCapabilities?.(),Y=Z&&Z.torch===!0;h.debug("üî¶ Flash supported:",Y),c(T=>({...T,stream:g,isInitializing:!1,facingMode:n,flashSupported:Y,error:null})),v.current=g}catch(g){throw clearTimeout(k),g}}catch(o){console.error("‚ùå Chyba pri inicializ√°cii kamery:",o);let k="Nepodarilo sa spusti≈• kameru";o instanceof Error&&(console.error("Error name:",o.name),console.error("Error message:",o.message),o.name==="NotAllowedError"?k=`Pr√≠stup ku kamere bol zamietnut√Ω.

Povoƒæte pr√≠stup ku kamere:
1. Kliknite na ikonu üîí v adresnom riadku
2. Povoƒæte kameru pre t√∫to str√°nku
3. Obnovte str√°nku`:o.name==="NotFoundError"?k=`Kamera nebola n√°jden√° na tomto zariaden√≠.

Skontrolujte ƒçi:
‚Ä¢ M√°te kameru pripojenu
‚Ä¢ Kamera nie je pou≈æ√≠van√° inou aplik√°ciou`:o.name==="NotSupportedError"?k=`Kamera nie je podporovan√° v tomto prehliadaƒçi.

Sk√∫ste:
‚Ä¢ Chrome, Safari alebo Firefox
‚Ä¢ HTTPS pripojenie`:o.name==="OverconstrainedError"&&(k=`Po≈æadovan√© nastavenia kamery nie s√∫ podporovan√©.

Sk√∫ste re≈°tartova≈• kameru.`)),c(g=>({...g,isInitializing:!1,error:k,stream:null}))}},[]);d.useEffect(()=>(p?(N(0),$()):v.current&&(v.current.getTracks().forEach(n=>{h.debug("üõë Stopping track:",n.kind),n.stop()}),v.current=null,c(n=>({...n,stream:null}))),()=>{v.current&&(v.current.getTracks().forEach(n=>n.stop()),v.current=null)}),[p,$]);const y=async()=>{const n=s.facingMode==="environment"?"user":"environment";await $(n)},A=async()=>{if(!(!v.current||!s.flashSupported))try{await v.current.getVideoTracks()[0].applyConstraints({advanced:[{torch:!s.flashEnabled}]}),c(o=>({...o,flashEnabled:!o.flashEnabled}))}catch(n){console.error("Chyba pri prep√≠nan√≠ flash:",n)}},W=d.useCallback(async()=>{if(!(!j.current||!B.current||R)){if(m+u>=l){alert(`M√¥≈æete prida≈• maxim√°lne ${l} fotiek.`);return}f(!0);try{const n=j.current,o=B.current,k=o.getContext("2d");if(!k)throw new Error("Canvas context nie je dostupn√Ω");o.width=n.videoWidth,o.height=n.videoHeight,k.drawImage(n,0,0,o.width,o.height);const g=()=>{o.toBlob(P=>{P?(h.debug("‚úÖ WebP capture successful, size:",(P.size/1024).toFixed(1)+"KB"),w(P),N(I=>I+1),setTimeout(()=>f(!1),200)):(console.warn("‚ö†Ô∏è WebP failed, trying JPEG fallback"),U())},"image/webp",.85)},U=()=>{o.toBlob(P=>{P?(h.debug("‚úÖ JPEG capture successful, size:",(P.size/1024).toFixed(1)+"KB"),w(P),N(I=>I+1),setTimeout(()=>f(!1),200)):(f(!1),console.error("‚ùå Both WebP and JPEG capture failed"))},"image/jpeg",.95)};g()}catch(n){console.error("Chyba pri zachyt√°van√≠ fotky:",n),f(!1),alert("Chyba pri zachyt√°van√≠ fotky: "+(n instanceof Error?n.message:"Nezn√°ma chyba"))}}},[R,m,u,l,w]);return d.useEffect(()=>{const n=o=>{p&&(o.code==="Space"||o.code==="Enter"?(o.preventDefault(),W()):o.code==="Escape"&&x())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[p,W,x]),p?e.jsxs(me,{open:p,onClose:x,maxWidth:"md",fullWidth:!0,fullScreen:!0,PaperProps:{sx:{bgcolor:"black",color:"white",height:"100vh",margin:0}},children:[e.jsxs(ue,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",bgcolor:"rgba(0,0,0,0.8)",color:"white",py:1,position:"relative",zIndex:10},children:[e.jsx(F,{variant:"h6",sx:{color:"white"},children:C}),e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(J,{label:`${m+u}/${l}`,size:"small",color:"primary",sx:{color:"white",borderColor:"white"},variant:"outlined"}),e.jsx(X,{onClick:x,sx:{color:"white",bgcolor:"rgba(255,255,255,0.1)","&:hover":{bgcolor:"rgba(255,255,255,0.2)"},ml:1},children:e.jsx(Ie,{})})]})]}),e.jsx(ge,{sx:{p:0,bgcolor:"black",position:"relative",flex:1},children:s.error?e.jsxs(S,{sx:{p:3},children:[e.jsx(Me,{severity:"error",sx:{mb:2},children:s.error}),e.jsx(ce,{variant:"contained",onClick:()=>$(),children:"Sk√∫si≈• znovu"})]}):s.isInitializing?e.jsxs(S,{sx:{p:3,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",minHeight:"300px"},children:[e.jsx(F,{variant:"body1",sx:{color:"white",mb:2,textAlign:"center"},children:"Sp√∫≈°≈•am kameru..."}),e.jsx(Be,{sx:{width:"100%",maxWidth:"300px"}}),e.jsx(F,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)",mt:2,textAlign:"center"},children:"Povoƒæte pr√≠stup ku kamere v prehliadaƒçi"})]}):e.jsx(e.Fragment,{children:e.jsxs(S,{sx:{position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",minHeight:"400px"},children:[e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,onCanPlay:()=>h.debug("‚úÖ Video can play"),onError:n=>console.error("‚ùå Video error:",n),style:{width:"100%",height:"100%",objectFit:"cover"}}),e.jsx("canvas",{ref:B,style:{display:"none"}}),s.stream&&e.jsxs(S,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",alignItems:"center",gap:3,bgcolor:"rgba(0,0,0,0.6)",borderRadius:6,p:2},children:[s.flashSupported&&e.jsx(X,{onClick:A,sx:{color:s.flashEnabled?"yellow":"white",bgcolor:s.flashEnabled?"rgba(255,255,0,0.2)":"transparent"},children:s.flashEnabled?e.jsx(Ze,{}):e.jsx(Ye,{})}),e.jsx(X,{onClick:W,disabled:R,sx:{bgcolor:R?"green":"white",color:R?"white":"black",width:70,height:70,"&:hover":{bgcolor:R?"green":"rgba(255,255,255,0.8)"},border:"3px solid white"},children:R?e.jsx(de,{}):e.jsx(fe,{sx:{fontSize:30}})}),e.jsx(X,{onClick:y,sx:{color:"white"},children:e.jsx(et,{})})]}),s.stream&&u===0&&e.jsx(S,{sx:{position:"absolute",top:20,left:"50%",transform:"translateX(-50%)",bgcolor:"rgba(0,0,0,0.7)",color:"white",px:2,py:1,borderRadius:2,textAlign:"center"},children:e.jsx(F,{variant:"body2",children:"Kliknite na üì∏ alebo stlaƒçte medzern√≠k na odfotenie"})}),u>0&&e.jsxs(S,{sx:{position:"absolute",top:20,right:20,bgcolor:"rgba(76, 175, 80, 0.9)",color:"white",px:2,py:1,borderRadius:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(de,{sx:{fontSize:20}}),e.jsxs(F,{variant:"body2",children:[u," fotiek zachyten√Ωch"]})]}),u>0&&e.jsx(S,{sx:{position:"absolute",top:80,right:20,zIndex:1e3},children:e.jsxs(ce,{onClick:x,variant:"contained",size:"large",startIcon:e.jsx(de,{}),sx:{bgcolor:"#4CAF50",color:"white",fontWeight:"bold",fontSize:"16px",px:3,py:1.5,borderRadius:3,boxShadow:"0 4px 12px rgba(76, 175, 80, 0.4)","&:hover":{bgcolor:"#45a049",boxShadow:"0 6px 16px rgba(76, 175, 80, 0.6)"},"&:active":{transform:"scale(0.98)"},transition:"all 0.2s ease",minWidth:"160px"},children:["Ulo≈æi≈• fotky (",u,")"]})})]})})}),e.jsx(xe,{sx:{bgcolor:"rgba(0,0,0,0.8)",color:"white",justifyContent:"center",py:1,display:u>0?"flex":"none"},children:e.jsxs(ce,{onClick:x,sx:{color:"rgba(255,255,255,0.7)",fontSize:"14px"},children:["‚úì Dokonƒçi≈• (",u," fotiek)"]})})]}):null}function ct({open:p,onClose:x,onSave:w,title:C,allowedTypes:l,maxImages:m=50,maxVideos:j=5,compressImages:B=!0,compressVideos:v=!0,entityId:s,autoUploadToR2:c=!0,protocolType:R="handover",mediaType:f="vehicle",category:u,qualityPreset:N="protocol",preferWebP:$=!0}){const[y,A]=d.useState([]),[W,n]=d.useState(!1),[o,k]=d.useState(0),[g,U]=d.useState(null),[P,I]=d.useState(!1),[oe,Z]=d.useState(0),[Y,T]=d.useState(!1),[be,Le]=d.useState(N),[q,De]=d.useState($),[ee,Ue]=d.useState(null),ne=d.useRef(null),ve=d.useRef(null);d.useEffect(()=>{We().then(Ue)},[]),d.useEffect(()=>{const t=r=>{p&&((r.metaKey||r.ctrlKey)&&r.key==="k"&&(r.preventDefault(),ne.current?.click()),(r.metaKey||r.ctrlKey)&&r.key==="r"&&(r.preventDefault(),T(!0)),r.code==="Space"&&!Y&&(r.preventDefault(),T(!0)))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[p,Y]);const ye=d.useCallback(async t=>{const r=new FormData;r.append("file",t),r.append("protocolId",s),r.append("protocolType",R),r.append("mediaType",f),r.append("label",t.name);const a=ze(),i=await fetch(`${a}/files/protocol-photo`,{method:"POST",body:r});if(!i.ok){const E=await i.text();throw new Error(`Upload failed: ${i.status} - ${E}`)}return(await i.json()).url},[s,R,f]),ae=d.useCallback(async(t,r)=>{if(!c)return new Promise(a=>{const i=new FileReader;i.onload=()=>a(i.result),i.readAsDataURL(t)});if(!s)throw new Error("EntityId is required for R2 upload");try{const a=ze();h.debug("üîÑ Uploading file via backend proxy:",{entityId:s,filename:t.name,size:t.size,contentType:t.type});const i=new FormData;i.append("file",t),i.append("type","protocol"),i.append("entityId",s),i.append("mediaType",f||"vehicle"),u&&i.append("category",u);const z=await fetch(`${a}/files/upload`,{method:"POST",headers:{...localStorage.getItem("blackrent_token")&&{Authorization:`Bearer ${localStorage.getItem("blackrent_token")}`}},body:i});if(!z.ok){const b=await z.json().catch(()=>({}));throw new Error(`Upload failed: ${z.status} - ${JSON.stringify(b)}`)}const E=await z.json();return h.debug("‚úÖ File uploaded via backend proxy:",E),h.debug("‚úÖ Photo uploaded to R2, metadata will be saved with protocol"),E.url}catch(a){return console.error("‚ùå Signed URL upload failed:",a),await ye(t)}},[c,u,ye,s,f,R]),je=d.useCallback(async t=>{const r=Array.from(t.target.files||[]);if(r.length===0)return;const a=y.filter(b=>b.type==="image").length,i=y.filter(b=>b.type==="video").length,z=r.filter(b=>!b.type.startsWith("video/")).length,E=r.filter(b=>b.type.startsWith("video/")).length;if(a+z>m){alert(`M√¥≈æete nahra≈• maxim√°lne ${m} obr√°zkov. Aktu√°lne m√°te ${a} a pok√∫≈°ate sa prida≈• ${z}.`);return}if(i+E>j){alert(`M√¥≈æete nahra≈• maxim√°lne ${j} vide√≠. Aktu√°lne m√°te ${i} a pok√∫≈°ate sa prida≈• ${E}.`);return}n(!0),k(0);try{const b=[];let L=0;for(const M of r){const Q=M.type.startsWith("video/"),ke=l[0];let K=M,O=!1,H=M.size,D=M.size;if(Q&&v){k(L/r.length*50);const V=await at(M);K=V.compressedFile,O=!0,D=V.compressedFile.size}else if(!Q&&B){k(L/r.length*50);const V=await rt(M,q,be);K=new File([V.compressedBlob],M.name,{type:M.type,lastModified:Date.now()}),O=!0,D=V.compressedSize}h.debug("üîç R2 UPLOAD CHECK:",{autoUploadToR2:c,entityId:s,hasEntityId:!!s,willUseR2:c&&s,filename:K.name});let G;if(c&&s){h.debug("‚úÖ STARTING R2 UPLOAD:",K.name),I(!0),Z(L/r.length*100);try{G=await ae(K,Q?"video":"image"),h.debug("‚úÖ R2 UPLOAD SUCCESS:",G)}catch(V){console.error("‚ùå R2 UPLOAD FAILED, falling back to base64:",V),G=await new Promise(te=>{const le=new FileReader;le.onload=()=>te(le.result),le.readAsDataURL(K)})}I(!1)}else h.debug("‚ö†Ô∏è USING BASE64 FALLBACK - R2 conditions not met"),G=await new Promise(V=>{const te=new FileReader;te.onload=()=>V(te.result),te.readAsDataURL(K)});const Ne={id:Se(),file:K,type:Q?"video":"image",mediaType:ke,description:"",preview:G,timestamp:new Date,compressed:O,originalSize:H,compressedSize:D,compressionRatio:H>0?(H-D)/H*100:0};b.push(Ne),L++,k(L/r.length*100)}A(M=>[...M,...b]),h.debug(`‚úÖ Pridan√© ${b.length} m√©di√≠ s ${c?"R2 upload":"base64"}`)}catch(b){console.error("‚ùå Chyba pri spracovan√≠ s√∫borov:",b),alert("Chyba pri spracovan√≠ s√∫borov: "+(b instanceof Error?b.message:"Nezn√°ma chyba"))}finally{n(!1),k(0),I(!1),Z(0),t.target&&(t.target.value="")}},[y,m,j,l,B,v,c,s,ae]),Te=d.useCallback(async t=>{const r=new File([t],`photo_${Date.now()}.jpg`,{type:"image/jpeg"});let a=URL.createObjectURL(t);if(h.debug("üì∏ Native camera capture - R2 upload check:",{autoUploadToR2:c,entityId:s,hasEntityId:!!s,willUploadToR2:c&&s,filename:r.name,size:r.size}),c&&s){h.debug("üöÄ NATIVE CAMERA: Starting R2 upload for:",r.name),I(!0);try{const z=await ae(r,"image");h.debug("‚úÖ NATIVE CAMERA: R2 upload success:",z),URL.revokeObjectURL(a),a=z}catch(z){console.error("‚ùå NATIVE CAMERA: R2 upload failed, using blob URL:",z)}I(!1)}const i={id:Se(),file:r,type:"image",mediaType:l[0],description:"",preview:a,timestamp:new Date,compressed:!1,originalSize:t.size,compressedSize:t.size,compressionRatio:0};A(z=>[...z,i])},[l,c,s,ae]),He=(t,r)=>{A(a=>a.map(i=>i.id===t?{...i,mediaType:r}:i))},$e=(t,r)=>{A(a=>a.map(i=>i.id===t?{...i,description:r}:i))},Ke=t=>{A(r=>{const a=r.find(i=>i.id===t);return a&&URL.revokeObjectURL(a.preview),r.filter(i=>i.id!==t)})},Oe=async()=>{const t=[],r=[];for(const a of y){let i=a.preview;if(!(i.startsWith("https://")&&(i.includes("r2.dev")||i.includes("cloudflare.com")))){h.debug("‚ö†Ô∏è Converting to base64 for PDF - compressing:",a.file.name);let z=a.file;if(a.type==="image"&&a.file.size>1e5){h.debug(`üóúÔ∏è Komprimujem veƒæk√Ω obr√°zok: ${(a.file.size/1024).toFixed(1)}KB`);try{const E=document.createElement("canvas"),b=E.getContext("2d"),L=new Image;z=await new Promise((M,Q)=>{L.onload=()=>{let{width:O,height:H}=L;if(O>800||H>600){const D=Math.min(800/O,600/H);O*=D,H*=D}E.width=O,E.height=H,b?.drawImage(L,0,0,O,H),E.toBlob(D=>{if(D){const G=new File([D],a.file.name,{type:"image/jpeg",lastModified:Date.now()});h.debug(`‚úÖ Komprimovan√©: ${(D.size/1024).toFixed(1)}KB`),M(G)}else Q(new Error("Canvas toBlob failed"))},"image/jpeg",.7)},L.onerror=Q,L.src=URL.createObjectURL(a.file)})}catch(E){console.error("‚ö†Ô∏è Compression failed, using original:",E)}}i=await new Promise(E=>{const b=new FileReader;b.onload=()=>E(b.result),b.readAsDataURL(z)})}a.type==="image"?t.push({id:a.id,url:i,type:a.mediaType,description:a.description,timestamp:a.timestamp,compressed:a.compressed,originalSize:a.originalSize,compressedSize:a.compressedSize}):r.push({id:a.id,url:i,type:a.mediaType,description:a.description,timestamp:a.timestamp,compressed:a.compressed,originalSize:a.originalSize,compressedSize:a.compressedSize})}h.debug(`‚úÖ Uklad√°m ${t.length} obr√°zkov a ${r.length} vide√≠`),w(t,r),ie()},ie=()=>{y.forEach(t=>{URL.revokeObjectURL(t.preview)}),A([]),U(null),x()},se=y.reduce((t,r)=>t+r.file.size,0),Ve=y.reduce((t,r)=>t+(r.compressedSize||r.file.size),0),we=se>0?(se-Ve)/se*100:0;return e.jsxs(e.Fragment,{children:[e.jsxs(me,{open:p,onClose:ie,maxWidth:"lg",fullWidth:!0,children:[e.jsxs(ue,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(F,{variant:"h6",color:"text.primary",children:C}),e.jsx(X,{onClick:ie,color:"inherit",children:e.jsx(Ie,{})})]}),e.jsxs(ge,{children:[e.jsxs(S,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(pe,{startIcon:e.jsx(fe,{}),onClick:()=>ne.current?.click(),disabled:W,sx:{fontSize:"1.1rem",py:1.5,px:3,"&:hover":{transform:"scale(1.02)",transition:"transform 0.1s"}},children:"üì∏ Kvalitn√© fotky"}),e.jsx(pe,{startIcon:e.jsx(Pe,{}),onClick:()=>ve.current?.click(),disabled:W,children:"Prida≈• video"}),e.jsx(he,{startIcon:e.jsx(fe,{}),onClick:()=>T(!0),disabled:W,sx:{borderColor:"orange.main",color:"orange.main","&:hover":{borderColor:"orange.dark",backgroundColor:"orange.50"}},children:"‚ö° R√Ωchle fotky"}),e.jsxs(Ce,{size:"small",sx:{minWidth:140},children:[e.jsx(Re,{children:"Kvalita"}),e.jsxs(Ee,{value:be,onChange:t=>Le(t.target.value),label:"Kvalita",children:[e.jsxs(re,{value:"mobile",children:["üì± Mobiln√° (",q?"500KB":"800KB",")"]}),e.jsxs(re,{value:"protocol",children:["üè¢ Protokol (",q?"1MB":"1.5MB",")"]}),e.jsxs(re,{value:"highQuality",children:["üîç Vysok√° (",q?"2MB":"3MB",")"]}),e.jsxs(re,{value:"archive",children:["üíæ Arch√≠v (",q?"3.5MB":"5MB",")"]})]})]}),ee!==null&&e.jsx(qe,{control:e.jsx(_e,{checked:q&&ee,onChange:t=>De(t.target.checked),disabled:!ee,color:"primary"}),label:e.jsxs(S,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(F,{variant:"body2",children:["WebP ",ee?"‚úÖ":"‚ùå"]}),q&&ee&&e.jsx(J,{label:"30% MEN≈†IE",size:"small",color:"success",variant:"filled"})]}),sx:{ml:1}})]}),e.jsxs(Me,{severity:"info",sx:{mb:2,bgcolor:"blue.50"},children:[e.jsx(F,{variant:"body2",sx:{mb:1},children:e.jsx("strong",{children:"‚ö° R√Ωchle fotenie:"})}),e.jsxs(S,{component:"ul",sx:{m:0,pl:2},children:[e.jsxs("li",{children:[e.jsx("kbd",{children:"Space"})," alebo ",e.jsx("kbd",{children:"‚åòR"})," = R√Ωchle fotky cez prehliadaƒç"]}),e.jsxs("li",{children:[e.jsx("kbd",{children:"‚åòK"})," = Kvalitn√© fotky z gal√©rie/fotoapar√°tu"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Tip:"})," Pre ≈°kody pou≈æi≈• kvalitn√©, pre celkov√© z√°bery r√Ωchle"]})]})]}),e.jsx("input",{ref:ne,type:"file",accept:"image/*",multiple:!0,style:{display:"none"},onChange:je}),e.jsx("input",{ref:ve,type:"file",accept:"video/*",multiple:!0,style:{display:"none"},onChange:je}),(W||P)&&e.jsxs(S,{sx:{mb:2},children:[e.jsx(F,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:P?"Uploadujem na R2...":"Spracov√°vam s√∫bory..."}),e.jsx(Be,{variant:"determinate",value:P?oe:o,sx:{height:8,borderRadius:4}}),e.jsxs(F,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:[P?oe.toFixed(0):o.toFixed(0),"%"]})]}),e.jsxs(S,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(F,{variant:"body2",color:"text.secondary",children:["Limity: ",m," fotiek, ",j," vide√≠"]}),y.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(J,{label:`${y.filter(t=>t.type==="image").length}/${m} fotiek`,size:"small",color:y.filter(t=>t.type==="image").length>=m?"error":"default"}),e.jsx(J,{label:`${y.filter(t=>t.type==="video").length}/${j} vide√≠`,size:"small",color:y.filter(t=>t.type==="video").length>=j?"error":"default"}),e.jsx(J,{label:`${(se/1024/1024).toFixed(1)} MB`,size:"small"}),we>0&&e.jsx(J,{label:`${we.toFixed(1)}% komprimovan√©`,size:"small",color:"success"})]})]}),e.jsx(S,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:2},children:y.map(t=>e.jsxs(Qe,{children:[e.jsxs(S,{sx:{position:"relative",mb:2},children:[t.type==="image"?e.jsx("img",{src:t.preview,alt:t.description,style:{width:"100%",height:150,objectFit:"cover"}}):e.jsx(S,{sx:{width:"100%",height:150,backgroundImage:`url(${t.preview})`,backgroundSize:"cover",backgroundPosition:"center",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Pe,{sx:{fontSize:40,color:"text.primary"}})}),e.jsxs(S,{sx:{position:"absolute",top:5,right:5,display:"flex",gap:1},children:[e.jsx(X,{size:"small",onClick:()=>U(t),sx:{backgroundColor:"rgba(0,0,0,0.5)",color:"text.primary"},children:e.jsx(tt,{})}),e.jsx(X,{size:"small",onClick:()=>Ke(t.id),sx:{backgroundColor:"rgba(255,0,0,0.5)",color:"text.primary"},children:e.jsx(Ge,{})})]}),t.compressed&&e.jsx(J,{label:"Komprimovan√©",size:"small",color:"success",sx:{position:"absolute",bottom:5,left:5}})]}),e.jsxs(Ce,{fullWidth:!0,size:"small",sx:{mb:2},children:[e.jsx(Re,{children:"Typ"}),e.jsx(Ee,{value:t.mediaType,label:"Typ",onChange:r=>He(t.id,r.target.value),children:l.map(r=>e.jsxs(re,{value:r,children:[r==="vehicle"&&"Vozidlo",r==="damage"&&"Po≈°kodenie",r==="document"&&"Doklady",r==="fuel"&&"Palivo",r==="odometer"&&"Tachometer"]},r))})]}),e.jsx(Je,{fullWidth:!0,size:"small",label:"Popis",value:t.description,onChange:r=>$e(t.id,r.target.value),multiline:!0,rows:2}),e.jsx(F,{variant:"caption",sx:{color:"text.secondary",mt:1,display:"block"},children:t.compressed?e.jsxs(e.Fragment,{children:[(t.compressedSize/1024/1024).toFixed(2)," MB",e.jsxs("span",{style:{color:"success.main"},children:["(",t.compressionRatio.toFixed(1),"% komprimovan√©)"]})]}):`${(t.file.size/1024/1024).toFixed(2)} MB`})]},t.id))})]}),e.jsxs(xe,{children:[e.jsx(he,{onClick:ie,children:"Zru≈°i≈•"}),e.jsxs(pe,{onClick:Oe,startIcon:e.jsx(Xe,{}),disabled:y.length===0||W,loading:W,loadingText:"Uklad√°m...",children:["Ulo≈æi≈• (",y.length,")"]})]})]}),e.jsxs(me,{open:!!g,onClose:()=>U(null),maxWidth:"md",fullWidth:!0,children:[e.jsx(ue,{children:"N√°hƒæad"}),e.jsx(ge,{children:g&&e.jsxs(S,{sx:{textAlign:"center"},children:[g.type==="image"?e.jsx("img",{src:g.preview,alt:g.description,style:{maxWidth:"100%",maxHeight:"70vh"}}):e.jsx("video",{src:g.preview,controls:!0,style:{maxWidth:"100%",maxHeight:"70vh"}}),e.jsx(F,{variant:"body2",color:"text.primary",sx:{mt:2},children:g.description||"Bez popisu"})]})}),e.jsx(xe,{children:e.jsx(he,{onClick:()=>U(null),children:"Zatvori≈•"})})]}),e.jsx(st,{open:Y,onClose:()=>T(!1),onCapture:Te,title:"üì∏ Rapid fotografovanie",maxPhotos:m,currentPhotoCount:y.filter(t=>t.type==="image").length})]})}export{fe as P,lt as S,ct as a};
