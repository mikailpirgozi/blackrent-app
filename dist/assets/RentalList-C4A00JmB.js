const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HandoverProtocolForm-CShMIDxU.js","assets/index-DfP_Aygt.js","assets/index-3GiN0UBQ.css","assets/SerialPhotoCapture-B-y8j5_v.js","assets/Switch-Bee8sYsg.js","assets/Receipt-CvIXthAy.js","assets/Grid-Bdewy4dZ.js","assets/LocationOn-CxZw4K62.js"])))=>i.map(i=>d[i]);
import{af as to,ag as oo,ah as ho,c as Oe,j as e,a as n,ai as be,Z as We,C as he,$ as je,B as i,q as $,I as le,t as q,aj as ao,T as x,o as G,a0 as Xe,p as ro,M as De,N as Ne,O as Ae,P as de,ae as ze,ak as It,U as so,al as po,a8 as yt,a9 as Ft,am as _t,G as no,a3 as At,E as io,an as qe,ao as Ze,w as Ye,Q as et,a7 as Te,a6 as Mt,ap as xo,a1 as fo,a2 as go,aq as tt,ad as jt,H as Ue,J as He,K as Be,R as vo,v as ht,ar as H,as as bo,at as Kt,au as Ut,av as yo,aw as jo,ax as ko,A as Co,a4 as lo,ay as St,az as gt,aA as wo,x as vt,aB as So,aC as Dt,aD as Do}from"./index-DfP_Aygt.js";import{C as Po}from"./PermissionGuard-CNQGriEX.js";import{S as Rt}from"./Search-wmGxveR5.js";import{F as Vt}from"./FilterList-FhaE75z2.js";import{G as pe}from"./Grid-Bdewy4dZ.js";import{C as zo}from"./Business-CW2_TAXE.js";import{P as Io}from"./Phone-DBNvbodD.js";import{E as Ro}from"./Euro-BjdjzfLF.js";import{C as Nt}from"./Check-eRMTb7fG.js";import{A as No,r as Ge}from"./createSvgIcon-CNgCHA2Q.js";import{A as $t}from"./Autocomplete-BMd06Jll.js";import{D as Pt}from"./DateTimePicker-CvA7up00.js";import{P as Tt}from"./PictureAsPdf-C2FGlWfp.js";import{D as co}from"./Download-DePllfWr.js";import{G as Ao}from"./PlayArrow-BrNvuBNx.js";import{S as Mo,P as bt,a as To}from"./SerialPhotoCapture-B-y8j5_v.js";import{L as Eo}from"./LocationOn-CxZw4K62.js";import{U as Lo}from"./Cancel-T9g0rbRj.js";import{F as Wo,P as Oo}from"./papaparse.min-GJxd3uti.js";import"./useMobilePicker-DkEmgJbi.js";import"./Tabs-BoloKirS.js";import"./Switch-Bee8sYsg.js";function st(r){return to(1,arguments),oo(r,Date.now())}function Fo(r){return to(1,arguments),oo(r,ho(Date.now(),1))}const _o=Oe(e.jsx("path",{d:"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m4 12h-4v3l-5-5 5-5v3h4z"}),"AssignmentReturn"),Ko=Oe(e.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-5.97 4.06L14.09 6l1.41 1.41L16.91 6l1.06 1.06-1.41 1.41 1.41 1.41-1.06 1.06-1.41-1.4-1.41 1.41-1.06-1.06 1.41-1.41zm-6.78.66h5v1.5h-5zM11.5 16h-2v2H8v-2H6v-1.5h2v-2h1.5v2h2zm6.5 1.25h-5v-1.5h5zm0-2.5h-5v-1.5h5z"}),"Calculate"),Uo=Oe(e.jsx("path",{d:"M19 9h-4V3H9v6H5l7 7zM5 18v2h14v-2z"}),"FileDownload"),Vo=Oe(e.jsx("path",{d:"M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"}),"FileUpload"),$o=Oe(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore"),Ho=Oe(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext"),Bo=Oe(e.jsx("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3z"}),"OpenInNew"),Et=Oe(e.jsx("path",{d:"M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2m-11-4 2.03 2.71L16 11l4 5H8zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6z"}),"PhotoLibrary"),Ht=Oe([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")],"ZoomIn");function qo(r){return r?r.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim():""}const Zo=50;function Yo(r={}){const[P,m]=n.useState([]),[z,f]=n.useState(!1),[c,k]=n.useState(null),[I,M]=n.useState(!0),[t,C]=n.useState(0),[R,T]=n.useState(1),[j,L]=n.useState(r),[l,A]=n.useState(!0),[u,b]=n.useState(""),N=n.useRef(!1),h=n.useRef(j);h.current=j;const s=n.useCallback(async(D,O=!1)=>{if(!N.current){N.current=!0,f(!0),k(null);try{be.info(`🔄 Loading rentals - Page ${D}`,{filters:h.current});const Q=u?qo(u):"",V=await We.getRentalsPaginated({page:D,limit:Zo,search:Q,...h.current}),ce=V.rentals;if(!V||!Array.isArray(ce))throw new Error("Invalid response format");m(w=>{const J=O?ce:[...w,...ce];return Array.from(new Map(J.map(X=>[X.id,X])).values())}),C(V.pagination.totalItems),M(V.pagination.hasMore),T(V.pagination.currentPage),be.info(`✅ Loaded ${ce.length} rentals (${V.pagination.totalItems} total)`)}catch(Q){const V=Q.message||"Chyba pri načítavaní prenájmov";k(V),be.error("❌ Failed to load rentals",Q)}finally{f(!1),N.current=!1,l&&A(!1)}}},[l,u]),o=n.useCallback(()=>{!z&&I&&s(R+1,!1)},[z,I,R,s]),p=n.useCallback(()=>{m([]),T(1),M(!0),k(null),s(1,!0)},[s]),d=n.useCallback(D=>{be.info("🔍 Updating filters",{newFilters:D}),L(D),m([]),T(1),M(!0),k(null)},[]),S=n.useCallback(D=>{m(O=>{const Q=O.findIndex(V=>V.id===D.id);if(Q!==-1){const V=[...O];return V[Q]=D,be.debug("⚡ Rental updated in paginated list:",D.id),V}return O})},[]),_=n.useCallback(async D=>{try{be.info("🎯 Smart update: Loading specific rental:",D);const O=await We.getRental(D);O?(S(O),be.info("✅ Smart update: Rental successfully updated in list")):(be.warn("⚠️ Smart update: Rental not found, falling back to full refresh"),p())}catch(O){be.error("❌ Smart update failed, falling back to full refresh:",O),p()}},[S,p]),U=n.useCallback(D=>{be.info("🗑️ Optimistic delete: Removing rental from list:",D),m(O=>{const Q=O.filter(V=>V.id!==D);return be.info(`✅ Optimistic delete: Rental removed (${O.length} → ${Q.length})`),Q}),C(O=>Math.max(0,O-1))},[]);return n.useEffect(()=>{l&&(A(!1),s(1,!0))},[]),n.useEffect(()=>{if(!l){const D=setTimeout(()=>{s(1,!0)},300);return()=>clearTimeout(D)}},[j]),n.useEffect(()=>{if(!l){T(1),m([]),M(!0);const D=setTimeout(()=>{s(1,!0)},300);return()=>clearTimeout(D)}},[u]),n.useEffect(()=>{const D=Q=>{const V=Q?.detail;V?.rentalId?(be.info("🎯 Smart refresh for specific rental:",V.rentalId),_(V.rentalId)):(be.info("🔄 Full rental list refresh triggered"),p())},O=Q=>{const{rental:V,action:ce}=Q.detail;ce==="update"||ce==="rollback"?(be.info("⚡ Optimistic update received for rental:",V.id),S(V)):ce==="create"?(be.info("⚡ Optimistic create received for rental:",V.id),m(w=>[V,...w])):ce==="delete"&&(be.info("⚡ Optimistic delete received for rental:",V.id),m(w=>w.filter(J=>J.id!==V.id)))};return window.addEventListener("rental-list-refresh",D),window.addEventListener("rental-optimistic-update",O),()=>{window.removeEventListener("rental-list-refresh",D),window.removeEventListener("rental-optimistic-update",O)}},[p,S]),n.useEffect(()=>{be.debug("📊 Infinite rentals state",{rentalsCount:P.length,totalCount:t,currentPage:R,hasMore:I,loading:z,error:c})},[P.length,t,R,I,z,c]),{rentals:P,loading:z,error:c,hasMore:I,totalCount:t,currentPage:R,searchTerm:u,setSearchTerm:b,loadMore:o,refresh:p,updateFilters:d,updateRentalInList:S,handleOptimisticDelete:U}}const Go=({searchQuery:r,setSearchQuery:P,showFilters:m,setShowFilters:z,advancedFilters:f,handleAdvancedFiltersChange:c,toggleFilterValue:k,isFilterValueSelected:I,resetAllFilters:M,uniquePaymentMethods:t,uniqueCompanies:C,uniqueStatuses:R,uniqueVehicleBrands:T,filteredRentalsCount:j,totalRentalsCount:L})=>e.jsx(he,{sx:{mb:3,mx:{xs:1,md:0},backgroundColor:"background.paper",boxShadow:"0 4px 20px rgba(0,0,0,0.08)",border:"1px solid rgba(0,0,0,0.06)"},children:e.jsxs(je,{sx:{p:{xs:2,md:3}},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,alignItems:{xs:"stretch",md:"center"},mb:2},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",flex:{xs:"none",md:1},minWidth:{xs:"100%",md:250}},children:e.jsx($,{placeholder:"Hľadať prenájmy...",variant:"outlined",size:"small",value:r,onChange:l=>P(l.target.value),fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{borderRadius:3,backgroundColor:"background.default",transition:"all 0.3s ease","&:hover":{backgroundColor:"action.hover",transform:"translateY(-1px)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},"&.Mui-focused":{backgroundColor:"background.paper",transform:"translateY(-2px)",boxShadow:"0 6px 20px rgba(0,0,0,0.15)"}}},InputProps:{startAdornment:e.jsx(i,{sx:{mr:1,color:"text.secondary"},children:e.jsx(Rt,{fontSize:"small"})})}})}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"row",md:"row"},gap:1,flexWrap:"wrap",justifyContent:{xs:"space-between",md:"flex-start"}},children:[e.jsx(le,{onClick:()=>z(!m),size:"small",sx:{borderRadius:2,border:"1px solid",borderColor:m?"primary.main":"rgba(0,0,0,0.23)",bgcolor:m?"primary.main":"transparent",color:m?"white":"inherit",transition:"all 0.3s ease","&:hover":{bgcolor:m?"primary.dark":"rgba(0,0,0,0.04)",transform:"translateY(-1px)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"}},children:e.jsx(Vt,{fontSize:"small"})}),e.jsx(q,{variant:"outlined",startIcon:e.jsx(ao,{}),onClick:M,size:"small",sx:{borderRadius:2,textTransform:"none",fontWeight:500,transition:"all 0.3s ease",fontSize:{xs:"0.75rem",md:"0.875rem"},px:{xs:1,md:2},"&:hover":{bgcolor:"error.light",color:"white",borderColor:"error.main",transform:"translateY(-1px)",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"}},children:"Reset"})]})]}),(r||Array.isArray(f.status)&&f.status.length>0||Array.isArray(f.paymentMethod)&&f.paymentMethod.length>0||Array.isArray(f.company)&&f.company.length>0||f.dateFrom||f.dateTo||f.priceMin||f.priceMax||Array.isArray(f.protocolStatus)&&f.protocolStatus.length>0)&&e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{mb:2},children:["Zobrazených: ",j," z ",L," prenájmov"]}),e.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:2,alignItems:"center"},children:[e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{mr:1},children:["Rýchle filtre:",(()=>{const l=(Array.isArray(f.paymentMethod)?f.paymentMethod.length:0)+(Array.isArray(f.status)?f.status.length:0)+(Array.isArray(f.protocolStatus)?f.protocolStatus.length:0);return l>0?e.jsx(G,{label:l,size:"small",color:"primary",variant:"filled",sx:{ml:1,height:20,fontSize:"0.7rem",fontWeight:"bold"}}):null})()]}),t.slice(0,3).map(l=>{const A=u=>{switch(u){case"cash":return"Hotovosť";case"bank_transfer":return"Bankový prevod";case"direct_to_owner":return"Priamo majiteľovi";case"card":return"Kartou";case"crypto":return"Kryptomeny";default:return u}};return e.jsx(G,{label:A(l),size:"small",variant:I("paymentMethod",l)?"filled":"outlined",color:I("paymentMethod",l)?"primary":"default",onClick:()=>k("paymentMethod",l),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("paymentMethod",l)&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(25, 118, 210, 0.3)",border:"2px solid",borderColor:"primary.main"}}},l)}),e.jsx(Xe,{orientation:"vertical",flexItem:!0,sx:{mx:1}}),e.jsx(G,{label:"Aktívne",size:"small",variant:I("status","active")?"filled":"outlined",color:I("status","active")?"success":"default",onClick:()=>k("status","active"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("status","active")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(46, 125, 50, 0.3)",border:"2px solid",borderColor:"success.main"}}}),e.jsx(G,{label:"Čakajúci",size:"small",variant:I("status","pending")?"filled":"outlined",color:I("status","pending")?"warning":"default",onClick:()=>k("status","pending"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("status","pending")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(237, 108, 2, 0.3)",border:"2px solid",borderColor:"warning.main"}}}),e.jsx(G,{label:"Ukončené",size:"small",variant:I("status","completed")?"filled":"outlined",color:I("status","completed")?"info":"default",onClick:()=>k("status","completed"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("status","completed")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(2, 136, 209, 0.3)",border:"2px solid",borderColor:"info.main"}}}),e.jsx(Xe,{orientation:"vertical",flexItem:!0,sx:{mx:1}}),e.jsx(G,{label:"Zaplatené",size:"small",variant:I("paymentStatus","paid")?"filled":"outlined",color:I("paymentStatus","paid")?"success":"default",onClick:()=>k("paymentStatus","paid"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("paymentStatus","paid")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(46, 125, 50, 0.3)",border:"2px solid",borderColor:"success.main"}}}),e.jsx(G,{label:"Nezaplatené",size:"small",variant:I("paymentStatus","unpaid")?"filled":"outlined",color:I("paymentStatus","unpaid")?"error":"default",onClick:()=>k("paymentStatus","unpaid"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("paymentStatus","unpaid")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(211, 47, 47, 0.3)",border:"2px solid",borderColor:"error.main"}}}),e.jsx(Xe,{orientation:"vertical",flexItem:!0,sx:{mx:1}}),e.jsx(G,{label:"Bez protokolu",size:"small",variant:I("protocolStatus","none")?"filled":"outlined",color:I("protocolStatus","none")?"warning":"default",onClick:()=>k("protocolStatus","none"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("protocolStatus","none")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(237, 108, 2, 0.3)",border:"2px solid",borderColor:"warning.main"}}}),e.jsx(G,{label:"S protokolom",size:"small",variant:I("protocolStatus","with_handover")?"filled":"outlined",color:I("protocolStatus","with_handover")?"success":"default",onClick:()=>k("protocolStatus","with_handover"),sx:{borderRadius:2,"&:hover":{transform:"translateY(-1px)"},transition:"all 0.2s ease",...I("protocolStatus","with_handover")&&{fontWeight:"bold",boxShadow:"0 2px 8px rgba(46, 125, 50, 0.3)",border:"2px solid",borderColor:"success.main"}}})]}),e.jsxs(ro,{in:m,children:[e.jsx(Xe,{sx:{my:2}}),e.jsxs(i,{sx:{p:3},children:[e.jsxs(x,{variant:"h6",sx:{mb:3,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Vt,{fontSize:"small"}),"Filtre"]}),e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(De,{size:"small",fullWidth:!0,children:[e.jsx(Ne,{children:"Spôsob platby"}),e.jsx(Ae,{multiple:!0,value:Array.isArray(f.paymentMethod)?f.paymentMethod:[],onChange:l=>c({...f,paymentMethod:Array.isArray(l.target.value)?l.target.value:[l.target.value]}),label:"Spôsob platby",renderValue:l=>e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:l.map(A=>{const u=b=>{switch(b){case"cash":return"Hotovosť";case"bank_transfer":return"Bankový prevod";case"direct_to_owner":return"Priamo majiteľovi";case"card":return"Kartou";case"crypto":return"Kryptomeny";default:return b}};return e.jsx(G,{label:u(A),size:"small"},A)})}),children:t.map(l=>{const A=u=>{switch(u){case"cash":return"Hotovosť";case"bank_transfer":return"Bankový prevod";case"direct_to_owner":return"Priamo majiteľovi";case"card":return"Kartou";case"crypto":return"Kryptomeny";default:return u}};return e.jsx(de,{value:l,children:A(l)},l)})})]})}),e.jsx(pe,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(De,{size:"small",fullWidth:!0,children:[e.jsx(Ne,{children:"Firma"}),e.jsx(Ae,{multiple:!0,value:Array.isArray(f.company)?f.company:[],onChange:l=>c({...f,company:Array.isArray(l.target.value)?l.target.value:[l.target.value]}),label:"Firma",renderValue:l=>e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:l.map(A=>e.jsx(G,{label:A,size:"small"},A))}),children:C.map(l=>e.jsx(de,{value:l,children:l},l))})]})}),e.jsx(pe,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(De,{size:"small",fullWidth:!0,children:[e.jsx(Ne,{children:"Stav prenájmu"}),e.jsx(Ae,{multiple:!0,value:Array.isArray(f.status)?f.status:[],onChange:l=>c({...f,status:Array.isArray(l.target.value)?l.target.value:[l.target.value]}),label:"Stav prenájmu",renderValue:l=>e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:l.map(A=>e.jsx(G,{label:A,size:"small"},A))}),children:R.map(l=>e.jsx(de,{value:l,children:l},l))})]})}),e.jsx(pe,{item:!0,xs:12,sm:6,md:4,children:e.jsx($,{size:"small",fullWidth:!0,label:"Dátum od",type:"date",value:f.dateFrom||"",onChange:l=>c({...f,dateFrom:l.target.value}),InputLabelProps:{shrink:!0}})}),e.jsx(pe,{item:!0,xs:12,sm:6,md:4,children:e.jsx($,{size:"small",fullWidth:!0,label:"Dátum do",type:"date",value:f.dateTo||"",onChange:l=>c({...f,dateTo:l.target.value}),InputLabelProps:{shrink:!0}})})]})]})]})]})}),uo=n.memo(({rental:r,vehicle:P,index:m,totalRentals:z,hasHandover:f,hasReturn:c,isLoadingProtocolStatus:k,protocolStatusLoaded:I,onEdit:M,onOpenProtocolMenu:t,onCheckProtocols:C,onDelete:R})=>{const T=ze.useCallback(()=>{M(r)},[r,M]),j=ze.useCallback(h=>{h.stopPropagation(),t(r,"handover")},[r,t]),L=ze.useCallback(h=>{h.stopPropagation(),t(r,"return")},[r,t]),l=ze.useCallback(h=>{h.stopPropagation(),C(r)},[r,C]),A=ze.useCallback(h=>{h.stopPropagation(),R&&R(r.id)},[r.id,R]),u=()=>{switch(r.status){case"active":return"#4caf50";case"finished":return"#2196f3";case"pending":return"#ff9800";default:return"#757575"}},b=()=>{switch(r.status){case"active":return"AKTÍVNY";case"finished":return"UKONČENÝ";case"pending":return"ČAKAJÚCI";default:return"NOVÝ"}},N=r.isFlexible||!1;return e.jsx(It,{in:!0,timeout:300+m*50,children:e.jsx(he,{sx:{mb:1.5,borderRadius:2,boxShadow:"0 2px 8px rgba(0,0,0,0.08)",border:N?"2px solid #ff9800":"1px solid rgba(0,0,0,0.06)",cursor:"pointer",transition:"all 0.3s ease",backgroundColor:N?"#fff8f0":"white","&:hover":{boxShadow:"0 4px 16px rgba(0,0,0,0.12)",transform:"translateY(-1px)"},"&:active":{transform:"translateY(0px)",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"}},onClick:T,children:e.jsxs(je,{sx:{p:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1.5},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsxs(x,{variant:"h6",sx:{fontWeight:700,fontSize:"1rem",color:"#1976d2",mb:.25,display:"flex",alignItems:"center",gap:1},children:[e.jsx(so,{fontSize:"small"}),P?.licensePlate||"N/A"]}),e.jsxs(x,{variant:"body2",sx:{color:"#666",fontSize:"0.85rem",mb:.25},children:[P?.brand," ",P?.model]}),P?.company&&e.jsxs(x,{variant:"body2",sx:{color:"#ff9800",fontSize:"0.8rem",fontWeight:600,display:"flex",alignItems:"center",gap:.5,mb:.25},children:[e.jsx(zo,{fontSize:"small"}),P.company]})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:1},children:[e.jsx(G,{label:b(),size:"medium",sx:{bgcolor:u(),color:"white",fontWeight:600,fontSize:"0.8rem",height:32}}),N&&e.jsx(G,{label:"FLEXIBILNÝ",size:"medium",sx:{bgcolor:"#ff9800",color:"white",fontWeight:600,fontSize:"0.75rem",height:28}})]})]}),e.jsxs(i,{sx:{mb:1.5},children:[e.jsxs(x,{variant:"subtitle1",sx:{fontWeight:600,fontSize:"0.95rem",color:"#333",mb:.25,display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{sx:{width:6,height:6,borderRadius:"50%",bgcolor:"#4caf50"}}),r.customerName]}),e.jsxs(i,{sx:{display:"flex",flexWrap:"wrap",gap:2,alignItems:"center"},children:[(r.customerPhone||r.customer?.phone)&&e.jsxs(x,{variant:"body2",sx:{color:"#666",fontSize:"0.8rem",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Io,{fontSize:"small"}),r.customerPhone||r.customer?.phone]}),(r.customerEmail||r.customer?.email)&&e.jsxs(x,{variant:"body2",sx:{color:"#666",fontSize:"0.8rem",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(po,{fontSize:"small"}),r.customerEmail||r.customer?.email]})]})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,p:1.5,bgcolor:"#f8f9fa",borderRadius:2},children:[e.jsxs(i,{children:[e.jsx(x,{variant:"body2",sx:{color:"#666",fontSize:"0.75rem",mb:.25},children:"Obdobie prenájmu"}),e.jsxs(x,{variant:"body1",sx:{fontWeight:700,fontSize:"0.95rem",color:"#1976d2",lineHeight:1.3,mb:.25},children:["📅 ",yt(new Date(r.startDate),"d.M.yy HH:mm",{locale:Ft})]}),e.jsxs(x,{variant:"body1",sx:{fontWeight:700,fontSize:"0.95rem",color:"#f57c00",lineHeight:1.3},children:["🏁 ",yt(new Date(r.endDate),"d.M.yy HH:mm",{locale:Ft})]})]}),e.jsxs(i,{sx:{textAlign:"right"},children:[e.jsx(x,{variant:"body2",sx:{color:"#666",fontSize:"0.75rem",mb:.25},children:"Celková cena"}),e.jsxs(x,{variant:"h6",sx:{fontWeight:700,fontSize:"1.1rem",color:"#4caf50",display:"flex",alignItems:"center",gap:.5,justifyContent:"flex-end"},children:[e.jsx(Ro,{fontSize:"small"}),r.totalPrice?.toFixed(2)]}),r.extraKmCharge&&r.extraKmCharge>0&&e.jsxs(x,{variant:"caption",sx:{display:"block",fontSize:"0.7rem",color:"#ff9800",fontWeight:600,mt:.25},children:["+",r.extraKmCharge.toFixed(2),"€ extra km"]})]})]}),e.jsxs(i,{sx:{display:"flex",gap:1.5,mb:1.5},children:[e.jsx(q,{variant:f?"contained":"outlined",size:"large",fullWidth:!0,onClick:j,startIcon:f?e.jsx(Nt,{}):e.jsx(_t,{}),sx:{height:42,fontSize:"0.85rem",fontWeight:600,bgcolor:f?"#4caf50":"transparent",borderColor:f?"#4caf50":"#ff9800",color:f?"white":"#ff9800","&:hover":{bgcolor:f?"#388e3c":"rgba(255,152,0,0.1)",transform:"scale(1.02)",boxShadow:f?"0 4px 12px rgba(76,175,80,0.3)":"0 4px 12px rgba(255,152,0,0.2)"},transition:"all 0.2s ease"},children:f?"Odovzdané":"Odovzdať"}),e.jsx(q,{variant:c?"contained":"outlined",size:"large",fullWidth:!0,onClick:L,startIcon:c?e.jsx(Nt,{}):e.jsx(_t,{}),sx:{height:42,fontSize:"0.85rem",fontWeight:600,bgcolor:c?"#4caf50":"transparent",borderColor:c?"#4caf50":"#ff9800",color:c?"white":"#ff9800","&:hover":{bgcolor:c?"#388e3c":"rgba(255,152,0,0.1)",transform:"scale(1.02)",boxShadow:c?"0 4px 12px rgba(76,175,80,0.3)":"0 4px 12px rgba(255,152,0,0.2)"},transition:"all 0.2s ease"},children:c?"Prevzaté":"Prevziať"})]}),r.notes&&e.jsx(i,{sx:{mb:1.5},children:e.jsxs(x,{variant:"body2",sx:{color:"#333",bgcolor:"#f5f5f5",p:1.5,borderRadius:1,fontSize:"0.8rem",border:"1px solid #e0e0e0"},children:["📝 ",r.notes]})}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[k?e.jsx(q,{variant:"outlined",size:"small",disabled:!0,sx:{borderColor:"#ff9800",color:"#ff9800",fontSize:"0.75rem",height:32},children:"Načítavam..."}):I?e.jsx(i,{}):e.jsx(q,{variant:"outlined",size:"small",onClick:l,sx:{borderColor:"#2196f3",color:"#2196f3",fontSize:"0.75rem",height:32,"&:hover":{bgcolor:"rgba(33,150,243,0.1)"}},children:"Skontrolovať"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(G,{label:r.paid?"💰 UHRADENÉ":"⏰ NEUHRADENÉ",size:"small",sx:{height:28,fontSize:"0.75rem",bgcolor:r.paid?"#4caf50":"#f44336",color:"white",fontWeight:600}}),R&&e.jsx(le,{onClick:A,sx:{color:"#f44336",width:32,height:32,"&:hover":{bgcolor:"rgba(244,67,54,0.1)",transform:"scale(1.1)"},transition:"all 0.2s ease"},children:e.jsx(no,{fontSize:"small"})})]})]})]})})})});uo.displayName="MobileRentalRow";const Qo=({paginatedRentals:r,isMobile:P,handleEdit:m,handleDelete:z,handleCreateHandover:f,handleCreateReturn:c,handleOpenProtocolMenu:k,handleViewRental:I,onScroll:M,getVehicleByRental:t,protocolStatusMap:C,protocols:R,getStatusIndicator:T,filteredRentals:j,desktopScrollRef:L,mobileScrollRef:l,isLoadingProtocolStatus:A,protocolStatusLoaded:u,handleCheckProtocols:b,loadingProtocols:N,VirtualizedRentalRow:h})=>(At(),e.jsx(e.Fragment,{children:P?e.jsx(i,{sx:{mx:1,py:2,minHeight:"60vh",maxHeight:"80vh",overflow:"auto","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"#888",borderRadius:"3px"},"&::-webkit-scrollbar-thumb:hover":{background:"#555"}},children:j.map((s,o)=>{const p=C[s.id],d=R[s.id],S=p?p.hasHandoverProtocol:!!d?.handover,_=p?p.hasReturnProtocol:!!d?.return;return e.jsx(uo,{rental:s,vehicle:t(s),index:o,totalRentals:j.length,hasHandover:S,hasReturn:_,isLoadingProtocolStatus:N.includes(s.id),protocolStatusLoaded:C[s.id]!==void 0,onEdit:m,onOpenProtocolMenu:k,onCheckProtocols:b,onDelete:U=>z(U)},s.id)})}):e.jsx(he,{sx:{overflow:"hidden",boxShadow:"0 6px 20px rgba(0,0,0,0.1)",borderRadius:3},children:e.jsxs(je,{sx:{p:0},children:[e.jsxs(i,{sx:{display:"flex",borderBottom:"3px solid #e0e0e0",backgroundColor:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",background:"#f8f9fa",position:"sticky",top:0,zIndex:1e3},children:[e.jsx(i,{sx:{width:260,maxWidth:260,p:2,borderRight:"2px solid #e0e0e0",backgroundColor:"#ffffff",display:"flex",alignItems:"center",boxShadow:"2px 0 4px rgba(0,0,0,0.1)",overflow:"hidden"},children:e.jsx(x,{variant:"h6",sx:{fontWeight:700,color:"#1976d2",fontSize:"1rem"},children:"🚗 Vozidlo & Status"})}),e.jsx(i,{sx:{width:180,maxWidth:180,p:2,borderRight:"1px solid #e0e0e0",textAlign:"center",backgroundColor:"#f8f9fa",overflow:"hidden"},children:e.jsx(x,{variant:"subtitle1",sx:{fontWeight:700,color:"#666",fontSize:"0.9rem"},children:"👤 Zákazník"})}),e.jsx(i,{sx:{width:160,maxWidth:160,p:2,borderRight:"1px solid #e0e0e0",textAlign:"center",backgroundColor:"#f8f9fa",overflow:"hidden"},children:e.jsx(x,{variant:"subtitle1",sx:{fontWeight:700,color:"#666",fontSize:"0.9rem"},children:"📅 Obdobie"})}),e.jsx(i,{sx:{width:120,maxWidth:120,p:2,borderRight:"1px solid #e0e0e0",textAlign:"center",backgroundColor:"#f8f9fa",overflow:"hidden"},children:e.jsx(x,{variant:"subtitle1",sx:{fontWeight:700,color:"#666",fontSize:"0.9rem"},children:"💰 Cena"})}),e.jsx(i,{sx:{width:140,maxWidth:140,p:2,borderRight:"1px solid #e0e0e0",textAlign:"center",backgroundColor:"#f8f9fa",overflow:"hidden"},children:e.jsx(x,{variant:"subtitle1",sx:{fontWeight:700,color:"#666",fontSize:"0.9rem"},children:"📋 Protokoly"})}),e.jsx(i,{sx:{width:180,maxWidth:180,p:2,textAlign:"center",backgroundColor:"#f8f9fa"},children:e.jsx(x,{variant:"subtitle1",sx:{fontWeight:700,color:"#666",fontSize:"0.9rem"},children:"⚡ Akcie"})})]}),e.jsx(i,{ref:L,sx:{minHeight:"60vh",maxHeight:"75vh",overflowY:"auto",overflowX:"hidden",position:"relative","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1"},"&::-webkit-scrollbar-thumb":{background:"#888",borderRadius:"4px"},"&::-webkit-scrollbar-thumb:hover":{background:"#555"}},children:(r||[]).map((s,o)=>{const p=t(s),d=s.isFlexible||!1,S=C[s.id],_=R[s.id],U=S?S.hasHandoverProtocol:!!_?.handover,D=S?S.hasReturnProtocol:!!_?.return;return e.jsxs(i,{"data-rental-item":`rental-${o}`,sx:{display:"flex",borderBottom:o<j.length-1?"1px solid #e0e0e0":"none","&:hover":{backgroundColor:d?"#fff3e0":"rgba(0,0,0,0.04)",transform:"scale(1.002)",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},minHeight:80,transition:"all 0.2s ease",cursor:"pointer",backgroundColor:d?"#fff8f0":"transparent",borderLeft:d?"4px solid #ff9800":"none",position:"relative"},onClick:()=>{m(s)},children:[e.jsxs(i,{sx:{width:260,maxWidth:260,p:2,borderRight:"2px solid #e0e0e0",display:"flex",flexDirection:"column",justifyContent:"center",backgroundColor:"#ffffff",position:"sticky",left:0,zIndex:10,boxShadow:"2px 0 4px rgba(0,0,0,0.05)",overflow:"hidden"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.75,mb:.5},children:[e.jsx(i,{sx:{width:14,height:14,borderRadius:"50%",backgroundColor:T(s).color,flexShrink:0,border:"2px solid white",boxShadow:"0 2px 4px rgba(0,0,0,0.3)"}}),e.jsxs(x,{variant:"h6",sx:{fontWeight:700,fontSize:"1rem",color:"#1976d2",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",lineHeight:1.2},children:[p?.brand," ",p?.model]})]}),e.jsxs(x,{variant:"body2",sx:{color:"#666",fontSize:"0.8rem",mb:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["📋 ",p?.licensePlate," • 🏢 ",p?.company]}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:.5,alignItems:"flex-start"},children:[e.jsx(G,{size:"small",label:s.status==="active"?"AKTÍVNY":s.status==="finished"?"DOKONČENÝ":s.status==="pending"?"ČAKAJÚCI":"NOVÝ",sx:{height:24,fontSize:"0.7rem",bgcolor:s.status==="active"?"#4caf50":s.status==="finished"?"#2196f3":s.status==="pending"?"#ff9800":"#666",color:"white",fontWeight:700}}),d&&e.jsx(G,{size:"small",label:"FLEXIBILNÝ",sx:{height:22,fontSize:"0.65rem",bgcolor:"#ff9800",color:"white",fontWeight:700}})]})]}),e.jsxs(i,{sx:{width:180,maxWidth:180,p:2,borderRight:"1px solid #e0e0e0",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"left",overflow:"hidden"},children:[e.jsxs(x,{variant:"subtitle1",sx:{fontWeight:600,fontSize:"0.9rem",color:"#333",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["👤 ",s.customerName]}),(s.customerPhone||s.customer?.phone)&&e.jsxs(x,{variant:"caption",sx:{color:"#666",fontSize:"0.7rem",display:"block",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["📞 ",s.customerPhone||s.customer?.phone]}),e.jsxs(x,{variant:"caption",sx:{color:"#666",fontSize:"0.75rem",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["📧 ",s.customerEmail||"N/A"]})]}),e.jsxs(i,{sx:{width:160,maxWidth:160,p:2,borderRight:"1px solid #e0e0e0",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",overflow:"hidden"},children:[e.jsxs(x,{variant:"body2",sx:{fontWeight:600,fontSize:"0.8rem",color:"#333",mb:.5},children:["📅 ",yt(new Date(s.startDate),"d.M.yyyy HH:mm")]}),e.jsx(x,{variant:"caption",sx:{color:"#666",fontSize:"0.7rem",mb:.5},children:"↓"}),e.jsxs(x,{variant:"body2",sx:{fontWeight:600,fontSize:"0.8rem",color:"#333"},children:["📅 ",yt(new Date(s.endDate),"d.M.yyyy HH:mm")]})]}),e.jsxs(i,{sx:{width:120,maxWidth:120,p:2,borderRight:"1px solid #e0e0e0",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",overflow:"hidden"},children:[e.jsxs(x,{variant:"h6",sx:{fontWeight:700,fontSize:"1.1rem",color:"#4caf50",mb:.5},children:[s.totalPrice?.toFixed(2),"€",s.extraKmCharge&&s.extraKmCharge>0&&e.jsxs(x,{component:"span",variant:"caption",sx:{display:"block",fontSize:"0.7rem",color:"#ff9800",fontWeight:600},children:["+",s.extraKmCharge.toFixed(2),"€ extra km"]})]}),e.jsx(G,{size:"small",label:s.paid?"UHRADENÉ":"NEUHRADENÉ",sx:{height:20,fontSize:"0.6rem",bgcolor:s.paid?"#4caf50":"#f44336",color:"white",fontWeight:700}})]}),e.jsxs(i,{sx:{width:140,maxWidth:140,p:2,borderRight:"1px solid #e0e0e0",display:"flex",justifyContent:"center",alignItems:"center",gap:1.5,flexDirection:"column",overflow:"hidden"},children:[e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(It,{in:!0,timeout:600,children:e.jsx(G,{size:"small",label:"🚗→",title:U?"Kliknite pre zobrazenie protokolu":"Protokol neexistuje",onClick:O=>{O.stopPropagation(),U&&k(s,"handover")},sx:{height:28,width:42,fontSize:"0.8rem",bgcolor:U?"#4caf50":"#ccc",color:"white",fontWeight:700,cursor:U?"pointer":"default",transform:U?"scale(1)":"scale(0.95)",opacity:U?1:.7,"&:hover":U?{bgcolor:"#388e3c",transform:"scale(1.15)",boxShadow:"0 4px 12px rgba(76,175,80,0.4)",animation:"pulse 0.8s ease"}:{transform:"scale(0.98)",opacity:.8},transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","@keyframes pulse":{"0%":{transform:"scale(1.15)"},"50%":{transform:"scale(1.25)"},"100%":{transform:"scale(1.15)"}}}})}),e.jsx(It,{in:!0,timeout:800,children:e.jsx(G,{size:"small",label:"←🚗",title:D?"Kliknite pre zobrazenie protokolu":"Protokol neexistuje",onClick:O=>{O.stopPropagation(),D&&k(s,"return")},sx:{height:28,width:42,fontSize:"0.8rem",bgcolor:D?"#4caf50":"#ccc",color:"white",fontWeight:700,cursor:D?"pointer":"default",transform:D?"scale(1)":"scale(0.95)",opacity:D?1:.7,"&:hover":D?{bgcolor:"#388e3c",transform:"scale(1.15)",boxShadow:"0 4px 12px rgba(76,175,80,0.4)",animation:"pulse 0.8s ease"}:{transform:"scale(0.98)",opacity:.8},transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","@keyframes pulse":{"0%":{transform:"scale(1.15)"},"50%":{transform:"scale(1.25)"},"100%":{transform:"scale(1.15)"}}}})})]}),e.jsx(x,{variant:"caption",sx:{color:"#666",fontSize:"0.7rem",textAlign:"center"},children:U&&D?"✅ Kompletné":U?"🚗→ Odovzdané":D?"←🚗 Vrátené":"⏳ Čaká"}),A?e.jsx(le,{size:"small",title:"Načítavam protocol status...",disabled:!0,sx:{bgcolor:"#ff9800",color:"white",width:28,height:28,mt:.5,animation:"pulse 2s infinite"},children:e.jsx(Rt,{fontSize:"small"})}):!u&&e.jsx(le,{size:"small",title:"Skontrolovať protokoly",onClick:O=>{O.stopPropagation(),b(s)},sx:{bgcolor:"#9c27b0",color:"white",width:28,height:28,mt:.5,"&:hover":{bgcolor:"#7b1fa2",transform:"scale(1.1)",boxShadow:"0 4px 12px rgba(156,39,176,0.4)"},transition:"all 0.2s ease"},children:e.jsx(Rt,{fontSize:"small"})})]}),e.jsxs(i,{sx:{width:180,maxWidth:180,p:2,display:"flex",justifyContent:"center",alignItems:"center",gap:1.5,flexWrap:"wrap"},children:[e.jsx(le,{size:"small",title:"Upraviť prenájom",onClick:O=>{O.stopPropagation(),m(s)},sx:{bgcolor:"#2196f3",color:"white","&:hover":{bgcolor:"#1976d2",transform:"scale(1.05)",boxShadow:"0 4px 12px rgba(33,150,243,0.4)"},"&:active":{transform:"scale(0.95)"},transition:"all 0.2s ease"},children:e.jsx(io,{fontSize:"small"})}),e.jsx(le,{size:"small",title:U?"Zobraziť odovzdávací protokol":"Vytvoriť odovzdávací protokol",onClick:O=>{O.stopPropagation(),U?k(s,"handover"):f(s)},sx:{bgcolor:U?"#4caf50":"#ff9800",color:"white","&:hover":{bgcolor:U?"#388e3c":"#f57c00",transform:"scale(1.05)",boxShadow:U?"0 4px 12px rgba(76,175,80,0.4)":"0 4px 12px rgba(255,152,0,0.4)"},"&:active":{transform:"scale(0.95)"},transition:"all 0.2s ease"},children:e.jsx(No,{fontSize:"small"})}),e.jsx(le,{size:"small",title:D?"Zobraziť vrátny protokol":"Vytvoriť vrátny protokol",onClick:O=>{O.stopPropagation(),D?k(s,"return"):c(s)},sx:{bgcolor:D?"#2196f3":"#4caf50",color:"white","&:hover":{bgcolor:D?"#1976d2":"#388e3c",transform:"scale(1.1)",boxShadow:D?"0 4px 12px rgba(33,150,243,0.4)":"0 4px 12px rgba(76,175,80,0.4)"},transition:"all 0.2s ease"},children:e.jsx(_o,{fontSize:"small"})}),e.jsx(le,{size:"small",title:"Zmazať prenájom",onClick:O=>{O.stopPropagation(),z(s.id)},sx:{bgcolor:"#f44336",color:"white","&:hover":{bgcolor:"#d32f2f",transform:"scale(1.1)",boxShadow:"0 4px 12px rgba(244,67,54,0.4)"},transition:"all 0.2s ease"},children:e.jsx(no,{fontSize:"small"})})]})]},s.id)})})]})})}));var nt={},Bt;function Jo(){if(Bt)return nt;Bt=1;var r=qe();Object.defineProperty(nt,"__esModule",{value:!0}),nt.default=void 0;var P=r(Ge()),m=Ze();return nt.default=(0,P.default)((0,m.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),nt}var Xo=Jo();const ea=Ye(Xo);var it={},qt;function ta(){if(qt)return it;qt=1;var r=qe();Object.defineProperty(it,"__esModule",{value:!0}),it.default=void 0;var P=r(Ge()),m=Ze();return it.default=(0,P.default)((0,m.jsx)("path",{d:"M7.5 11C9.43 11 11 9.43 11 7.5S9.43 4 7.5 4 4 5.57 4 7.5 5.57 11 7.5 11m0-5C8.33 6 9 6.67 9 7.5S8.33 9 7.5 9 6 8.33 6 7.5 6.67 6 7.5 6M4.0025 18.5832 18.59 3.9955l1.4142 1.4143L5.4167 19.9974zM16.5 13c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5m0 5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5"}),"Percent"),it}var oa=ta();const aa=Ye(oa);var lt={},Zt;function ra(){if(Zt)return lt;Zt=1;var r=qe();Object.defineProperty(lt,"__esModule",{value:!0}),lt.default=void 0;var P=r(Ge()),m=Ze();return lt.default=(0,P.default)((0,m.jsx)("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02z"}),"Phone"),lt}var sa=ra();const na=Ye(sa);var ct={},Yt;function ia(){if(Yt)return ct;Yt=1;var r=qe();Object.defineProperty(ct,"__esModule",{value:!0}),ct.default=void 0;var P=r(Ge()),m=Ze();return ct.default=(0,P.default)((0,m.jsx)("path",{d:"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"}),"Email"),ct}var la=ia();const ca=Ye(la);var dt={},Gt;function da(){if(Gt)return dt;Gt=1;var r=qe();Object.defineProperty(dt,"__esModule",{value:!0}),dt.default=void 0;var P=r(Ge()),m=Ze();return dt.default=(0,P.default)((0,m.jsx)("path",{d:"M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m7 18H5V4h2v3h10V4h2z"}),"ContentPaste"),dt}var ua=da();const ma=Ye(ua);var ut={},Qt;function ha(){if(Qt)return ut;Qt=1;var r=qe();Object.defineProperty(ut,"__esModule",{value:!0}),ut.default=void 0;var P=r(Ge()),m=Ze();return ut.default=(0,P.default)((0,m.jsx)("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.9959.9959 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"}),"AutoFixHigh"),ut}var pa=ha();const Jt=Ye(pa);var mt={},Xt;function xa(){if(Xt)return mt;Xt=1;var r=qe();Object.defineProperty(mt,"__esModule",{value:!0}),mt.default=void 0;var P=r(Ge()),m=Ze();return mt.default=(0,P.default)((0,m.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),mt}var fa=xa();const ga=Ye(fa);function va({onParseSuccess:r,vehicles:P,customers:m}){const[z,f]=n.useState(""),[c,k]=n.useState(null),[I,M]=n.useState(""),[t,C]=n.useState(!1),[R,T]=n.useState(!1),j=u=>{const b={},N=u.match(/Číslo objednávky\s+([A-Z]+\d+)/i);N&&(b.orderNumber=N[1]);const h=u.match(/Objednávka prijatá\s+(\d{2}\.\d{2}\.\d{4})/);h&&(b.orderDate=h[1]);const s=u.match(/Spôsob úhrady\s+(.+)/);s&&(b.paymentMethod=s[1].trim());const o=u.match(/Odoberateľ\s+(.+)/);o&&(b.customerName=o[1].trim());const p=u.match(/E-mail\s+(.+)/);p&&(b.customerEmail=p[1].trim());const d=u.match(/Telefon\s+(.+)/);d&&(b.customerPhone=d[1].trim());const S=u.match(/Kontaktná adresa\s+(.+)/);S&&(b.customerAddress=S[1].trim());const _=u.match(/Miesto vyzdvihnutia\s+(.+)/);_&&(b.pickupPlace=_[1].trim());const U=u.match(/Miesto odovzdania\s+(.+)/);U&&(b.returnPlace=U[1].trim());const D=u.match(/Čas rezervacie\s+(.+)/);D&&(b.reservationTime=D[1].trim());const O=u.match(/Depozit\s+([\d\s,]+)\s*€/);if(O){const ee=O[1].replace(/\s/g,"").replace(",",".");b.deposit=parseFloat(ee)}const Q=u.match(/Suma k úhrade\s+([\d\s,]+)\s*€/);if(Q){const ee=Q[1].replace(/\s/g,"").replace(",",".");b.totalAmount=parseFloat(ee)}const V=u.match(/Položky objednávky\s*\n\s*Názov\s+Kód\s+Cena\s+Spolu\s*\n([^\n]+)/);if(V){const ie=V[1].trim().split(/\s+/).filter(te=>te.trim()),se=ie.findIndex(te=>/^[A-Z0-9]{6,7}$/.test(te.trim()));if(se>0&&(b.vehicleName=ie.slice(0,se).join(" "),b.vehicleCode=ie[se],ie.length>se+2)){const te=ie[se+1].replace(",",".").replace("€","").trim();b.vehiclePrice=parseFloat(te)}}else{const ee=u.match(/Položky objednávky\s*\n\s*Názov\s+Kód\s+Cena\s+Spolu\s*\n([^\n]+)/);if(ee){const se=ee[1].trim().split(/\s+/).filter(K=>K.trim()),te=se.findIndex(K=>/^[A-Z0-9]{6,7}$/.test(K.trim()));if(te>0&&(b.vehicleName=se.slice(0,te).join(" "),b.vehicleCode=se[te],se.length>te+2)){const K=se[te+1].replace(",",".").replace("€","").trim();b.vehiclePrice=parseFloat(K)}}}const ce=u.match(/Počet povolených km\s+(\d+)\s*km/i);if(ce)b.dailyKilometers=parseInt(ce[1]);else{const ee=u.match(/(\d+)\s*km\s*\/\s*de[ňn]/i)||u.match(/(\d+)\s*km\s*na\s*de[ňn]/i)||u.match(/denný\s*limit[:\s]*(\d+)\s*km/i)||u.match(/denne[:\s]*(\d+)\s*km/i)||u.match(/(\d+)\s*km\s*daily/i);if(ee)b.dailyKilometers=parseInt(ee[1]);else{const ie=u.match(/Povolené\s+km[:\s]+(\d+)/i)||u.match(/Kilometrov[:\s]+(\d+)/i)||u.match(/Limit\s+km[:\s]+(\d+)/i)||u.match(/(\d+)\s*km/i);ie&&(b.dailyKilometers=parseInt(ie[1]))}}const w=u.match(/Cena\s+za\s+km[:\s]+([\d,]+)\s*€/i)||u.match(/Extra\s+km[:\s]+([\d,]+)\s*€/i)||u.match(/Nadlimitn[ý]\s+km[:\s]+([\d,]+)\s*€/i);if(w){const ee=w[1].replace(",",".");b.extraKilometerRate=parseFloat(ee)}const J=u.match(/Palivo[:\s]+(\d+)%/i)||u.match(/Fuel[:\s]+(\d+)%/i)||u.match(/Nádrž[:\s]+(\d+)%/i);J&&(b.fuelLevel=parseInt(J[1]));const Y=u.match(/Tachometer[:\s]+([\d\s]+)\s*km/i)||u.match(/Kilometrov[:\s]+([\d\s]+)\s*km/i)||u.match(/Stav[:\s]+([\d\s]+)\s*km/i);if(Y){const ee=Y[1].replace(/\s/g,"");b.startOdometer=parseInt(ee)}const X=u.match(/Podmienky\s+vrátenia[:\s]+([^.]+)/i)||u.match(/Return\s+conditions[:\s]+([^.]+)/i);X&&(b.returnConditions=X[1].trim());const y=u.match(/Poznámky[:\s]+([^.]+)/i)||u.match(/Notes[:\s]+([^.]+)/i)||u.match(/Dodatočné\s+informácie[:\s]+([^.]+)/i);y&&(b.notes=y[1].trim());const B=u.match(/Poistenie[:\s]+([^.]+)/i)||u.match(/Insurance[:\s]+([^.]+)/i);return B&&(b.insuranceInfo=B[1].trim()),b},L=()=>{if(!z.trim()){M("Prosím vložte text z emailu"),C(!0);return}try{const u=j(z);if(k(u),u.vehicleCode){const b=P.some(N=>N.licensePlate===u.vehicleCode);T(b)}else T(!1);M(""),C(!1)}catch{M("Chyba pri parsovaní textu"),C(!0)}},l=()=>{if(!c)return;let u;c.customerName&&(u=m.find(d=>d.name&&d.name.toLowerCase()===c.customerName.toLowerCase()||d.email===c.customerEmail),!u&&c.customerName&&(u={id:Te(),name:c.customerName,email:c.customerEmail||"",phone:c.customerPhone||"",createdAt:new Date}));const b=d=>d?.trim().toUpperCase().replace(/\s+/g,"")||"";if(c.vehicleCode){const d=b(c.vehicleCode);P.some(S=>b(S.licensePlate||"")===d)}let N;if(c.vehicleCode){const d=b(c.vehicleCode);N=P.find(S=>b(S.licensePlate||"")===d),P.filter(S=>S.brand==="Lotus"&&S.model==="Emira"||S.licensePlate&&S.licensePlate.toLowerCase().includes("677")).map(S=>({plate:`"${S.licensePlate}"`,normalized:`"${b(S.licensePlate||"")}"`,brand:S.brand,model:S.model,plateLength:S.licensePlate?.length||0,plateChars:S.licensePlate?Array.from(S.licensePlate).map(_=>_.charCodeAt(0)):[]}))}!N&&c.vehicleName&&(N=P.find(d=>d.brand&&d.model&&`${d.brand} ${d.model}`.toLowerCase().includes(c.vehicleName.toLowerCase())));let h=new Date,s=new Date;if(c.reservationTime){const d=c.reservationTime.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) - (\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);d&&(h=new Date(d[1]),s=new Date(d[2]))}let o="cash";if(c.paymentMethod){const d=c.paymentMethod.toLowerCase();d.includes("hotovosť")||d.includes("cash")?o="cash":d.includes("bank")||d.includes("prevod")?o="bank_transfer":d.includes("vrp")&&(o="vrp")}const p={vehicleId:N?.id||"",customerName:c.customerName||"",startDate:h,endDate:s,totalPrice:c.totalAmount||0,paymentMethod:o,handoverPlace:c.pickupPlace||"",orderNumber:c.orderNumber||"",deposit:c.deposit||0,dailyKilometers:c.dailyKilometers||0,allowedKilometers:c.allowedKilometers||0,extraKilometerRate:c.extraKilometerRate||0,fuelLevel:c.fuelLevel||100,odometer:c.startOdometer||0,returnConditions:c.returnConditions||"",notes:c.notes||"",customerAddress:c.customerAddress||"",customerEmail:c.customerEmail||"",customerPhone:c.customerPhone||"",pickupLocation:c.pickupPlace||"",returnLocation:c.returnPlace||"",reservationTime:c.reservationTime||"",vehicleCode:c.vehicleCode||"",vehicleName:c.vehicleName||""};r(p,u),c.vehicleCode&&!N&&alert(`Upozornenie: Vozidlo so ŠPZ "${c.vehicleCode}" sa nenašlo v databáze. Prosím vyberte vozidlo manuálne.`),f(""),k(null),M(""),C(!1)},A=async()=>{try{const u=await navigator.clipboard.readText();f(u)}catch{M("Nepodarilo sa vložiť text zo schránky"),C(!0)}};return e.jsx(he,{sx:{mb:2},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Jt,{}),"Automatické parsovanie z emailu"]}),e.jsx(ro,{in:t,children:e.jsx(et,{severity:I?"error":"success",action:e.jsx(le,{"aria-label":"close",color:"inherit",size:"small",onClick:()=>C(!1),children:e.jsx(ga,{fontSize:"inherit"})}),sx:{mb:2},children:I||"Dáta boli úspešne spracované"})}),e.jsx(i,{sx:{mb:2},children:e.jsx($,{fullWidth:!0,multiline:!0,rows:8,variant:"outlined",label:"Vložte text z emailu",value:z,onChange:u=>f(u.target.value),placeholder:"Vložte sem text z emailu s detailmi objednávky..."})}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(q,{variant:"outlined",startIcon:e.jsx(ma,{}),onClick:A,children:"Vložiť zo schránky"}),e.jsx(q,{variant:"contained",startIcon:e.jsx(Jt,{}),onClick:L,disabled:!z.trim(),children:"Spracovať dáta"})]}),c&&e.jsx(he,{variant:"outlined",sx:{mt:2},children:e.jsxs(je,{children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:e.jsx("strong",{children:"Nájdené dáta:"})}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1,fontSize:"0.9rem"},children:[c.orderNumber&&e.jsxs("div",{children:[e.jsx("strong",{children:"Číslo objednávky:"})," ",c.orderNumber]}),c.customerName&&e.jsxs("div",{children:[e.jsx("strong",{children:"Zákazník:"})," ",c.customerName]}),c.customerEmail&&e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",c.customerEmail]}),c.customerPhone&&e.jsxs("div",{children:[e.jsx("strong",{children:"Telefón:"})," ",c.customerPhone]}),c.vehicleCode&&e.jsxs("div",{children:[e.jsx("strong",{children:"ŠPZ vozidla:"})," ",c.vehicleCode,R?e.jsx("span",{style:{color:"green",marginLeft:"8px"},children:"✓ Nájdené"}):e.jsx("span",{style:{color:"red",marginLeft:"8px"},children:"✗ Nenájdené"})]}),c.vehicleName&&e.jsxs("div",{children:[e.jsx("strong",{children:"Názov vozidla:"})," ",c.vehicleName]}),c.totalAmount&&e.jsxs("div",{children:[e.jsx("strong",{children:"Suma:"})," ",c.totalAmount," €"]}),c.pickupPlace&&e.jsxs("div",{children:[e.jsx("strong",{children:"Miesto vyzdvihnutia:"})," ",c.pickupPlace]}),c.reservationTime&&e.jsxs("div",{children:[e.jsx("strong",{children:"Čas rezervácie:"})," ",c.reservationTime]}),c.deposit&&e.jsxs("div",{children:[e.jsx("strong",{children:"Depozit:"})," ",c.deposit," €"]}),c.dailyKilometers&&e.jsxs("div",{children:[e.jsx("strong",{children:"Denné km:"})," ",c.dailyKilometers," km/deň"]}),c.allowedKilometers&&e.jsxs("div",{children:[e.jsx("strong",{children:"Povolené km:"})," ",c.allowedKilometers," km"]}),c.extraKilometerRate&&e.jsxs("div",{children:[e.jsx("strong",{children:"Cena za extra km:"})," ",c.extraKilometerRate," €/km"]}),c.fuelLevel&&e.jsxs("div",{children:[e.jsx("strong",{children:"Úroveň paliva:"})," ",c.fuelLevel,"%"]}),c.startOdometer&&e.jsxs("div",{children:[e.jsx("strong",{children:"Stav tachometra:"})," ",c.startOdometer," km"]}),c.returnConditions&&e.jsxs("div",{children:[e.jsx("strong",{children:"Podmienky vrátenia:"})," ",c.returnConditions]}),c.notes&&e.jsxs("div",{children:[e.jsx("strong",{children:"Poznámky:"})," ",c.notes]})]}),e.jsx(q,{variant:"contained",color:"primary",onClick:l,sx:{mt:2},fullWidth:!0,children:"Použiť dáta v formulári"})]})})]})})}const zt=(r,P)=>{const m=P.getTime()-r.getTime(),z=Math.ceil(m/(1e3*3600*24));return Math.max(1,z)};function ba({rental:r,onSave:P,onCancel:m,isLoading:z=!1}){const{state:f,dispatch:c,createCustomer:k,updateCustomer:I,loadData:M}=Mt(),[t,C]=n.useState({vehicleId:"",customerId:"",customerName:"",startDate:new Date,endDate:new Date,paymentMethod:"cash",orderNumber:"",isFlexible:!1,flexibleEndDate:void 0,isPrivateRental:!1}),[R,T]=n.useState(0),[j,L]=n.useState(0),[l,A]=n.useState(void 0),[u,b]=n.useState(!1),[N,h]=n.useState(0),[s,o]=n.useState(0),[p,d]=n.useState(!!r),[S,_]=n.useState(0),[U,D]=n.useState(0),[O,Q]=n.useState(0),[V,ce]=n.useState(!1),[w,J]=n.useState(r?.payments||[]),[Y,X]=n.useState(!1),[y,B]=n.useState(null),[ee,ie]=n.useState(!1),se=["Bratislava","Košice","Žilina","Trnava","Nitra","Banská Bystrica","Prešov","Trenčín"],[te,K]=n.useState(""),[oe,re]=n.useState(!1),[we,Pe]=n.useState(""),[xe,ye]=n.useState(se),[Se,Fe]=n.useState(!1),[ue,Ie]=n.useState(null),[ot,Re]=n.useState(!1),[Ee,_e]=n.useState(null),[at,pt]=n.useState(!1),[ve,Me]=n.useState(null),xt=(f.customers||[]).map(a=>({label:a.name,id:a.id,customer:a})),Qe=f.vehicles.map(a=>({label:`${a.brand} ${a.model} (${a.licensePlate})${a.vin?` - VIN: ${a.vin.slice(-8)}`:""}`,id:a.id}));n.useEffect(()=>{if(r){d(!0),C({...r,isFlexible:r.isFlexible||!1,flexibleEndDate:r.flexibleEndDate});const a=r.extraKmCharge||0,v=r.totalPrice-a;T(v);let F=r.commission||0;if(!F||F===0){const W=f.vehicles.find(ne=>ne.id===r.vehicleId);W?.commission&&(r.customCommission?.value&&r.customCommission.value>0?r.customCommission.type==="percentage"?F=v*r.customCommission.value/100:F=r.customCommission.value:W.commission.type==="percentage"?F=v*W.commission.value/100:F=W.commission.value)}if(L(F),r.isFlexible&&(b(!0),A(r.totalPrice)),r.extraKmCharge&&h(r.extraKmCharge),r.allowedKilometers&&(o(r.allowedKilometers),r.startDate&&r.endDate)){const W=r.startDate instanceof Date?r.startDate:new Date(r.startDate),ne=r.endDate instanceof Date?r.endDate:new Date(r.endDate),me=zt(W,ne),ge=Math.round(r.allowedKilometers/me);ge*me===r.allowedKilometers&&_(ge)}if(r.extraKilometerRate!==void 0&&r.extraKilometerRate!==null&&D(r.extraKilometerRate),r.deposit&&Q(r.deposit),typeof r.paid=="boolean"&&ce(r.paid),r.handoverPlace&&K(r.handoverPlace),r.handoverPlace&&!se.includes(r.handoverPlace)&&ye(W=>[...W,r.handoverPlace]),r.payments&&J(r.payments),r.vehicleId){const W=f.vehicles.find(ne=>ne.id===r.vehicleId);Me(W||null)}if(r.customerId){const W=(f.customers||[]).find(ne=>ne.id===r.customerId);if(W)Ie(W);else if(r.customerName){const ne=(f.customers||[]).find(me=>me.name===r.customerName);ne&&(Ie(ne),C(me=>({...me,customerId:ne.id})))}}else if(r.customerName){const W=(f.customers||[]).find(ne=>ne.name===r.customerName);W&&(Ie(W),C(ne=>({...ne,customerId:W.id})))}}else Me(null)},[r,f.customers,f.vehicles]),n.useEffect(()=>{if(t.vehicleId){const a=f.vehicles.find(v=>v.id===t.vehicleId);a&&a.id!==ve?.id&&Me(a)}else ve&&Me(null)},[t.vehicleId,f.vehicles,ve?.id]);const ke=(a,v)=>{C(F=>({...F,[a]:v})),(a==="discount"||a==="customCommission")&&d(!1)},Je=a=>{Ie(a),C(a?v=>({...v,customerId:a.id,customerName:a.name}):v=>({...v,customerId:""}))},ft=()=>{Fe(!0)},Ve=async a=>{try{await k(a),Ie(a),C(v=>({...v,customerId:a.id,customerName:a.name})),Fe(!1)}catch(v){console.error("Chyba pri vytváraní zákazníka:",v)}},Ke=a=>{a&&window.open(`tel:${a}`,"_self")},kt=a=>{a&&window.open(`mailto:${a}`,"_self")},Ct=a=>{_e(a),Re(!0)},g=async a=>{try{pt(!0),await I(a),Ie(a),C(v=>({...v,customerId:a.id,customerName:a.name,customerEmail:a.email,customerPhone:a.phone})),await M(),Re(!1),_e(null),alert("Zákazník bol úspešne upravený!")}catch(v){console.error("Chyba pri aktualizácii zákazníka:",v),alert("Chyba pri aktualizácii zákazníka. Skúste to znovu.")}finally{pt(!1)}},E=async(a,v)=>{if(v&&!(f.customers||[]).find(W=>W.name.toLowerCase()===v.name.toLowerCase()||W.email===v.email))try{await k(v)}catch(W){console.error("Chyba pri vytváraní zákazníka z emailu:",W)}if(C(F=>({...F,...a,customerName:a.customerName||F.customerName,orderNumber:a.orderNumber||F.orderNumber})),a.vehicleId){const F=f.vehicles.find(W=>W.id===a.vehicleId);Me(F||null)}if(v){const F=(f.customers||[]).find(W=>W.name.toLowerCase()===v.name.toLowerCase()||W.email===v.email)||v;Ie(F),C(W=>({...W,customerId:F.id}))}a.totalPrice&&T(a.totalPrice),a.deposit&&Q(a.deposit),a.dailyKilometers&&_(a.dailyKilometers),a.extraKilometerRate&&D(a.extraKilometerRate),a.handoverPlace&&(K(a.handoverPlace),xe.includes(a.handoverPlace)||ye(F=>[...F,a.handoverPlace])),alert("Dáta z emailu boli úspešne načítané do formulára!")};n.useEffect(()=>{if(S>0&&t.startDate&&t.endDate){const a=t.startDate instanceof Date?t.startDate:new Date(t.startDate),v=t.endDate instanceof Date?t.endDate:new Date(t.endDate),F=zt(a,v),W=S*F;o(W)}},[S,t.startDate,t.endDate]),n.useEffect(()=>{if(p&&!t.discount&&!t.customCommission)return;if(p&&(t.discount||t.customCommission)&&d(!1),!t.vehicleId||!t.startDate||!t.endDate){T(0),L(0);return}const a=f.vehicles.find($e=>$e.id===t.vehicleId);if(!a){p||(T(0),L(0));return}const v=t.startDate instanceof Date?t.startDate:new Date(t.startDate||""),F=t.endDate instanceof Date?t.endDate:new Date(t.endDate||""),W=new Date(v.getFullYear(),v.getMonth(),v.getDate()),ne=new Date(F.getFullYear(),F.getMonth(),F.getDate()),me=xo(ne,W),ge=Math.max(1,me),Lt=a.pricing?.find($e=>ge>=$e.minDays&&ge<=$e.maxDays);if(Lt&&a.pricing&&a.pricing.length>0){let $e=ge*Lt.pricePerDay,wt=0;t.discount?.value&&t.discount.value>0&&(t.discount.type==="percentage"?wt=$e*t.discount.value/100:wt=t.discount.value);let mo=N>0?N:0;const Wt=Math.max(0,$e-wt);T(Wt);const Ot=Wt+mo;let rt=0;t.customCommission?.value&&t.customCommission.value>0?t.customCommission.type==="percentage"?rt=Ot*t.customCommission.value/100:rt=t.customCommission.value:a.commission.type==="percentage"?rt=Ot*a.commission.value/100:rt=a.commission.value,L(rt)}else T(0),L(0)},[t.vehicleId,t.startDate,t.endDate,t.discount,N,t.customCommission,f.vehicles,p]);const Z=()=>{B({id:Te(),date:new Date,amount:0,isPaid:!1,paymentMethod:"cash",note:"",invoiceNumber:""}),X(!0)},ae=a=>{B(a),X(!0)},Ce=a=>{J(v=>v.filter(F=>F.id!==a))},fe=a=>{J(v=>v.find(W=>W.id===a.id)?v.map(W=>W.id===a.id?a:W):[...v,a]),X(!1),B(null)},Le=async a=>{if(a.preventDefault(),z)return;const v=t.vehicleId?f.vehicles.find(me=>me.id===t.vehicleId):void 0;if(!t.customerName?.trim()){alert("Meno zákazníka je povinné");return}if(!t.vehicleId?.trim()){alert("Výber vozidla je povinný");return}if(t.isFlexible){if(!t.flexibleEndDate){alert("Pre flexibilný prenájom je potrebné zadať odhadovaný dátum vrátenia");return}if(!t.endDate){const me=new Date(t.flexibleEndDate),ge=new Date(me.getTime()+365*24*60*60*1e3);t.endDate=ge}}else if(!t.endDate){alert("Dátum ukončenia je povinný pre štandardný prenájom");return}let F=ue,W=t.customerId;if(t.customerName&&!t.customerId){const me=(f.customers||[]).find(ge=>ge.name===t.customerName);if(me)F=me,W=me.id;else{const ge={id:Te(),name:t.customerName,email:"",phone:"",createdAt:new Date};await k(ge),F=ge,W=ge.id}}if(t.isPrivateRental)try{await We.createVehicleUnavailability({vehicleId:t.vehicleId||"",startDate:t.startDate||new Date,endDate:t.endDate||new Date,reason:`Súkromný prenájom: ${t.customerName}`,type:"private_rental",notes:`Prenájom mimo BlackRent platformy. Zákazník: ${t.customerName}. ${te?`Miesto: ${te}`:""}`,priority:2}),window.location.reload();return}catch(me){console.error("Chyba pri vytváraní súkromného prenájmu:",me),alert("Chyba pri vytváraní súkromného prenájmu");return}const ne={id:r?.id||Te(),vehicleId:t.vehicleId||void 0,vehicle:v,customerId:W||void 0,customer:F||void 0,customerName:t.customerName||"",startDate:t.startDate||new Date,endDate:t.endDate||new Date,totalPrice:t.isFlexible&&u&&l!==void 0?l:R+N,commission:j,paymentMethod:t.paymentMethod||"cash",createdAt:r?.createdAt||new Date,discount:t.discount?.value&&t.discount.value>0?t.discount:void 0,customCommission:t.customCommission?.value&&t.customCommission.value>0?t.customCommission:void 0,extraKmCharge:N>0?N:void 0,allowedKilometers:s>0?s:void 0,extraKilometerRate:U!==void 0?U:void 0,deposit:O>0?O:void 0,paid:V,status:r?.status||"pending",handoverPlace:te.trim()||void 0,payments:w,orderNumber:t.orderNumber||"",isFlexible:t.isFlexible||!1,flexibleEndDate:t.flexibleEndDate};P(ne)};return f.vehicles.filter(a=>a.status==="available"),e.jsxs(i,{component:"form",onSubmit:Le,sx:{mt:2,opacity:z?.6:1,pointerEvents:z?"none":"auto"},children:[e.jsx(va,{onParseSuccess:E,vehicles:f.vehicles,customers:f.customers||[]}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:3},children:[e.jsx(De,{fullWidth:!0,children:e.jsx($t,{options:Qe,getOptionLabel:a=>a.label,value:Qe.find(a=>a.id===t.vehicleId)||null,onChange:(a,v)=>{const F=v?v.id:"";if(ke("vehicleId",F),F){const W=f.vehicles.find(ne=>ne.id===F);Me(W||null)}else Me(null);d(!1)},renderInput:a=>e.jsx($,{...a,label:"Vozidlo",fullWidth:!0,required:!0})})}),ve&&e.jsxs(i,{sx:{gridColumn:"1 / -1",mt:1},children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Informácie o vozidle:"}),e.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(G,{label:`Majiteľ: ${ve.company}`,color:"primary",variant:"outlined"}),e.jsx(G,{label:`ŠPZ: ${ve.licensePlate}`,color:"secondary",variant:"outlined"}),ve.vin&&e.jsx(G,{label:`VIN: ${ve.vin}`,color:"default",variant:"outlined",sx:{fontFamily:"monospace",fontSize:"0.75rem"}}),e.jsx(G,{label:`Provízia: ${ve.commission.type==="percentage"?ve.commission.value+"%":ve.commission.value+"€"}`,color:"info",variant:"outlined"})]}),e.jsx(x,{variant:"body2",color:"success.main",sx:{mt:1,fontWeight:"bold"},children:"✓ Platba automaticky nastavená priamo majiteľovi vozidla"})]}),e.jsx($,{fullWidth:!0,label:"Meno zákazníka",value:t.customerName||"",onChange:a=>{const v=a.target.value;C(W=>({...W,customerName:v}));const F=(f.customers||[]).find(W=>W.name===v);F?Je(F):(C(W=>({...W,customerId:""})),Ie(null))},placeholder:"Zadajte meno zákazníka alebo vyberte z existujúcich",helperText:t.customerId?"Vybraný zákazník z existujúcich":"Ak zákazník neexistuje, bude automaticky vytvorený pri uložení",required:!0}),e.jsx($t,{fullWidth:!0,options:[...xt,{label:"+ Pridať nového zákazníka",id:"__add_new__",customer:null}],value:ue?{label:ue.name,id:ue.id,customer:ue}:null,onChange:(a,v)=>{if(v?.id==="__add_new__"){ft();return}Je(v?.customer||null)},getOptionLabel:a=>a.label,isOptionEqualToValue:(a,v)=>a.id===v.id,filterOptions:(a,{inputValue:v})=>a.filter(W=>W.label.toLowerCase().includes(v.toLowerCase())),renderInput:a=>e.jsx($,{...a,label:"Výber z existujúcich zákazníkov",placeholder:"Začnite písať meno zákazníka...",helperText:"Píšte pre vyhľadávanie alebo vyberte zo zoznamu"}),renderOption:(a,v)=>n.createElement("li",{...a,key:v.id},v.id==="__add_new__"?e.jsx("em",{style:{color:"#1976d2"},children:v.label}):v.label),noOptionsText:"Žiadni zákazníci nenájdení"}),ue&&e.jsxs(i,{sx:{gridColumn:"1 / -1",mt:1},children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Kontaktné údaje:"}),e.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[ue.phone&&e.jsx(G,{icon:e.jsx(na,{}),label:ue.phone,onClick:()=>Ke(ue.phone),clickable:!0,color:"primary"}),ue.email&&e.jsx(G,{icon:e.jsx(ca,{}),label:ue.email,onClick:()=>kt(ue.email),clickable:!0,color:"primary"}),e.jsx(q,{variant:"outlined",size:"small",onClick:()=>Ct(ue),sx:{ml:1},children:"Upraviť zákazníka"}),e.jsx(q,{variant:"outlined",size:"small",onClick:()=>{c({type:"UPDATE_CUSTOMER",payload:ue}),alert("Zákazník bol úspešne uložený!")},sx:{ml:1},children:"Uložiť zákazníka"})]})]}),t.customerName&&!ue&&e.jsxs(i,{sx:{gridColumn:"1 / -1",mt:1},children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Nový zákazník:"}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:[t.customerName," - bude automaticky vytvorený pri uložení prenájmu"]})]}),e.jsx($,{fullWidth:!0,label:"Číslo objednávky",value:t.orderNumber||"",onChange:a=>C(v=>({...v,orderNumber:a.target.value})),InputLabelProps:{shrink:!0},required:!1}),e.jsxs(De,{fullWidth:!0,children:[e.jsx(Ne,{children:"Spôsob platby"}),e.jsxs(Ae,{value:t.paymentMethod||"cash",label:"Spôsob platby",onChange:a=>ke("paymentMethod",a.target.value),children:[e.jsx(de,{value:"cash",children:"Hotovosť"}),e.jsx(de,{value:"bank_transfer",children:"Bankový prevod"}),e.jsx(de,{value:"vrp",children:"VRP"}),e.jsx(de,{value:"direct_to_owner",children:"Priamo majiteľovi"})]})]}),e.jsx(Pt,{label:"Dátum a čas od *",value:t.startDate?new Date(t.startDate):null,onChange:a=>{ke("startDate",a),d(!1)},ampm:!1,slots:{textField:$},slotProps:{textField:{fullWidth:!0,required:!0}}}),e.jsx(Pt,{label:t.isFlexible?"Dátum a čas do (voliteľné)":"Dátum a čas do *",value:t.endDate?new Date(t.endDate):null,onChange:a=>{ke("endDate",a),d(!1)},ampm:!1,slots:{textField:$},slotProps:{textField:{fullWidth:!0,required:!t.isFlexible,helperText:t.isFlexible?"Pre flexibilný prenájom môžete nechať prázdne":void 0}}}),e.jsx(i,{sx:{gridColumn:"1 / -1",mt:2,mb:2},children:e.jsxs(he,{variant:"outlined",sx:{p:2,bgcolor:t.isFlexible?"warning.light":"background.paper",border:t.isFlexible?"2px solid":"1px solid",borderColor:t.isFlexible?"warning.main":"divider",boxShadow:t.isFlexible?3:1},children:[e.jsxs(x,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:["🔄 Flexibilný prenájom",e.jsx(G,{label:t.isFlexible?"AKTÍVNY":"ŠTANDARDNÝ",color:t.isFlexible?"warning":"default",size:"small"})]}),e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{item:!0,xs:12,children:e.jsxs(De,{fullWidth:!0,children:[e.jsx(Ne,{children:"Typ prenájmu"}),e.jsxs(Ae,{value:t.isFlexible?"flexible":"standard",onChange:a=>{const F=a.target.value==="flexible";ke("isFlexible",F),F?(b(!0),l===void 0&&A(R||0),ke("endDate",void 0)):b(!1)},label:"Typ prenájmu",children:[e.jsx(de,{value:"standard",children:"🔒 Štandardný prenájom"}),e.jsx(de,{value:"flexible",children:"🔄 Flexibilný prenájom"})]})]})}),e.jsxs(pe,{item:!0,xs:12,children:[e.jsx(fo,{control:e.jsx(go,{checked:t.isPrivateRental||!1,onChange:a=>ke("isPrivateRental",a.target.checked),color:"secondary"}),label:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{variant:"body2",children:"🔒 Súkromný prenájom (mimo BlackRent platformy)"}),e.jsx(G,{label:"FIALOVÁ FARBA",size:"small",sx:{bgcolor:"#9c27b0",color:"white",fontSize:"0.7rem"}})]})}),e.jsx(x,{variant:"caption",color:"text.secondary",sx:{display:"block",ml:4},children:"Prenájom sa zobrazí vo fialovej farbe v dostupnosti a nebude sa počítať do štatistík platformy"})]}),t.isFlexible&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{item:!0,xs:12,md:6,children:e.jsx(Pt,{label:"Odhadovaný dátum a čas vrátenia",value:t.flexibleEndDate?new Date(t.flexibleEndDate):null,onChange:a=>{ke("flexibleEndDate",a)},ampm:!1,slots:{textField:$},slotProps:{textField:{fullWidth:!0,helperText:"Orientačný dátum ukončenia pre flexibilný prenájom"}}})}),e.jsx(pe,{item:!0,xs:12,children:e.jsxs(he,{variant:"outlined",sx:{p:2,bgcolor:"background.default"},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,sx:{fontWeight:"bold"},children:"💰 Cenotvorba pre flexibilný prenájom"}),e.jsxs(De,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ne,{children:"Typ cenotvorby"}),e.jsxs(Ae,{value:u?"manual":"automatic",onChange:a=>{const v=a.target.value==="manual";b(v),v&&l===void 0&&A(R||0)},label:"Typ cenotvorby",children:[e.jsx(de,{value:"automatic",children:"🤖 Automatická (štandardná)"}),e.jsx(de,{value:"manual",children:"✋ Manuálna (individuálna)"})]})]}),u&&e.jsx($,{fullWidth:!0,label:"Manuálna cena",type:"number",value:l||"",onChange:a=>{const v=parseFloat(a.target.value)||0;A(v)},InputProps:{endAdornment:"€"},helperText:"Zadajte individuálnu cenu pre tento flexibilný prenájom"}),!u&&e.jsxs(x,{variant:"body2",color:"text.secondary",children:["Automatická cena: ",e.jsxs("strong",{children:[R||0,"€"]})]})]})})]})]})]})}),e.jsxs(De,{fullWidth:!0,children:[e.jsx(Ne,{children:"Miesto odovzdania vozidla"}),e.jsxs(Ae,{value:te,label:"Miesto odovzdania vozidla",onChange:a=>K(a.target.value),children:[xe.map(a=>e.jsx(de,{value:a,children:a},a)),e.jsx(de,{value:"__add_new__",onClick:()=>re(!0),children:e.jsx("em",{children:"+ Pridať nové miesto"})})]}),oe&&e.jsxs(i,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx($,{autoFocus:!0,size:"small",label:"Nové miesto",value:we,onChange:a=>Pe(a.target.value)}),e.jsx(q,{variant:"contained",size:"small",disabled:!we.trim(),onClick:()=>{ye(a=>[...a,we.trim()]),K(we.trim()),Pe(""),re(!1)},children:"Pridať"}),e.jsx(q,{variant:"outlined",size:"small",onClick:()=>{re(!1),Pe("")},children:"Zrušiť"})]})]}),e.jsx($,{fullWidth:!0,label:"Denné kilometry",type:"number",value:S,onChange:a=>{const v=Number(a.target.value)||0;_(v),v>0||o(0)},InputProps:{endAdornment:e.jsx("span",{style:{marginLeft:8},children:"km/deň"})},placeholder:"250",helperText:"Automaticky sa prepočítajú na celkové km podľa dĺžky prenájmu",sx:{"& .MuiOutlinedInput-root":{backgroundColor:S>0?"#e8f5e8":"inherit"}}}),e.jsx($,{fullWidth:!0,label:S>0?"Celkové kilometry (automaticky)":"Celkové kilometry",type:"number",value:s,onChange:a=>{S>0||o(Number(a.target.value)||0)},InputProps:{endAdornment:e.jsx("span",{style:{marginLeft:8},children:"km"}),readOnly:S>0},placeholder:"0 = neobmedzené",helperText:S>0?`Automaticky: ${S} km/deň × ${t.startDate&&t.endDate?(()=>{const a=t.startDate instanceof Date?t.startDate:new Date(t.startDate),v=t.endDate instanceof Date?t.endDate:new Date(t.endDate);return zt(a,v)})():"?"} dní`:"0 znamená neobmedzené kilometry",sx:{"& .MuiOutlinedInput-root":{backgroundColor:S>0?"#f5f5f5":"inherit"}}}),e.jsx($,{fullWidth:!0,label:"Cena za extra km (€)",type:"number",value:U,onChange:a=>{const v=a.target.value.replace(",",".");D(Number(v)||0)},InputProps:{startAdornment:e.jsx("span",{style:{marginRight:8},children:"€"}),endAdornment:e.jsx("span",{style:{marginLeft:8},children:"/ km"}),inputProps:{step:.1}},placeholder:"0",helperText:"Cena za každý kilometer nad povolený limit"}),e.jsx($,{fullWidth:!0,label:"Výška depozitu (€)",type:"number",value:O,onChange:a=>Q(Number(a.target.value)||0),InputProps:{startAdornment:e.jsx("span",{style:{marginRight:8},children:"€"})},placeholder:"0"}),e.jsx(De,{fullWidth:!0,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",height:"100%"},children:[e.jsx("input",{type:"checkbox",checked:V,onChange:a=>ce(a.target.checked),id:"paid-checkbox",style:{marginRight:8}}),e.jsx("label",{htmlFor:"paid-checkbox",children:"Prenájom uhradený"})]})})]}),e.jsx(i,{sx:{gridColumn:"1 / -1",mt:3},children:e.jsx(he,{children:e.jsxs(je,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Výpočet ceny"}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:2},children:[e.jsxs(i,{children:[e.jsxs(x,{children:["Základná cena: ",e.jsxs("strong",{children:[(R||0).toFixed(2)," €"]})]}),N>0&&e.jsxs(x,{color:"warning.main",children:["Doplatok za km: ",e.jsxs("strong",{children:["+",N.toFixed(2)," €"]})]}),e.jsxs(x,{variant:"h6",color:"primary",children:["Celková cena: ",e.jsxs("strong",{children:[((R||0)+N).toFixed(2)," €"]})]})]}),e.jsxs(x,{children:["Provízia: ",e.jsxs("strong",{children:[(j||0).toFixed(2)," €"]})]})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(x,{variant:"subtitle1",sx:{flexGrow:1},children:"Zľava / Provízia"}),e.jsx(le,{onClick:()=>ie(a=>!a),children:ee?e.jsx(aa,{}):e.jsx(ea,{})})]}),ee&&e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",gap:1,mb:1},children:[e.jsxs(De,{sx:{minWidth:80},size:"small",children:[e.jsx(Ne,{children:"Zľava"}),e.jsxs(Ae,{value:t.discount?.type||"",label:"Zľava",onChange:a=>ke("discount",{...t.discount,type:a.target.value}),children:[e.jsx(de,{value:"percentage",children:"%"}),e.jsx(de,{value:"fixed",children:"€"})]})]}),e.jsx($,{label:"Hodnota",type:"number",value:t.discount?.value||"",onChange:a=>ke("discount",{...t.discount,value:Number(a.target.value)}),size:"small",sx:{maxWidth:100}})]}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:1},children:[e.jsxs(De,{sx:{minWidth:120},size:"small",children:[e.jsx(Ne,{children:"Provízia"}),e.jsxs(Ae,{value:t.customCommission?.type||"",label:"Provízia",onChange:a=>ke("customCommission",{...t.customCommission,type:a.target.value}),children:[e.jsx(de,{value:"percentage",children:"%"}),e.jsx(de,{value:"fixed",children:"€"})]})]}),e.jsx($,{label:"Hodnota",type:"number",value:t.customCommission?.value||"",onChange:a=>ke("customCommission",{...t.customCommission,value:Number(a.target.value)}),size:"small",sx:{maxWidth:100}})]})]}),e.jsxs(i,{sx:{mt:2,display:"flex",gap:2,alignItems:"center"},children:[e.jsx(x,{children:"Doplatok za km (€):"}),e.jsx($,{type:"number",size:"small",value:N,onChange:a=>h(Number(a.target.value)),sx:{width:120},inputProps:{min:0}})]})]})})}),e.jsx(i,{sx:{gridColumn:"1 / -1",mt:3},children:e.jsx(he,{children:e.jsxs(je,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Platby (splátky)"}),e.jsx(q,{variant:"outlined",onClick:Z,sx:{mb:2},children:"Pridať platbu"}),w.length===0?e.jsx(x,{color:"text.secondary",children:"Žiadne platby"}):e.jsxs(i,{component:"table",sx:{width:"100%",borderCollapse:"collapse"},children:[e.jsx(i,{component:"thead",children:e.jsxs(i,{component:"tr",children:[e.jsx(i,{component:"th",children:"Dátum"}),e.jsx(i,{component:"th",children:"Suma (€)"}),e.jsx(i,{component:"th",children:"Stav"}),e.jsx(i,{component:"th",children:"Spôsob platby"}),e.jsx(i,{component:"th",children:"Faktúra"}),e.jsx(i,{component:"th",children:"Poznámka"}),e.jsx(i,{component:"th",children:"Akcie"})]})}),e.jsx(i,{component:"tbody",children:w.map(a=>e.jsxs(i,{component:"tr",children:[e.jsx(i,{component:"td",children:new Date(a.date).toLocaleDateString()}),e.jsx(i,{component:"td",children:(a.amount||0).toFixed(2)}),e.jsx(i,{component:"td",children:a.isPaid?"Zaplatené":"Nezaplatené"}),e.jsx(i,{component:"td",children:a.paymentMethod}),e.jsx(i,{component:"td",children:a.invoiceNumber}),e.jsx(i,{component:"td",children:a.note}),e.jsxs(i,{component:"td",children:[e.jsx(q,{size:"small",onClick:()=>ae(a),children:"Upraviť"}),e.jsx(q,{size:"small",color:"error",onClick:()=>Ce(a.id),children:"Vymazať"})]})]},a.id))})]})]})})}),Y&&e.jsx(i,{sx:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",bgcolor:"rgba(0,0,0,0.3)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(he,{sx:{minWidth:320},children:e.jsxs(je,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:y?.id?"Upraviť platbu":"Pridať platbu"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx($,{label:"Dátum",type:"date",value:y?.date?new Date(y.date).toISOString().split("T")[0]:"",onChange:a=>B(v=>v?{...v,date:new Date(a.target.value)}:null),InputLabelProps:{shrink:!0}}),e.jsx($,{label:"Suma (€)",type:"number",value:y?.amount||"",onChange:a=>B(v=>v?{...v,amount:Number(a.target.value)}:null)}),e.jsxs(De,{children:[e.jsx(Ne,{children:"Spôsob platby"}),e.jsxs(Ae,{value:y?.paymentMethod||"cash",label:"Spôsob platby",onChange:a=>B(v=>v?{...v,paymentMethod:a.target.value}:null),children:[e.jsx(de,{value:"cash",children:"Hotovosť"}),e.jsx(de,{value:"bank_transfer",children:"Bankový prevod"}),e.jsx(de,{value:"vrp",children:"VRP"}),e.jsx(de,{value:"direct_to_owner",children:"Priamo majiteľovi"})]})]}),e.jsx($,{label:"Faktúra",value:y?.invoiceNumber||"",onChange:a=>B(v=>v?{...v,invoiceNumber:a.target.value}:null)}),e.jsx($,{label:"Poznámka",value:y?.note||"",onChange:a=>B(v=>v?{...v,note:a.target.value}:null)}),e.jsxs(De,{children:[e.jsx(Ne,{children:"Stav"}),e.jsxs(Ae,{value:y?.isPaid?"paid":"unpaid",label:"Stav",onChange:a=>B(v=>v?{...v,isPaid:a.target.value==="paid"}:null),children:[e.jsx(de,{value:"paid",children:"Zaplatené"}),e.jsx(de,{value:"unpaid",children:"Nezaplatené"})]})]})]}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:3},children:[e.jsx(q,{variant:"outlined",onClick:()=>{X(!1),B(null)},children:"Zrušiť"}),e.jsx(q,{variant:"contained",onClick:()=>y&&fe(y),children:"Uložiť"})]})]})})}),ot&&Ee&&e.jsx(i,{sx:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",bgcolor:"rgba(0,0,0,0.5)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(2px)"},onClick:a=>{a.target===a.currentTarget&&(Re(!1),_e(null))},onKeyDown:a=>{a.key==="Escape"&&(Re(!1),_e(null))},children:e.jsxs(i,{sx:{bgcolor:"background.paper",borderRadius:2,p:3,minWidth:400,maxWidth:500,maxHeight:"90vh",overflow:"auto",boxShadow:24,transform:"scale(1)",transition:"all 0.2s ease-in-out"},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(x,{variant:"h6",children:["Upraviť zákazníka: ",Ee.name]}),e.jsx(le,{onClick:()=>{Re(!1),_e(null)},sx:{color:"grey.500"},children:e.jsx(tt,{})})]}),e.jsxs(i,{component:"form",onSubmit:a=>{a.preventDefault();const v=a.currentTarget,F=new FormData(v),W=F.get("name"),ne=F.get("email"),me=F.get("phone");if(!W?.trim()){alert("Meno zákazníka je povinné");return}const ge={...Ee,name:W.trim(),email:ne?.trim()||"",phone:me?.trim()||""};g(ge)},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2,mb:3},children:[e.jsx($,{fullWidth:!0,name:"name",label:"Meno zákazníka",defaultValue:Ee.name,required:!0}),e.jsx($,{fullWidth:!0,name:"email",label:"Email",type:"email",defaultValue:Ee.email}),e.jsx($,{fullWidth:!0,name:"phone",label:"Telefón",defaultValue:Ee.phone})]}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(q,{variant:"outlined",onClick:()=>{Re(!1),_e(null)},children:"Zrušiť"}),e.jsx(q,{type:"submit",variant:"contained",disabled:at,startIcon:at?e.jsx(jt,{size:20}):void 0,children:at?"Ukladám...":"Uložiť zmeny"})]})]})]})}),Se&&e.jsx(i,{sx:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",bgcolor:"rgba(0,0,0,0.3)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs(i,{sx:{bgcolor:"background.paper",borderRadius:2,p:3,minWidth:320,maxWidth:500},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Nový zákazník"}),e.jsxs(i,{component:"form",onSubmit:a=>{a.preventDefault();const v=a.currentTarget,F=new FormData(v),W=F.get("name"),ne=F.get("email"),me=F.get("phone");if(!W?.trim()){alert("Meno zákazníka je povinné");return}const ge={id:Te(),name:W.trim(),email:ne?.trim()||"",phone:me?.trim()||"",createdAt:new Date};Ve(ge)},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2,mb:3},children:[e.jsx($,{fullWidth:!0,name:"name",label:"Meno zákazníka",required:!0}),e.jsx($,{fullWidth:!0,name:"email",label:"Email",type:"email"}),e.jsx($,{fullWidth:!0,name:"phone",label:"Telefón"})]}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(q,{variant:"outlined",onClick:()=>Fe(!1),children:"Zrušiť"}),e.jsx(q,{type:"submit",variant:"contained",children:"Pridať zákazníka"})]})]})]})}),e.jsxs(i,{sx:{gridColumn:"1 / -1",display:"flex",gap:2,justifyContent:"flex-end",mt:3},children:[e.jsx(q,{variant:"outlined",onClick:m,disabled:z,children:"Zrušiť"}),e.jsxs(q,{type:"submit",variant:"contained",disabled:z,children:[z&&e.jsx(jt,{size:20,color:"inherit",sx:{mr:1}}),z?"Ukladá sa...":r?"Uložiť zmeny":"Vytvoriť prenájom"]})]})]})}function ya({open:r,onClose:P,protocolId:m,protocolType:z,title:f="Zobraziť protokol"}){const[c,k]=n.useState(!1),[I,M]=n.useState(null),[t,C]=n.useState(null),[R,T]=n.useState(null),j=async()=>{k(!0),M(null);try{const h=`${ht()}/protocols/${z}/${m}`,s=await fetch(h);if(s.ok){const p=await s.json();if(T(p),p.pdfUrl){C(p.pdfUrl);return}}else{const p=await s.text()}const o=L();C(o)}catch(N){console.error("❌ Error loading protocol data:",N);const h=L();C(h)}finally{k(!1)}},L=()=>`${ht()}/protocols/${z}/${m}/pdf`,l=()=>R?.pdfUrl?R.pdfUrl:`${ht()}/protocols/${z}/${m}/download`,A=async()=>{await j()},u=()=>{const N=l(),h=document.createElement("a");h.href=N,h.download=`${z}_protocol_${m.slice(-8)}.pdf`,document.body.appendChild(h),h.click(),document.body.removeChild(h)},b=()=>{const N=t||L();window.open(N,"_blank")};return ze.useEffect(()=>{r&&!t&&A()},[r]),e.jsxs(Ue,{open:r,onClose:P,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[e.jsxs(He,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",backgroundColor:"primary.main",color:"white"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Tt,{}),e.jsxs(x,{variant:"h6",children:[f," - ",z==="handover"?"Prevzatie":"Vrátenie"," vozidla"]})]}),e.jsx(le,{onClick:P,sx:{color:"white"},children:e.jsx(tt,{})})]}),e.jsxs(Be,{sx:{p:0,position:"relative"},children:[c&&e.jsxs(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",flexDirection:"column",gap:2},children:[e.jsx(jt,{}),e.jsx(x,{children:"Načítavam PDF..."})]}),I&&e.jsx(i,{sx:{p:2},children:e.jsx(et,{severity:"error",children:I})}),t&&!c&&e.jsx("iframe",{src:t,style:{width:"100%",height:"100%",border:"none",minHeight:"500px"},title:"PDF Viewer"})]}),e.jsxs(vo,{sx:{p:2,backgroundColor:"background.default"},children:[e.jsx(q,{variant:"outlined",startIcon:e.jsx(co,{}),onClick:u,disabled:c,children:"Stiahnuť PDF"}),e.jsx(q,{variant:"outlined",startIcon:e.jsx(Bo,{}),onClick:b,disabled:c,children:"Otvoriť v novom okne"}),e.jsx(q,{variant:"contained",onClick:P,children:"Zavrieť"})]})]})}function ja({open:r,onClose:P,images:m,videos:z,title:f="Galéria protokolu"}){const[c,k]=n.useState(0),[I,M]=n.useState(!1),[t,C]=n.useState(1);n.useEffect(()=>{H.debug("🔍 ProtocolGallery received:",{open:r,imagesCount:m?.length||0,videosCount:z?.length||0,title:f,images:m?.slice(0,3).map(h=>({id:h.id,type:h.type,url:h.url?.substring(0,50)+"..."})),videos:z?.slice(0,2).map(h=>({id:h.id,type:h.type,url:h.url?.substring(0,50)+"..."}))})},[r,m,z,f,I]);const R=[...m||[],...z||[]],T=R.length,j=R[c];n.useEffect(()=>{C(1)},[c]);const L=()=>{k(h=>h===0?T-1:h-1)},l=()=>{k(h=>h===T-1?0:h+1)},A=h=>{if(r)switch(h.key){case"ArrowLeft":L();break;case"ArrowRight":l();break;case"Escape":P();break;case"+":case"=":C(s=>Math.min(s+.25,3));break;case"-":C(s=>Math.max(s-.25,.5));break}};n.useEffect(()=>(document.addEventListener("keydown",A),()=>document.removeEventListener("keydown",A)),[r,P,L,l,C]);const u=h=>{try{if(!h)return console.warn("⚠️ getProxyUrl: URL is undefined or null"),"";if(h.includes("r2.dev")||h.includes("cloudflare.com")){const o=h.split("/").slice(3).join("/");return`${ht()}/files/proxy/${encodeURIComponent(o)}`}return h}catch(s){return console.error("❌ Error converting to proxy URL:",s),h||""}},b=async()=>{if(!j||!j.url){console.warn("⚠️ handleDownload: currentMedia or URL is missing"),alert("Nepodarilo sa stiahnuť súbor - chýba URL");return}try{const h=u(j.url);if(!h){alert("Nepodarilo sa stiahnuť súbor - neplatné URL");return}const o=await(await fetch(h)).blob(),p=window.URL.createObjectURL(o),d=document.createElement("a");d.href=p,d.download=`protocol-media-${c+1}.${j.url.includes("video")?"mp4":"jpg"}`,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(p)}catch(h){console.error("Chyba pri sťahovaní:",h),alert("Nepodarilo sa stiahnuť súbor")}},N=h=>{k(h),M(!0)};return r?e.jsxs(e.Fragment,{children:[e.jsxs(Ue,{open:r&&!I,onClose:(h,s)=>{console.trace("🔍 Dialog close stack trace:"),!(s==="backdropClick"||s==="escapeKeyDown")&&P()},maxWidth:"lg",fullWidth:!0,disableEscapeKeyDown:!0,BackdropProps:{onClick:h=>{h.stopPropagation()}},PaperProps:{sx:{backgroundColor:"rgba(0, 0, 0, 0.9)",color:"white",minHeight:"80vh"}},children:[e.jsxs(He,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid rgba(255, 255, 255, 0.2)"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Et,{}),e.jsxs(x,{variant:"h6",children:[f," (",T," položiek)"]})]}),e.jsx(le,{onClick:P,sx:{color:"white"},children:e.jsx(tt,{})})]}),e.jsx(Be,{sx:{p:2},children:T===0?e.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"200px"},children:e.jsx(x,{variant:"h6",color:"rgba(255, 255, 255, 0.7)",children:"Žiadne médiá na zobrazenie"})}):e.jsxs(pe,{container:!0,spacing:2,children:[m.map((h,s)=>e.jsx(pe,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(i,{sx:{position:"relative",borderRadius:2,overflow:"hidden",cursor:"pointer",border:"2px solid transparent",transition:"all 0.2s ease","&:hover":{borderColor:"primary.main",transform:"scale(1.02)"}},onClick:()=>N(s),children:[h.url?e.jsx("img",{src:u(h.url),alt:h.description||`Obrázok ${s+1}`,style:{width:"100%",height:"200px",objectFit:"cover",display:"block"},onError:o=>{console.error("❌ Chyba načítania obrázka:",h.url),o.target.style.display="none"},onLoad:()=>{}}):e.jsx(i,{sx:{width:"100%",height:"200px",backgroundColor:"rgba(255, 255, 255, 0.1)",display:"flex",alignItems:"center",justifyContent:"center",border:"2px dashed rgba(255, 255, 255, 0.3)"},children:e.jsx(x,{variant:"body2",color:"rgba(255, 255, 255, 0.5)",children:"Chýba URL"})}),e.jsxs(i,{sx:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent, rgba(0,0,0,0.8))",p:1},children:[e.jsx(x,{variant:"caption",color:"white",children:h.description||`Obrázok ${s+1}`}),e.jsx(G,{label:h.type,size:"small",sx:{ml:1,backgroundColor:"rgba(255,255,255,0.2)",color:"white"}})]})]})},h.id||s)),z.map((h,s)=>e.jsx(pe,{item:!0,xs:12,sm:6,md:4,lg:3,children:e.jsxs(i,{sx:{position:"relative",borderRadius:2,overflow:"hidden",cursor:"pointer",border:"2px solid transparent",transition:"all 0.2s ease","&:hover":{borderColor:"primary.main",transform:"scale(1.02)"}},onClick:()=>N(m.length+s),children:[h.url?e.jsx("video",{src:u(h.url),style:{width:"100%",height:"200px",objectFit:"cover",display:"block"},onError:o=>{console.error("Chyba načítania videa:",h.url),o.target.style.display="none"}}):e.jsx(i,{sx:{width:"100%",height:"200px",backgroundColor:"rgba(255, 255, 255, 0.1)",display:"flex",alignItems:"center",justifyContent:"center",border:"2px dashed rgba(255, 255, 255, 0.3)"},children:e.jsx(x,{variant:"body2",color:"rgba(255, 255, 255, 0.5)",children:"Chýba URL"})}),e.jsx(i,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:48,height:48,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Ao,{sx:{color:"white",fontSize:24}})}),e.jsxs(i,{sx:{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(transparent, rgba(0,0,0,0.8))",p:1},children:[e.jsx(x,{variant:"caption",color:"white",children:h.description||`Video ${s+1}`}),e.jsx(G,{label:h.type,size:"small",sx:{ml:1,backgroundColor:"rgba(255,255,255,0.2)",color:"white"}})]})]})},h.id||`video-${s}`))]})})]}),e.jsxs(Ue,{open:I,onClose:()=>M(!1),maxWidth:!1,fullScreen:!0,PaperProps:{sx:{backgroundColor:"rgba(0, 0, 0, 0.95)",color:"white"}},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2,borderBottom:"1px solid rgba(255, 255, 255, 0.2)"},children:[e.jsx(x,{variant:"h6",children:j?.description||`Médium ${c+1}`}),e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx(le,{onClick:()=>C(h=>Math.max(h-.25,.5)),sx:{color:"white"},disabled:t<=.5,children:e.jsx(Ht,{sx:{transform:"scaleX(-1)"}})}),e.jsx(le,{onClick:()=>C(h=>Math.min(h+.25,3)),sx:{color:"white"},disabled:t>=3,children:e.jsx(Ht,{})}),e.jsx(le,{onClick:b,sx:{color:"white"},children:e.jsx(co,{})}),e.jsx(le,{onClick:()=>M(!1),sx:{color:"white"},children:e.jsx(tt,{})})]})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"calc(100vh - 120px)",p:2,position:"relative"},children:[T>1&&e.jsxs(e.Fragment,{children:[e.jsx(le,{onClick:L,sx:{position:"absolute",left:16,top:"50%",transform:"translateY(-50%)",backgroundColor:"rgba(0,0,0,0.5)",color:"white","&:hover":{backgroundColor:"rgba(0,0,0,0.7)"}},children:e.jsx($o,{})}),e.jsx(le,{onClick:l,sx:{position:"absolute",right:16,top:"50%",transform:"translateY(-50%)",backgroundColor:"rgba(0,0,0,0.5)",color:"white","&:hover":{backgroundColor:"rgba(0,0,0,0.7)"}},children:e.jsx(Ho,{})})]}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",width:"100%",height:"100%"},children:j&&e.jsx(e.Fragment,{children:c<m.length?j.url?e.jsx("img",{src:u(j.url),alt:j.description||"Obrázok",style:{maxWidth:`${100*t}%`,maxHeight:`${100*t}%`,objectFit:"contain",transition:"transform 0.2s ease"},onError:h=>{console.error("Chyba načítania obrázka:",j.url),h.target.style.display="none"}}):e.jsx(i,{sx:{textAlign:"center",color:"rgba(255, 255, 255, 0.5)"},children:e.jsx(x,{variant:"h6",children:"Chýba URL obrázka"})}):j.url?e.jsx("video",{src:u(j.url),controls:!0,style:{maxWidth:`${100*t}%`,maxHeight:`${100*t}%`},onError:h=>{console.error("Chyba načítania videa:",j.url),h.target.style.display="none"}}):e.jsx(i,{sx:{textAlign:"center",color:"rgba(255, 255, 255, 0.5)"},children:e.jsx(x,{variant:"h6",children:"Chýba URL videa"})})})})]}),T>1&&e.jsx(i,{sx:{p:2,textAlign:"center",borderTop:"1px solid rgba(255, 255, 255, 0.2)"},children:e.jsxs(x,{variant:"body2",color:"rgba(255, 255, 255, 0.7)",children:[c+1," z ",T]})})]})]}):null}function ka({open:r,onClose:P,rental:m,handoverProtocol:z,onSave:f}){const{state:c}=bo(),[k,I]=n.useState(!1),[M,t]=n.useState(null),[C,R]=n.useState(null),[T,j]=n.useState(!1),[L,l]=n.useState(null),[A,u]=n.useState(!1),[b,N]=n.useState(null),[h,s]=n.useState(0),[o,p]=n.useState({location:"",odometer:z?.vehicleCondition?.odometer||void 0,fuelLevel:100,fuelType:z?.vehicleCondition?.fuelType||"gasoline",exteriorCondition:"Dobrý",interiorCondition:"Dobrý",notes:"",vehicleImages:[],documentImages:[],damageImages:[],vehicleVideos:[],documentVideos:[],damageVideos:[],signatures:[]}),[d,S]=n.useState({kilometersUsed:0,kilometerOverage:0,kilometerFee:0,fuelUsed:0,fuelFee:0,totalExtraFees:0,depositRefund:0,additionalCharges:0,finalRefund:0});n.useEffect(()=>{_()},[o.odometer,o.fuelLevel,b]);const _=()=>{const y=o.odometer||0,B=z?.vehicleCondition?.odometer||0,ee=m.allowedKilometers||0,ie=m.extraKilometerRate||.5,se=m.deposit||0,te=b!==null?b:ie;h===0&&ie>0&&s(ie);const K=Math.max(0,y-B),oe=ee>0?Math.max(0,K-ee):0,re=oe*te,we=z?.vehicleCondition?.fuelLevel||100,Pe=o.fuelLevel,xe=Math.max(0,we-Pe),ye=xe*.02,Se=re+ye,Fe=Math.max(0,se-Se),ue=Math.max(0,Se-se);S({kilometersUsed:K,kilometerOverage:oe,kilometerFee:re,fuelUsed:xe,fuelFee:ye,totalExtraFees:Se,depositRefund:Fe,additionalCharges:ue,finalRefund:Fe})},U=()=>{u(!0),N(b!==null?b:m.extraKilometerRate||.5)},D=()=>{u(!1)},O=()=>{u(!1),N(null)},Q=y=>{const B=parseFloat(y);!isNaN(B)&&B>=0&&N(B)};if(!r)return null;if(!z)return console.error("❌ ReturnProtocolForm: handoverProtocol is undefined"),e.jsxs(i,{sx:{p:3},children:[e.jsx(et,{severity:"error",children:"Chyba: Odovzdávací protokol nebol nájdený. Prosím, zatvorte a skúste to znovu."}),e.jsx(q,{onClick:P,sx:{mt:2},children:"Zatvoriť"})]});const V=(y,B)=>{p(ee=>({...ee,[y]:B}))},ce=(y,B,ee)=>{p(ie=>({...ie,[`${y}Images`]:B,[`${y}Videos`]:ee})),R(null)},w=(y,B)=>{l({name:y,role:B}),j(!0)},J=y=>{p(B=>({...B,signatures:[...B.signatures,y]})),j(!1),l(null)},Y=y=>{p(B=>({...B,signatures:B.signatures.filter(ee=>ee.id!==y)}))},X=async()=>{if(!o.location){console.warn("❌ Validation: Miesto vrátenia nie je vyplnené");return}try{if(I(!0),t({status:"pending",message:"Odosielam protokol a email..."}),!z){console.error("❌ handoverProtocol is undefined - cannot create return protocol");return}const y={id:Te(),rentalId:m.id,rental:m,handoverProtocolId:z.id,handoverProtocol:z,type:"return",status:"completed",createdAt:new Date,completedAt:new Date,location:o.location,vehicleCondition:{odometer:o.odometer||0,fuelLevel:o.fuelLevel,fuelType:o.fuelType,exteriorCondition:o.exteriorCondition,interiorCondition:o.interiorCondition,notes:o.notes||""},vehicleImages:o.vehicleImages||[],vehicleVideos:o.vehicleVideos||[],documentImages:o.documentImages||[],documentVideos:o.documentVideos||[],damageImages:o.damageImages||[],damageVideos:o.damageVideos||[],damages:[],newDamages:[],signatures:[],kilometersUsed:d.kilometersUsed,kilometerOverage:d.kilometerOverage,kilometerFee:d.kilometerFee,fuelUsed:d.fuelUsed,fuelFee:d.fuelFee,totalExtraFees:d.totalExtraFees,depositRefund:d.depositRefund,additionalCharges:d.additionalCharges,finalRefund:d.finalRefund,rentalData:{orderNumber:m.orderNumber||"",vehicle:m.vehicle||{},customer:{id:m.customerId||"",name:m.customerName||"",email:m.customer?.email||m.customerEmail||"",phone:m.customer?.phone||m.customerPhone||"",createdAt:m.customer?.createdAt||new Date},startDate:m.startDate,endDate:m.endDate,totalPrice:m.totalPrice,deposit:m.deposit||0,currency:"EUR",allowedKilometers:m.allowedKilometers||0,extraKilometerRate:m.extraKilometerRate||.5,pickupLocation:m.pickupLocation||m.handoverPlace,returnLocation:m.returnLocation,returnConditions:m.returnConditions},pdfUrl:"",emailSent:!1,notes:`${o.notes||""}

Cena za km: ${b!==null?b:m.extraKilometerRate||.5}€/km${b!==null?" (upravené)":" (cenník)"}`.trim(),createdBy:c.user?`${c.user.firstName||""} ${c.user.lastName||""}`.trim()||c.user.username:"admin"},B={...y,rental:y.rental?{...y.rental,vehicleImages:void 0,vehicleVideos:void 0,documentImages:void 0,damageImages:void 0}:void 0,handoverProtocol:y.handoverProtocol?{id:y.handoverProtocol.id,rentalId:y.handoverProtocol.rentalId,type:y.handoverProtocol.type,status:y.handoverProtocol.status,location:y.handoverProtocol.location,createdAt:y.handoverProtocol.createdAt,completedAt:y.handoverProtocol.completedAt,vehicleCondition:y.handoverProtocol.vehicleCondition,vehicleImages:void 0,vehicleVideos:void 0,documentImages:void 0,damageImages:void 0,damages:y.handoverProtocol.damages||[],signatures:o.signatures,rentalData:y.handoverProtocol.rentalData,pdfUrl:y.handoverProtocol.pdfUrl,emailSent:y.handoverProtocol.emailSent,notes:y.handoverProtocol.notes,createdBy:y.handoverProtocol.createdBy}:void 0,vehicleImages:(y.vehicleImages||[]).map(K=>({id:K.id,url:K.url,type:K.type,mediaType:K.mediaType,description:K.description||"",timestamp:K.timestamp})),vehicleVideos:(y.vehicleVideos||[]).map(K=>({id:K.id,url:K.url,type:K.type,mediaType:K.mediaType,description:K.description||"",timestamp:K.timestamp})),documentImages:(y.documentImages||[]).map(K=>({id:K.id,url:K.url,type:K.type,mediaType:K.mediaType,description:K.description||"",timestamp:K.timestamp})),damageImages:(y.damageImages||[]).map(K=>({id:K.id,url:K.url,type:K.type,mediaType:K.mediaType,description:K.description||"",timestamp:K.timestamp}))},ee=ht(),ie=localStorage.getItem("blackrent_token")||sessionStorage.getItem("blackrent_token"),se=await fetch(`${ee}/protocols/return`,{method:"POST",headers:{"Content-Type":"application/json",...ie&&{Authorization:`Bearer ${ie}`}},body:JSON.stringify(B)});if(!se.ok){const K=await se.text();throw console.error("❌ API Response Error:",se.status,K),new Error(`API error: ${se.status} - ${K}`)}const te=await se.json();te&&te.email?te.email.sent?t({status:"success",message:`✅ Protokol bol úspešne odoslaný na email ${te.email.recipient}`}):te.email.error?t({status:"error",message:`❌ Protokol bol uložený, ale email sa nepodarilo odoslať: ${te.email.error}`}):t({status:"warning",message:"⚠️ Protokol bol uložený, ale email sa nepodarilo odoslať (problém s PDF úložiskom)"}):t({status:"success",message:"✅ Protokol bol úspešne uložený"}),te&&te.protocol&&f(te.protocol),setTimeout(()=>{P()},4e3)}catch(y){console.error("❌ Error saving return protocol:",y),t({status:"error",message:`❌ Nastala chyba: ${y instanceof Error?y.message:"Unknown error"}`})}finally{I(!1)}};return e.jsxs(i,{sx:{width:"100%",maxWidth:"100%"},children:[(k||M?.status==="pending")&&e.jsxs(i,{sx:{mb:2},children:[e.jsx(Kt,{}),e.jsx(x,{variant:"body2",sx:{mt:1,textAlign:"center"},children:k?"⚡ Ukladám protokol...":M?.message})]}),M&&M.status!=="pending"&&e.jsx(et,{severity:M.status==="success"?"success":M.status==="warning"?"warning":"error",sx:{mb:2,position:"sticky",top:0,zIndex:1e3,animation:"fadeIn 0.3s ease-in"},children:M.message}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(i,{children:[e.jsxs(x,{variant:"h5",color:"text.primary",children:["Preberací protokol - ",m.vehicle?.licensePlate||"Vozidlo"]}),(m.vehicleVin||m.vehicle?.vin)&&e.jsxs(x,{variant:"caption",sx:{color:"#888",fontFamily:"monospace",display:"block"},children:["VIN: ",m.vehicleVin||m.vehicle?.vin]})]}),e.jsx(le,{onClick:P,size:"large",children:e.jsx(tt,{})})]}),k&&e.jsxs(i,{sx:{mb:2},children:[e.jsx(Kt,{}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Ukladám protokol..."})]}),z&&e.jsxs(et,{severity:"info",sx:{mb:3},children:["Navzäuje na odovzdávací protokol #",z.id?.slice(-8)||"N/A"," z ",z.createdAt?new Date(z.createdAt).toLocaleString("sk-SK"):"N/A"]}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:[e.jsx(so,{sx:{mr:1,verticalAlign:"middle"}}),"Informácie o vozidle"]}),e.jsxs(pe,{container:!0,spacing:2,children:[e.jsxs(pe,{item:!0,xs:12,sm:6,md:6,children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Značka a model"}),e.jsxs(x,{variant:"body1",color:"text.primary",sx:{fontWeight:"bold"},children:[m.vehicle?.brand," ",m.vehicle?.model]})]}),e.jsxs(pe,{item:!0,xs:12,sm:6,md:6,children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"ŠPZ"}),e.jsx(G,{label:m.vehicle?.licensePlate||"Neuvedené",color:"secondary",variant:"outlined",sx:{fontWeight:"bold"}})]}),(m.vehicleVin||m.vehicle?.vin)&&e.jsxs(pe,{item:!0,xs:12,sm:6,md:6,children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"VIN číslo"}),e.jsx(G,{label:m.vehicleVin||m.vehicle?.vin||"Neuvedené",color:"default",variant:"outlined",sx:{fontWeight:"bold",fontFamily:"monospace",fontSize:"0.75rem"}})]}),e.jsxs(pe,{item:!0,xs:12,sm:6,md:6,children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Stav vozidla"}),e.jsx(G,{label:m.vehicle?.status||"available",color:m.vehicle?.status==="available"?"success":"warning",variant:"outlined"})]})]})]})}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:[e.jsx(Eo,{sx:{mr:1,verticalAlign:"middle"}}),"Základné informácie"]}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(300px, 1fr))",gap:2},children:[e.jsx($,{label:"Miesto vrátenia *",value:o.location,onChange:y=>V("location",y.target.value),fullWidth:!0,required:!0}),e.jsx($,{label:"Poznámky",value:o.notes,onChange:y=>V("notes",y.target.value),fullWidth:!0,multiline:!0,rows:2})]})]})}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:[e.jsx(Mo,{sx:{mr:1,verticalAlign:"middle"}}),"Stav vozidla pri vrátení"]}),z?.vehicleCondition&&e.jsxs(et,{severity:"info",sx:{mb:2},children:["Pri preberaní: ",z.vehicleCondition.odometer||"N/A"," km, ",z.vehicleCondition.fuelLevel||"N/A","% paliva"]}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:2},children:[e.jsx($,{label:"Aktuálny stav tachometra (km)",type:"number",value:o.odometer||"",onChange:y=>V("odometer",y.target.value?parseInt(y.target.value):void 0),fullWidth:!0}),e.jsx($,{label:"Úroveň paliva (%)",type:"number",value:o.fuelLevel,onChange:y=>V("fuelLevel",parseInt(y.target.value)||100),inputProps:{min:0,max:100},fullWidth:!0}),e.jsx($,{label:"Stav exteriéru",value:o.exteriorCondition,onChange:y=>V("exteriorCondition",y.target.value),fullWidth:!0}),e.jsx($,{label:"Stav interiéru",value:o.interiorCondition,onChange:y=>V("interiorCondition",y.target.value),fullWidth:!0})]})]})}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:[e.jsx(Ko,{sx:{mr:1,verticalAlign:"middle"}}),"Prepočet poplatkov (automaticky)"]}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:2},children:[e.jsx($,{label:"Povolený nájazd km",value:`${m.allowedKilometers||0} km`,InputProps:{readOnly:!0},color:"info",fullWidth:!0}),e.jsx($,{label:"Najazdené km",value:d.kilometersUsed,InputProps:{readOnly:!0},fullWidth:!0}),e.jsx($,{label:"Prekročenie km",value:d.kilometerOverage,InputProps:{readOnly:!0},color:d.kilometerOverage>0?"warning":"primary",fullWidth:!0}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($,{label:"Poplatok za km",value:`${(d.kilometerFee||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:d.kilometerFee>0?"warning":"primary",fullWidth:!0}),e.jsx(le,{onClick:U,size:"small",color:"primary",title:"Upraviť cenu za km",sx:{minWidth:40,bgcolor:b!==null?"warning.light":"transparent","&:hover":{bgcolor:"primary.light"}},children:e.jsx(io,{fontSize:"small"})})]}),A&&e.jsxs(i,{sx:{p:2,border:"2px solid",borderColor:"warning.main",borderRadius:1,bgcolor:"warning.light",mt:1},children:[e.jsx(x,{variant:"subtitle2",sx:{mb:1,fontWeight:"bold"},children:"⚠️ Úprava ceny za prekročené km"}),e.jsxs(x,{variant:"body2",sx:{mb:2,color:"text.secondary"},children:["Cenníková sadzba: ",e.jsxs("strong",{children:[h.toFixed(2)," €/km"]}),e.jsx("br",{}),"Prekročené km: ",e.jsxs("strong",{children:[d.kilometerOverage," km"]})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($,{label:"Nová cena za km (€)",type:"number",value:b||"",onChange:y=>Q(y.target.value),inputProps:{min:0,step:.01,style:{textAlign:"center"}},size:"small",sx:{width:150}}),e.jsx(le,{onClick:D,size:"small",color:"success",title:"Potvrdiť zmenu",children:e.jsx(Nt,{})}),e.jsx(le,{onClick:O,size:"small",color:"error",title:"Zrušiť úpravu",children:e.jsx(Lo,{})})]}),e.jsxs(x,{variant:"caption",sx:{display:"block",mt:1,fontStyle:"italic"},children:["💡 Nový poplatok: ",d.kilometerOverage," km × ",(b||0).toFixed(2)," €/km = ",(d.kilometerOverage*(b||0)||0).toFixed(2)," €"]})]}),e.jsx($,{label:"Spotrebované palivo (%)",value:d.fuelUsed,InputProps:{readOnly:!0},fullWidth:!0}),e.jsx($,{label:"Poplatok za palivo",value:`${(d.fuelFee||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:d.fuelFee>0?"warning":"primary",fullWidth:!0}),e.jsx($,{label:"Celkové poplatky",value:`${(d.totalExtraFees||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:d.totalExtraFees>0?"warning":"primary",fullWidth:!0})]}),e.jsx(Xe,{sx:{my:2}}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:2},children:[e.jsx($,{label:"Vratenie z depozitu",value:`${(d.depositRefund||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:"success",fullWidth:!0}),e.jsx($,{label:"Doplatok",value:`${(d.additionalCharges||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:d.additionalCharges>0?"error":"primary",fullWidth:!0}),e.jsx($,{label:"Finálny refund",value:`${(d.finalRefund||0).toFixed(2)} EUR`,InputProps:{readOnly:!0},color:"success",fullWidth:!0})]})]})}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsxs(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:[e.jsx(bt,{sx:{mr:1,verticalAlign:"middle"}}),"Fotodokumentácia"]}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:2},children:[e.jsxs(q,{variant:"outlined",startIcon:e.jsx(bt,{}),onClick:()=>R("vehicle"),size:"large",children:["Fotky vozidla (",o.vehicleImages.length,")"]}),e.jsxs(q,{variant:"outlined",startIcon:e.jsx(bt,{}),onClick:()=>R("document"),size:"large",children:["Dokumenty (",o.documentImages.length,")"]}),e.jsxs(q,{variant:"outlined",startIcon:e.jsx(bt,{}),onClick:()=>R("damage"),size:"large",children:["Poškodenia (",o.damageImages.length,")"]})]})]})}),e.jsx(he,{sx:{mb:3,backgroundColor:"background.paper"},children:e.jsxs(je,{children:[e.jsx(x,{variant:"h6",color:"text.primary",sx:{mb:2},children:"✍️ Elektronické podpisy s časovou pečiatkou"}),o.signatures.length>0&&e.jsx(i,{sx:{mb:2},children:o.signatures.map((y,B)=>e.jsx(he,{variant:"outlined",sx:{mb:1,p:2},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{component:"img",src:y.signature,alt:`Podpis ${y.signerName}`,sx:{width:120,height:60,border:"1px solid #ddd",borderRadius:1,objectFit:"contain"}}),e.jsxs(i,{children:[e.jsx(x,{variant:"subtitle2",fontWeight:"bold",children:y.signerName}),e.jsx(x,{variant:"body2",color:"text.secondary",children:y.signerRole==="customer"?"Zákazník":"Zamestnanec"}),e.jsxs(x,{variant:"caption",color:"text.secondary",children:["📅 ",new Date(y.timestamp).toLocaleString("sk-SK")]}),e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["📍 ",y.location]})]})]}),e.jsx(le,{onClick:()=>Y(y.id),color:"error",size:"small",children:e.jsx(tt,{})})]})},y.id))}),e.jsxs(i,{sx:{display:"flex",gap:2,flexWrap:"wrap"},children:[e.jsx(q,{variant:"outlined",onClick:()=>w(m.customer?.name||m.customerName||"Zákazník","customer"),startIcon:e.jsx(Ut,{}),children:"Podpis zákazníka"}),e.jsx(q,{variant:"outlined",onClick:()=>w(`${c.user?.firstName||""} ${c.user?.lastName||""}`.trim()||"Zamestnanec","employee"),startIcon:e.jsx(Ut,{}),children:"Podpis zamestnanca"})]})]})}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:3},children:[e.jsx(q,{variant:"outlined",onClick:P,disabled:k,children:"Zrušiť"}),e.jsx(q,{variant:"contained",startIcon:e.jsx(yo,{}),onClick:X,disabled:k,children:k?"Ukladám...":"Uložiť protokol"})]}),C&&e.jsx(To,{open:!0,onClose:()=>R(null),onSave:(y,B)=>ce(C,y,B),title:`Fotky - ${C}`,allowedTypes:["vehicle","document","damage"],entityId:m.id,protocolType:"return",mediaType:C,category:{vehicle:"vehicle_photos",document:"documents",damage:"damages"}[C]||"other"}),T&&L&&e.jsx(i,{sx:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999,p:2},children:e.jsx(i,{sx:{backgroundColor:"white",borderRadius:2,maxWidth:600,width:"100%",maxHeight:"90vh",overflow:"auto"},children:e.jsx(jo,{onSave:J,onCancel:()=>j(!1),signerName:L.name,signerRole:L.role,location:o.location})})})]})}const Ca=ze.lazy(()=>ko(()=>import("./HandoverProtocolForm-CShMIDxU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))),wa=({openDialog:r,openHandoverDialog:P,openReturnDialog:m,openProtocolMenu:z,pdfViewerOpen:f,galleryOpen:c,editingRental:k,selectedRentalForProtocol:I,selectedProtocolType:M,selectedPdf:t,galleryImages:C,galleryVideos:R,galleryTitle:T,protocols:j,setOpenDialog:L,setOpenHandoverDialog:l,setOpenReturnDialog:A,handleSave:u,handleCancel:b,handleSaveHandover:N,handleSaveReturn:h,handleClosePDF:s,handleCloseGallery:o,handleCloseProtocolMenu:p,handleDownloadPDF:d,handleViewGallery:S})=>e.jsxs(e.Fragment,{children:[e.jsxs(Ue,{open:r,onClose:()=>L(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(He,{children:k?"Upraviť prenájom":"Nový prenájom"}),e.jsx(Be,{children:e.jsx(ba,{rental:k,onSave:u,onCancel:b})})]}),e.jsxs(Ue,{open:P,onClose:()=>{l(!1)},maxWidth:"lg",fullWidth:!0,children:[e.jsx(He,{children:"Odovzdávací protokol"}),e.jsx(Be,{children:I&&e.jsx(ze.Suspense,{fallback:e.jsxs(i,{sx:{display:"flex",justifyContent:"center",p:4},children:[e.jsx(jt,{}),e.jsx(x,{sx:{ml:2},children:"Načítavam protokol..."})]}),children:e.jsx(Ca,{open:P,rental:I,onSave:N,onClose:()=>{l(!1)}})})})]}),e.jsxs(Ue,{open:m,onClose:()=>A(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsx(He,{children:"Preberací protokol"}),e.jsx(Be,{children:I&&e.jsx(ka,{open:m,onClose:()=>A(!1),rental:I,handoverProtocol:j[I.id]?.handover,onSave:h})})]}),t&&e.jsx(ya,{open:f,onClose:s,protocolId:t.url,protocolType:t.type,title:t.title}),e.jsx(ja,{open:c,onClose:o,images:C,videos:R,title:T}),e.jsxs(Ue,{open:z,onClose:p,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(He,{sx:{bgcolor:"primary.main",color:"white",display:"flex",alignItems:"center",gap:1},children:[M==="handover"?"🚗→":"←🚗",M==="handover"?"Odovzdávací protokol":"Preberací protokol"]}),e.jsx(Be,{sx:{p:{xs:2,sm:3}},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:{xs:1.5,sm:2}},children:[e.jsx(q,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Tt,{}),onClick:d,sx:{bgcolor:"#f44336",py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"},fontWeight:600,borderRadius:2,boxShadow:"0 4px 12px rgba(244,67,54,0.3)","&:hover":{bgcolor:"#d32f2f",transform:"translateY(-2px)",boxShadow:"0 6px 16px rgba(244,67,54,0.4)"},transition:"all 0.2s ease"},children:"📄 Stiahnuť PDF protokol"}),e.jsx(q,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Et,{}),onClick:S,sx:{bgcolor:"#2196f3",py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"},fontWeight:600,borderRadius:2,boxShadow:"0 4px 12px rgba(33,150,243,0.3)","&:hover":{bgcolor:"#1976d2",transform:"translateY(-2px)",boxShadow:"0 6px 16px rgba(33,150,243,0.4)"},transition:"all 0.2s ease"},children:"🖼️ Zobraziť fotky"}),e.jsx(q,{fullWidth:!0,variant:"outlined",onClick:p,sx:{py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"},fontWeight:500,borderRadius:2,borderWidth:2,"&:hover":{borderWidth:2,bgcolor:"rgba(0,0,0,0.04)"}},children:"Zavrieť"})]})})]})]}),Sa=({isMobile:r,handleAdd:P})=>e.jsx(i,{sx:{display:"flex",gap:{xs:1,md:2},mb:3,mx:{xs:1,md:0},flexWrap:"wrap",alignItems:"center"},children:e.jsx(q,{variant:"contained",startIcon:e.jsx(Co,{}),onClick:P,sx:{minWidth:{xs:"auto",md:"140px"},fontSize:{xs:"0.8rem",md:"0.875rem"},px:{xs:2,md:3},py:{xs:1,md:1.5},borderRadius:2,textTransform:"none",fontWeight:600,boxShadow:"0 4px 12px rgba(25,118,210,0.3)"},children:r?"Pridať":"Nový prenájom"})}),Da=({filteredRentals:r,state:P,isMobile:m,setImportError:z})=>{const f=n.useRef(null),c=n.useCallback(I=>{const M=j=>{const L=j.totalPrice;return j.customCommission?.value&&j.customCommission.value>0?j.customCommission.type==="percentage"?L*j.customCommission.value/100:j.customCommission.value:j.vehicle?.commission?j.vehicle.commission.type==="percentage"?L*j.vehicle.commission.value/100:j.vehicle.commission.value:j.commission||0},t=["id","licensePlate","company","brand","model","customerName","customerEmail","startDate","endDate","totalPrice","commission","paymentMethod","discountType","discountValue","customCommissionType","customCommissionValue","extraKmCharge","paid","handoverPlace","confirmed"],C=I.map(j=>[j.id,j.vehicle?.licensePlate||"",j.vehicle?.company||"",j.vehicle?.brand||"",j.vehicle?.model||"",j.customerName,j.customer?.email||"",(()=>{const L=j.startDate instanceof Date?j.startDate:new Date(j.startDate);return isNaN(L.getTime())?String(j.startDate):L.toISOString()})(),(()=>{const L=j.endDate instanceof Date?j.endDate:new Date(j.endDate);return isNaN(L.getTime())?String(j.endDate):L.toISOString()})(),j.totalPrice,M(j),j.paymentMethod,j.discount?.type||"",j.discount?.value??"",j.customCommission?.type||"",j.customCommission?.value??"",j.extraKmCharge??"",j.paid?"1":"0",j.handoverPlace||"",j.confirmed?"1":"0"]),R=[t,...C].map(j=>j.map(L=>'"'+String(L).replace(/"/g,'""')+'"').join(",")).join(`
`),T=new Blob([R],{type:"text/csv;charset=utf-8;"});Wo.saveAs(T,"prenajmy.csv")},[]),k=n.useCallback(I=>{const M=I.target.files?.[0];M&&Oo.parse(M,{header:!0,skipEmptyLines:!0,complete:async t=>{try{const C=[],R=[],T=[],j=[],L=[];for(const l of t.data){H.debug("Processing CSV row",{rowIndex:t.data.indexOf(l)});const A=l.customerName||"Neznámy zákazník",u=l.customerEmail||"";let b=P.customers.find(w=>w.name.toLowerCase()===A.toLowerCase()||u&&w.email===u);if(!b&&A!=="Neznámy zákazník"){const w=Y=>Y.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(),J=w(A);b=P.customers.find(Y=>{const y=w(Y.name||"")===J;return y})}if(!b&&(b=T.find(w=>w.name.toLowerCase()===A.toLowerCase()||u&&w.email===u),!b&&A!=="Neznámy zákazník")){const w=Y=>Y.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(),J=w(A);b=T.find(Y=>w(Y.name||"")===J)}if(!b&&A!=="Neznámy zákazník")try{const w={id:Te(),name:A,email:u,phone:"",address:"",notes:"",createdAt:new Date};await We.createCustomer(w),T.push(w),H.info("Customer created during import",{customerName:A})}catch(w){H.error("Failed to create customer during import",{customerName:A,error:w})}const N=l.company||"Neznáma firma";let h=P.companies.find(w=>w.name.toLowerCase()===N.toLowerCase());if(h||(h=j.find(w=>w.name.toLowerCase()===N.toLowerCase())),!h&&N!=="Neznáma firma")try{const w={id:Te(),name:N,address:"",phone:"",email:"",commissionRate:20,isActive:!0,createdAt:new Date};await We.createCompany(w),j.push(w),H.info("Company created during import",{companyName:N})}catch(w){H.error("Failed to create company during import",{companyName:N,error:w})}const s=l.licensePlate;if(!s){H.warn("Missing license plate, skipping row",{rowIndex:t.data.indexOf(l)});continue}let o=P.vehicles.find(w=>w.licensePlate.toLowerCase()===s.toLowerCase());if(o||(o=R.find(w=>w.licensePlate.toLowerCase()===s.toLowerCase())),!o)try{const w=h||j.find(Y=>Y.name.toLowerCase()===N.toLowerCase());if(!w){H.warn("Missing company for vehicle, skipping",{licensePlate:s});continue}const J={id:Te(),licensePlate:s,brand:l.brand||"Neznáma značka",model:l.model||"Neznámy model",companyId:w.id,company:w.name,year:new Date().getFullYear(),fuelType:"benzín",transmission:"manuál",seats:5,dailyRate:Number(l.totalPrice)||50,commission:{type:"percentage",value:20},pricing:[],status:"available",notes:""};await We.createVehicle(J),R.push(J),H.info("Vehicle created during import",{licensePlate:s,brand:l.brand,model:l.model})}catch(w){H.error("Failed to create vehicle during import",{licensePlate:s,error:w});continue}const p=w=>{if(!w)return new Date;if(w.includes("-")||w.includes("T")){const X=new Date(w);if(!isNaN(X.getTime()))return new Date(Date.UTC(X.getFullYear(),X.getMonth(),X.getDate()))}let J=w.trim();J.endsWith(".")&&(J=J.slice(0,-1));const Y=J.split(".");if(Y.length===2){const X=Number(Y[0]),y=Number(Y[1])-1;if(X>=1&&X<=31&&y>=0&&y<=11)return new Date(Date.UTC(2025,y,X))}else if(Y.length===3){const X=Number(Y[0]),y=Number(Y[1])-1,B=Number(Y[2]);if(X>=1&&X<=31&&y>=0&&y<=11&&B>=1900&&B<=2100)return new Date(Date.UTC(B,y,X))}return console.warn(`Nepodarilo sa parsovať dátum: "${w}", používam dnešný dátum`),new Date};let d=b||T.find(w=>w.name.toLowerCase()===A.toLowerCase()||u&&w.email===u);if(!d&&A!=="Neznámy zákazník"){const w=Y=>Y.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(),J=w(A);d=[...P.customers,...T].find(Y=>w(Y.name||"")===J)}let S=l.paymentMethod||"cash";o&&!l.paymentMethod&&(S="direct_to_owner",H.info("Auto-assigned direct payment to vehicle owner",{licensePlate:o.licensePlate,company:o.company}));const _=(()=>{const w=Number(l.totalPrice)||0;return l.commission&&Number(l.commission)>0?Number(l.commission):l.customCommissionType&&l.customCommissionValue?l.customCommissionType==="percentage"?w*Number(l.customCommissionValue)/100:Number(l.customCommissionValue):o?.commission?o.commission.type==="percentage"?w*o.commission.value/100:o.commission.value:0})();!l.commission&&o?.commission&&H.info("Auto-calculated commission for vehicle",{licensePlate:o.licensePlate,commission:_,type:o.commission.type,value:o.commission.value}),o&&H.debug("Vehicle assigned to rental",{licensePlate:o.licensePlate,owner:o.company});const U=p(l.startDate),D=p(l.endDate);if(P.rentals.find(w=>{if(o?.id&&w.vehicleId===o.id){const J=new Date(w.startDate),Y=new Date(w.endDate);if(J.toDateString()===U.toDateString()&&Y.toDateString()===D.toDateString())return!0}return!1})){H.warn("Duplicate rental detected, skipping",{licensePlate:o?.licensePlate,startDate:U.toLocaleDateString(),endDate:D.toLocaleDateString()});continue}const Q=l.totalPrice,V=Number(l.totalPrice)||0,ce={id:l.id||Te(),vehicleId:o?.id||void 0,vehicle:o,customerId:d?.id||void 0,customer:d,customerName:A,startDate:U,endDate:D,totalPrice:V,commission:_,paymentMethod:S,discount:l.discountType?{type:l.discountType,value:Number(l.discountValue)||0}:void 0,customCommission:l.customCommissionType?{type:l.customCommissionType,value:Number(l.customCommissionValue)||0}:void 0,extraKmCharge:Number(l.extraKmCharge)||0,paid:l.paid==="1"||l.paid===!0,handoverPlace:l.handoverPlace||"",confirmed:l.confirmed==="1"||l.confirmed===!0,status:"active",notes:"",createdAt:new Date};L.push(ce),H.debug("Rental prepared for batch import",{customer:A,licensePlate:o?.licensePlate,totalPrice:V,startDate:U.toLocaleDateString(),endDate:D.toLocaleDateString()})}if(L.length>0)try{H.info(`🚀 Starting batch import of ${L.length} rentals...`);const l=await We.batchImportRentals(L);H.info("✅ Batch import completed",{processed:l.processed,total:l.total,successRate:l.successRate,errors:l.errors.length}),l.errors.length>0&&H.warn("Batch import errors:",l.errors),C.push(...l.results)}catch(l){throw H.error("Batch import failed",{error:l}),l}H.info("CSV import completed successfully",{importedCount:C.length,totalRows:t.data.length}),z(""),window.location.reload()}catch(C){H.error("CSV import failed",{error:C}),z("Chyba pri importe CSV súboru")}f.current&&(f.current.value="")}})},[P,z]);return e.jsxs(i,{sx:{display:"flex",gap:{xs:1,md:2},mb:3,mx:{xs:1,md:0},flexWrap:"wrap",alignItems:"center"},children:[e.jsx(q,{variant:"outlined",startIcon:e.jsx(Uo,{}),onClick:()=>c(r),sx:{minWidth:{xs:"auto",md:"120px"},fontSize:{xs:"0.8rem",md:"0.875rem"},px:{xs:2,md:3},py:{xs:1,md:1.5},borderRadius:2,display:{xs:"none",md:"inline-flex"}},children:"Export CSV"}),e.jsx(q,{variant:"outlined",startIcon:e.jsx(Vo,{}),onClick:()=>f.current?.click(),sx:{minWidth:{xs:"auto",md:"120px"},fontSize:{xs:"0.8rem",md:"0.875rem"},px:{xs:2,md:3},py:{xs:1,md:1.5},borderRadius:2,display:{xs:"none",md:"inline-flex"}},children:"Import CSV"}),e.jsx("input",{type:"file",accept:".csv",hidden:!0,onChange:k,ref:f})]})},Pa=({rentals:r,protocols:P={},isLoading:m=!1,onQuickFilter:z})=>{const f=At(),c=lo(f.breakpoints.down("md")),k=n.useMemo(()=>{const t=new Date,C=new Date;C.setDate(C.getDate()+1);const R=r.filter(p=>{const d=new Date(p.startDate),S=new Date(p.endDate);return(St(t,d)||st(d))&&(gt(t,S)||st(S))}),T=r.filter(p=>{const d=new Date(p.startDate),S=new Date(p.endDate);return st(d)||st(S)}),j=r.filter(p=>{const d=new Date(p.endDate);return Fo(d)}),L=r.filter(p=>{const d=new Date(p.startDate),S=new Date(p.endDate),_=new Date(t);_.setDate(t.getDate()+(7-t.getDay())),_.setHours(23,59,59,999);const U=St(d,t)&&gt(d,_),D=St(S,t)&&gt(S,_);return U||D}),l=r.filter(p=>{const d=new Date(p.endDate);return gt(d,t)&&!P[p.id]?.return}),A=r.filter(p=>{const d=new Date(p.createdAt);return st(d)}),u=r.filter(p=>!p.paid),b=r.filter(p=>p.status==="pending"||!p.confirmed),N=r.filter(p=>P[p.id]?.handover),h=r.filter(p=>P[p.id]?.return),s=r.reduce((p,d)=>p+(d.totalPrice||0),0),o=r.length>0?s/Math.max(r.length,1):0;return{total:r.length,active:R.length,todayActivity:T.length,tomorrowReturns:j.length,weekActivity:L.length,overdue:l.length,newToday:A.length,unpaid:u.length,pending:b.length,withHandover:N.length,withReturn:h.length,totalRevenue:s,avgDailyRevenue:o}},[r,P]),I=[{label:"Preterminované",value:k.overdue,color:k.overdue>0?"error":"success",urgent:k.overdue>0,filterType:"overdue",clickable:k.overdue>0},{label:"Dnes odovzdanie/vrátenie",value:k.todayActivity,color:k.todayActivity>0?"warning":"success",urgent:k.todayActivity>0,filterType:"todayActivity",clickable:k.todayActivity>0},{label:"Zajtra vrátenie",value:k.tomorrowReturns,color:k.tomorrowReturns>0?"warning":"success",urgent:k.tomorrowReturns>0,filterType:"tomorrowReturns",clickable:k.tomorrowReturns>0},{label:"Tento týždeň odovzdanie/vrátenie",value:k.weekActivity,color:"info",urgent:!1,filterType:"weekActivity",clickable:k.weekActivity>0},{label:"Nové dnes",value:k.newToday,color:"success",urgent:!1,filterType:"newToday",clickable:k.newToday>0},{label:"Aktívne prenájmy",value:k.active,color:"info",urgent:!1,filterType:"active",clickable:k.active>0},{label:"Nezaplatené",value:k.unpaid,color:k.unpaid>0?"warning":"success",urgent:k.unpaid>0,filterType:"unpaid",clickable:k.unpaid>0},{label:"Čakajúce",value:k.pending,color:k.pending>0?"warning":"success",urgent:k.pending>0,filterType:"pending",clickable:k.pending>0}],M=(t,C)=>{C>0&&z&&z(t)};return m?e.jsx(he,{sx:{mb:3,p:2},children:e.jsx(x,{variant:"h6",color:"text.secondary",children:"Načítavam štatistiky..."})}):e.jsx(he,{sx:{mb:3,mx:{xs:1,md:0},backgroundColor:"background.paper",boxShadow:"0 4px 20px rgba(0,0,0,0.08)",border:"1px solid rgba(0,0,0,0.06)",borderRadius:3},children:e.jsxs(je,{sx:{p:{xs:2,md:3}},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(x,{variant:"h5",fontWeight:"600",sx:{color:"primary.main",display:"flex",alignItems:"center",gap:1},children:"📊 Štatistiky prenájmov"}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:["Celkom: ",e.jsx("strong",{children:k.total})," prenájmov"]})]}),e.jsx(pe,{container:!0,spacing:.25,children:I.map((t,C)=>e.jsx(pe,{item:!0,xs:4,sm:3,md:2,lg:1.33,xl:1.2,children:e.jsx(he,{onClick:()=>M(t.filterType,t.value),sx:{background:t.urgent?`linear-gradient(135deg, ${f.palette[t.color].main}15 0%, ${f.palette[t.color].main}25 100%)`:`linear-gradient(135deg, ${f.palette[t.color].main}10 0%, ${f.palette[t.color].main}20 100%)`,border:`1px solid ${f.palette[t.color].main}30`,borderRadius:1,transition:"all 0.2s ease",cursor:t.clickable?"pointer":"default",minHeight:60,"&:hover":t.clickable?{transform:"translateY(-1px)",boxShadow:`0 4px 15px ${f.palette[t.color].main}30`}:{}},children:e.jsxs(je,{sx:{textAlign:"center",py:.25,px:.25,"&:last-child":{pb:.25}},children:[e.jsx(x,{variant:"h6",fontWeight:"700",sx:{color:`${t.color}.main`,fontSize:{xs:"0.9rem",sm:"1rem",md:"1.1rem"},lineHeight:1.1},children:t.value}),e.jsx(x,{variant:"caption",sx:{color:"text.secondary",fontSize:{xs:"0.55rem",sm:"0.6rem",md:"0.65rem"},display:"block",lineHeight:1,mt:.1},children:t.label}),t.clickable&&e.jsx(x,{variant:"caption",sx:{color:`${t.color}.main`,fontSize:{xs:"0.5rem",sm:"0.55rem"},mt:.1},children:"👆"})]})})},C))}),!c&&k.totalRevenue>0&&e.jsxs(e.Fragment,{children:[e.jsx(Xe,{sx:{my:2}}),e.jsxs(i,{sx:{display:"flex",justifyContent:"center",gap:4},children:[e.jsxs(i,{sx:{textAlign:"center"},children:[e.jsxs(x,{variant:"h6",fontWeight:"600",sx:{color:"success.main"},children:[k.totalRevenue.toLocaleString("sk-SK"),"€"]}),e.jsx(x,{variant:"caption",color:"text.secondary",children:"Celkové tržby"})]}),e.jsxs(i,{sx:{textAlign:"center"},children:[e.jsxs(x,{variant:"h6",fontWeight:"600",sx:{color:"info.main"},children:[Math.round(k.avgDailyRevenue).toLocaleString("sk-SK"),"€"]}),e.jsx(x,{variant:"caption",color:"text.secondary",children:"Priemerná cena"})]})]})]})]})})},za=({rentals:r,vehicles:P=[],protocols:m={}})=>{const[z,f]=n.useState(""),[c,k]=n.useState(""),[I,M]=n.useState(!1),[t,C]=n.useState({status:[],paymentMethod:[],company:[],dateFrom:"",dateTo:"",priceMin:"",priceMax:"",protocolStatus:[],customerName:"",vehicleBrand:"",vehicleModel:"",licensePlate:"",customerEmail:"",customerPhone:"",customerCompany:"",insuranceCompany:"",insuranceType:"",timeFilter:"all",priceRange:"all",paymentStatus:"all",showOnlyActive:!1,showOnlyOverdue:!1,showOnlyCompleted:!1});n.useEffect(()=>{const s=setTimeout(()=>{k(z)},300);return()=>clearTimeout(s)},[z]);const R=n.useMemo(()=>{const s=new Map;return P.forEach(o=>{s.set(o.id,o)}),s},[P]),T=n.useMemo(()=>{const s=new Set(r.map(o=>o.status).filter(Boolean));return Array.from(s)},[r]),j=n.useMemo(()=>{const s=new Set(r.map(o=>R.get(o.vehicleId)?.company).filter(Boolean));return Array.from(s)},[r,R]),L=n.useMemo(()=>{const s=new Set(r.map(o=>o.paymentMethod).filter(Boolean));return Array.from(s)},[r]),l=n.useMemo(()=>{const s=new Set(r.map(o=>R.get(o.vehicleId)?.brand).filter(Boolean));return Array.from(s)},[r,R]),A=n.useMemo(()=>[],[]),u=n.useMemo(()=>[],[]),b=n.useMemo(()=>{let s=[...r];if(c.trim()){const o=c.toLowerCase().trim();s=s.filter(p=>{const d=R.get(p.vehicleId);return p.customerName?.toLowerCase().includes(o)||p.customer?.email?.toLowerCase().includes(o)||p.customer?.phone?.toLowerCase().includes(o)||d?.licensePlate?.toLowerCase().includes(o)||d?.brand?.toLowerCase().includes(o)||d?.model?.toLowerCase().includes(o)||d?.company?.toLowerCase().includes(o)||p.id?.toLowerCase().includes(o)})}if(t.status.length>0&&(s=s.filter(o=>o.status&&t.status.includes(o.status))),t.paymentMethod.length>0&&(s=s.filter(o=>t.paymentMethod.includes(o.paymentMethod))),t.company.length>0&&(s=s.filter(o=>{const p=R.get(o.vehicleId);return p&&t.company.includes(p.company)})),t.dateFrom){const o=new Date(t.dateFrom);s=s.filter(p=>new Date(p.startDate)>=o)}if(t.dateTo){const o=new Date(t.dateTo);s=s.filter(p=>new Date(p.endDate)<=o)}if(t.priceMin){const o=parseFloat(t.priceMin);s=s.filter(p=>(p.totalPrice||0)>=o)}if(t.priceMax){const o=parseFloat(t.priceMax);s=s.filter(p=>(p.totalPrice||0)<=o)}if(t.customerName.trim()){const o=t.customerName.toLowerCase().trim();s=s.filter(p=>p.customerName?.toLowerCase().includes(o))}if(t.vehicleBrand&&t.vehicleBrand!=="all"&&(s=s.filter(o=>R.get(o.vehicleId)?.brand===t.vehicleBrand)),t.licensePlate.trim()){const o=t.licensePlate.toLowerCase().trim();s=s.filter(p=>R.get(p.vehicleId)?.licensePlate?.toLowerCase().includes(o))}if(t.paymentStatus!=="all"&&(t.paymentStatus==="paid"?s=s.filter(o=>o.paid):t.paymentStatus==="unpaid"&&(s=s.filter(o=>!o.paid))),t.showOnlyActive){const o=new Date;s=s.filter(p=>{const d=new Date(p.startDate),S=new Date(p.endDate);return d<=o&&S>=o})}if(t.showOnlyOverdue){const o=new Date;s=s.filter(p=>new Date(p.endDate)<o&&!m[p.id]?.return)}if(t.showOnlyCompleted&&(s=s.filter(o=>m[o.id]?.return)),t.timeFilter&&t.timeFilter!=="all"){const o=new Date,p=new Date(o);p.setDate(o.getDate()+1);const d=new Date(o);switch(d.setDate(o.getDate()+(7-o.getDay())),d.setHours(23,59,59,999),t.timeFilter){case"todayActivity":s=s.filter(S=>{const _=new Date(S.startDate),U=new Date(S.endDate),D=O=>O.toDateString()===o.toDateString();return D(_)||D(U)});break;case"tomorrowReturns":s=s.filter(S=>new Date(S.endDate).toDateString()===p.toDateString());break;case"weekActivity":s=s.filter(S=>{const _=new Date(S.startDate),U=new Date(S.endDate),D=_>=o&&_<=d,O=U>=o&&U<=d;return D||O});break;case"newToday":s=s.filter(S=>S.createdAt?new Date(S.createdAt).toDateString()===o.toDateString():!1);break}}return s},[r,c,t,R,m]),N=n.useCallback(s=>{const o=new Date,p=new Date(o);p.setDate(o.getDate()+1);const d=new Date(o);d.setDate(o.getDate()+(7-o.getDay())),d.setHours(23,59,59,999);let _={...{status:[],paymentMethod:[],company:[],dateFrom:"",dateTo:"",priceMin:"",priceMax:"",protocolStatus:[],customerName:"",vehicleBrand:"",vehicleModel:"",licensePlate:"",customerEmail:"",customerPhone:"",customerCompany:"",insuranceCompany:"",insuranceType:"",timeFilter:s,priceRange:"all",paymentStatus:"all",showOnlyActive:!1,showOnlyOverdue:!1,showOnlyCompleted:!1}};switch(s){case"overdue":_.showOnlyOverdue=!0;break;case"todayActivity":_.timeFilter="todayActivity";break;case"tomorrowReturns":const U=p.toISOString().split("T")[0];_.dateTo=U,_.timeFilter="tomorrowReturns";break;case"weekActivity":_.timeFilter="weekActivity";break;case"active":_.showOnlyActive=!0;break;case"unpaid":_.paymentStatus="unpaid";break;case"pending":_.status=["pending"];break;case"newToday":_.timeFilter="newToday";break}C(U=>({...U,..._,showOnlyActive:_.showOnlyActive||!1,showOnlyOverdue:_.showOnlyOverdue||!1,showOnlyCompleted:_.showOnlyCompleted||!1})),M(!0)},[]),h=n.useCallback(()=>{f(""),C({status:[],paymentMethod:[],company:[],dateFrom:"",dateTo:"",priceMin:"",priceMax:"",protocolStatus:[],customerName:"",vehicleBrand:"",vehicleModel:"",licensePlate:"",customerEmail:"",customerPhone:"",customerCompany:"",insuranceCompany:"",insuranceType:"",timeFilter:"all",priceRange:"all",paymentStatus:"all",showOnlyActive:!1,showOnlyOverdue:!1,showOnlyCompleted:!1}),M(!1)},[]);return{searchQuery:z,setSearchQuery:f,debouncedSearchQuery:c,showFilters:I,setShowFilters:M,advancedFilters:t,setAdvancedFilters:C,filteredRentals:b,uniqueStatuses:T,uniqueCompanies:j,uniquePaymentMethods:L,uniqueVehicleBrands:l,uniqueInsuranceCompanies:A,uniqueInsuranceTypes:u,handleQuickFilter:N,resetFilters:h}},Ia=({onEdit:r,onDelete:P,onScrollRestore:m}={})=>{const{deleteRental:z}=Mt(),[f,c]=n.useState(!1),[k,I]=n.useState(null),[M,t]=n.useState(""),C=n.useRef(0),R=n.useCallback(()=>{I(null),c(!0)},[]),T=n.useCallback(u=>{typeof window<"u"&&(C.current=window.pageYOffset||document.documentElement.scrollTop),I(u),c(!0),r&&r(u)},[r]),j=n.useCallback(async u=>{if(window.confirm("Naozaj chcete vymazať tento prenájom?"))try{await z(u),H.info("Rental deleted successfully",{rentalId:u}),P&&P(u)}catch(b){H.error("Failed to delete rental",{rentalId:u,error:b})}},[z,P]),L=n.useCallback(u=>{T(u)},[T]),l=n.useCallback(()=>{setTimeout(()=>{if(typeof window<"u"&&C.current>0){let u=0;const b=5,N=()=>{u++,window.scrollTo({top:C.current,behavior:"auto"});const h=window.pageYOffset||document.documentElement.scrollTop;Math.abs(h-C.current)>50&&u<b?setTimeout(N,100):(C.current=0,m&&m())};N()}},100)},[m]),A=n.useCallback(()=>{c(!1),I(null),l()},[l]);return{openDialog:f,setOpenDialog:c,editingRental:k,setEditingRental:I,importError:M,setImportError:t,handleAdd:R,handleEdit:T,handleDelete:j,handleCancel:A,handleViewRental:L,savedScrollPosition:C,restoreScrollPosition:l}},Ra=({onProtocolUpdate:r}={})=>{const[P,m]=n.useState({}),[z,f]=n.useState([]),[c,k]=n.useState({}),[I,M]=n.useState(!1),[t,C]=n.useState(!1),[R,T]=n.useState(!1),[j,L]=n.useState(!1),[l,A]=n.useState(null),[u,b]=n.useState(!1),[N,h]=n.useState(null),[s,o]=n.useState(!1),[p,d]=n.useState(null),S=n.useRef(!1),[_,U]=n.useState([]),[D,O]=n.useState([]),[Q,V]=n.useState(""),[ce]=n.useState(new Map),w=n.useCallback(async oe=>{if(z.includes(oe))return null;f(re=>[...re,oe]);try{const re=await We.getProtocolsByRental(oe),we=re?.handoverProtocols?.length>0?re.handoverProtocols.sort((ye,Se)=>new Date(Se.createdAt||Se.completedAt||0).getTime()-new Date(ye.createdAt||ye.completedAt||0).getTime())[0]:void 0,Pe=re?.returnProtocols?.length>0?re.returnProtocols.sort((ye,Se)=>new Date(Se.createdAt||Se.completedAt||0).getTime()-new Date(ye.createdAt||ye.completedAt||0).getTime())[0]:void 0;H.debug("Protocols API response",{hasData:!!re,handoverCount:re?.handoverProtocols?.length||0,returnCount:re?.returnProtocols?.length||0,rentalId:oe});const xe={handover:we,return:Pe};return m(ye=>({...ye,[oe]:xe})),xe}catch(re){return H.error("Failed to load protocols",{rentalId:oe,error:re}),null}finally{f(re=>re.filter(we=>we!==oe))}},[z]),J=n.useCallback(async()=>{if(!(I||t)){M(!0);try{const oe=Date.now(),re=await We.getBulkProtocolStatus(),we=Date.now()-oe,Pe={};re.forEach(xe=>{Pe[xe.rentalId]={hasHandoverProtocol:xe.hasHandoverProtocol,hasReturnProtocol:xe.hasReturnProtocol,handoverProtocolId:xe.handoverProtocolId,returnProtocolId:xe.returnProtocolId}}),k(Pe),C(!0)}catch(oe){console.error("❌ BACKGROUND: Failed to load protocol status:",oe)}finally{M(!1)}}},[I,t]),Y=n.useCallback(async oe=>{try{await w(oe.id),A(oe),h("handover"),T(!0),H.info("Opening handover protocol dialog",{rentalId:oe.id})}catch(re){H.error("Failed to prepare handover protocol",{rentalId:oe.id,error:re})}},[w]),X=n.useCallback(async oe=>{try{await w(oe.id),A(oe),h("return"),L(!0),H.info("Opening return protocol dialog",{rentalId:oe.id})}catch(re){H.error("Failed to prepare return protocol",{rentalId:oe.id,error:re})}},[w]),y=n.useCallback(()=>{T(!1),A(null),h(null),l&&w(l.id)},[l,w]),B=n.useCallback(()=>{L(!1),A(null),h(null),l&&w(l.id)},[l,w]),ee=n.useCallback(()=>{o(!1),d(null)},[]),ie=n.useCallback(()=>{S.current=!1,U([]),O([]),V("")},[]),se=n.useCallback(()=>{b(!1),A(null),h(null)},[]),te=n.useCallback(()=>{},[]),K=n.useCallback(()=>{S.current=!0},[]);return{protocols:P,setProtocols:m,loadingProtocols:z,setLoadingProtocols:f,protocolStatusMap:c,setProtocolStatusMap:k,isLoadingProtocolStatus:I,setIsLoadingProtocolStatus:M,protocolStatusLoaded:t,setProtocolStatusLoaded:C,openHandoverDialog:R,setOpenHandoverDialog:T,openReturnDialog:j,setOpenReturnDialog:L,selectedRentalForProtocol:l,setSelectedRentalForProtocol:A,openProtocolMenu:u,setOpenProtocolMenu:b,selectedProtocolType:N,setSelectedProtocolType:h,pdfViewerOpen:s,setPdfViewerOpen:o,selectedPdf:p,setSelectedPdf:d,galleryOpenRef:S,galleryImages:_,setGalleryImages:U,galleryVideos:D,setGalleryVideos:O,galleryTitle:Q,setGalleryTitle:V,imageParsingCache:ce,loadProtocolsForRental:w,loadProtocolStatusInBackground:J,handleCreateHandover:Y,handleCreateReturn:X,handleCloseHandoverDialog:y,handleCloseReturnDialog:B,handleClosePDF:ee,handleCloseGallery:ie,handleCloseProtocolMenu:se,handleDownloadPDF:te,handleViewGallery:K,onProtocolUpdate:r}},Na=r=>new Intl.NumberFormat("sk-SK",{style:"currency",currency:"EUR"}).format(r),eo=r=>new Date(r).toLocaleDateString("sk-SK"),Aa=50;var Ma={};function or(){const{state:r,deleteRental:P,createRental:m,updateRental:z}=Mt(),[f,c]=n.useState(!1),[k,I]=n.useState(null),[M,t]=n.useState(null);wo();const C=At(),R=lo(C.breakpoints.down("md")),{rentals:T,loading:j,error:L,hasMore:l,totalCount:A,searchTerm:u,setSearchTerm:b,loadMore:N,refresh:h,updateFilters:s}=Yo();H.debug("🚀 RentalList LOADED:",{isMobile:R,screenWidth:typeof window<"u"?window.innerWidth:"unknown",breakpoint:C.breakpoints.values.md});const o=Ra({onProtocolUpdate:async(g,E,Z)=>{o.setProtocols(ae=>{const Ce={...ae};return delete Ce[g],Ce}),await o.loadProtocolsForRental(g),o.setProtocolStatusMap(ae=>({...ae,[g]:{hasHandoverProtocol:E==="handover"?!0:ae[g]?.hasHandoverProtocol||!1,hasReturnProtocol:E==="return"?!0:ae[g]?.hasReturnProtocol||!1,handoverProtocolId:E==="handover"?Z.id:ae[g]?.handoverProtocolId,returnProtocolId:E==="return"?Z.id:ae[g]?.returnProtocolId}}))}}),{searchQuery:p,setSearchQuery:d,debouncedSearchQuery:S,showFilters:_,setShowFilters:U,advancedFilters:D,setAdvancedFilters:O,filteredRentals:Q,uniqueStatuses:V,uniqueCompanies:ce,uniquePaymentMethods:w,uniqueVehicleBrands:J,uniqueInsuranceCompanies:Y,uniqueInsuranceTypes:X,handleQuickFilter:y,resetFilters:B}=za({rentals:T,vehicles:r.vehicles||[],protocols:o.protocols});ze.useEffect(()=>{S!==u&&b(S)},[S,u,b]),ze.useEffect(()=>{const g={dateFrom:D.dateFrom,dateTo:D.dateTo,company:D.company.length>0?D.company.join(","):void 0,status:D.status.length>0?D.status.join(","):void 0,paymentMethod:D.paymentMethod.length>0?D.paymentMethod.join(","):void 0,protocolStatus:D.protocolStatus.length>0?D.protocolStatus.join(","):void 0,vehicleBrand:D.vehicleBrand||void 0,priceMin:D.priceMin||void 0,priceMax:D.priceMax||void 0};s(g)},[D,s]);const ee=n.useCallback(()=>{B(),b(""),s({}),h()},[B,b,s,h]),ie=n.useCallback((g,E)=>{const Z=D[g],ae=Array.isArray(Z)?Z.includes(E)?Z.filter(fe=>fe!==E):[...Z,E]:[E],Ce={...D,[g]:ae};O(Ce)},[D,O]),se=n.useCallback((g,E)=>{const Z=D[g];return Array.isArray(Z)&&Z.includes(E)},[D]),{openDialog:te,setOpenDialog:K,editingRental:oe,setEditingRental:re,setImportError:we,handleAdd:Pe,handleEdit:xe,handleDelete:ye,handleCancel:Se,handleViewRental:Fe,savedScrollPosition:ue,restoreScrollPosition:Ie}=Ia({onEdit:g=>{H.debug("🔍 External edit handler called",{rentalId:g.id})},onDelete:g=>{H.debug("🗑️ External delete handler called",{rentalId:g})},onScrollRestore:()=>{H.debug("📜 External scroll restore handler called")}}),ot=n.useRef(null),Re=n.useRef(null),Ee=n.useRef(null),_e=.75,at=150,pt=100,ve=n.useRef(null),Me=n.useRef(null),xt=n.useRef(0),Qe=n.useCallback(()=>{R&&ot.current?ue.current=ot.current.scrollTop:!R&&Re.current&&(ue.current=Re.current.scrollTop),H.debug("📜 INFINITE SCROLL: Saved position before load more:",ue.current),N()},[R,ue,N]),ke=n.useCallback(()=>g=>{if(j||!l)return;const E=Date.now();E-xt.current<pt||(xt.current=E,ve.current&&clearTimeout(ve.current),ve.current=setTimeout(()=>{let Z=0;if(g.scrollOffset!==void 0){const ae=T.length*160,fe=Math.max(1,ae-600);Z=g.scrollOffset/fe}else if(g.target||g.currentTarget){const ae=g.target||g.currentTarget,{scrollTop:Ce,scrollHeight:fe,clientHeight:Le}=ae,a=Math.max(1,fe-Le);Z=Ce/a}Z>=_e&&Qe()},at))},[j,l,T.length,Qe]),Je=n.useCallback(g=>{const E=new Date,Z=new Date(g.endDate),ae=new Date(g.startDate);if(Z<E&&!o.protocols[g.id]?.return)return{color:"#f44336",label:"Preterminované",priority:1};const Ce=Z.toDateString()===E.toDateString(),fe=new Date(E);fe.setDate(E.getDate()+1);const Le=Z.toDateString()===fe.toDateString();if(Ce)return{color:"#ff9800",label:"Dnes vrátenie",priority:2};if(Le)return{color:"#ff9800",label:"Zajtra vrátenie",priority:3};if(!g.paid)return{color:"#ffc107",label:"Nezaplatené",priority:4};const a=ae.toDateString()===E.toDateString(),v=new Date(g.createdAt).toDateString()===E.toDateString();return a?{color:"#2196f3",label:"Začína dnes",priority:5}:v?{color:"#2196f3",label:"Nový dnes",priority:6}:{color:"#4caf50",label:"V poriadku",priority:7}},[o.protocols]),ft=n.useMemo(()=>{const g=new Map;return(r.vehicles||[]).forEach(E=>{g.set(E.id,E)}),g},[r.vehicles]),Ve=n.useCallback(g=>g.vehicleId&&ft.get(g.vehicleId)||null,[ft]);n.useCallback((g,E)=>{const Z=Ve(g);o.protocols[g.id]?.handover,o.protocols[g.id]?.return;const ae=Je(g);return e.jsxs(he,{sx:{mb:2,p:2,borderLeft:`4px solid ${ae.color}`,position:"relative","&:hover":{boxShadow:C.shadows[4],transform:"translateY(-1px)",transition:"all 0.2s ease-in-out"}},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsx(x,{variant:"h6",sx:{fontWeight:600,color:"primary.main"},children:Z?`${Z.brand} ${Z.model}`:"Neznáme vozidlo"}),e.jsx(x,{variant:"caption",sx:{color:ae.color,fontWeight:600},children:ae.label})]}),e.jsxs(x,{variant:"body2",sx:{mb:1},children:["📅 ",eo(g.startDate.toString())," - ",eo(g.endDate.toString())]}),e.jsxs(x,{variant:"body2",sx:{mb:1,fontWeight:600,color:"success.main"},children:["💰 ",Na(g.totalPrice)]}),e.jsxs(x,{variant:"body2",sx:{mb:2},children:["👤 ",g.customerName]}),e.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(vt,{size:"small",onClick:()=>xe(g),children:"Upraviť"}),e.jsx(vt,{size:"small",onClick:()=>o.handleCreateHandover(g),children:"Prevzatie"}),e.jsx(vt,{size:"small",onClick:()=>o.handleCreateReturn(g),children:"Vrátenie"})]})]},g.id)},[Ve,o.protocols,Je,C,xe,o.handleCreateHandover,o.handleCreateReturn]),ze.useEffect(()=>{if(T.length>0&&!o.protocolStatusLoaded&&!o.isLoadingProtocolStatus){const g=setTimeout(()=>{o.loadProtocolStatusInBackground()},100);return()=>clearTimeout(g)}},[T.length,o.protocolStatusLoaded,o.isLoadingProtocolStatus,o.loadProtocolStatusInBackground]),ze.useEffect(()=>{Ee.current=ke();const g=Re.current,E=Ee.current;return!R&&g&&E&&g.addEventListener("scroll",E,{passive:!0}),R&&E&&(window.__unifiedRentalScrollHandler=E),()=>{ve.current&&clearTimeout(ve.current),Me.current&&clearTimeout(Me.current),!R&&g&&E&&g.removeEventListener("scroll",E),R&&delete window.__unifiedRentalScrollHandler}},[R,ke]);const Ke=n.useCallback(()=>{c(!1),I(null),t(null)},[]),kt=n.useCallback(async()=>{if(k&&M){const g=o.protocols[k.id]?.[M];if(g)try{const E=localStorage.getItem("blackrent_token")||sessionStorage.getItem("blackrent_token");let Z;g.pdfUrl?Z=g.pdfUrl:Z=`${Ma.REACT_APP_API_URL||"http://localhost:3001"}/api/protocols/${M}/${g.id}/pdf?token=${E}`,window.open(Z,"_blank")}catch(E){console.error("❌ Error downloading PDF:",E)}}Ke()},[k,M,o.protocols,Ke]),Ct=n.useCallback(async()=>{if(!(!k||!M))try{H.debug("🔍 Opening gallery for protocol:",M,"rental:",k.id),Ke();let g=o.protocols[k.id]?.[M];if(g||(H.debug("📥 Loading protocol for gallery..."),g=(await o.loadProtocolsForRental(k.id))?.[M]),!g){alert("Protokol nebol nájdený!");return}const E=fe=>{if(!fe)return[];if(typeof fe=="string")try{const Le=JSON.parse(fe);return Array.isArray(Le)?Le:[]}catch{return console.warn("⚠️ Failed to parse image data as JSON:",fe),[]}return Array.isArray(fe)?fe:[]},Z=[...E(g.vehicleImages),...E(g.documentImages),...E(g.damageImages)],ae=[...E(g.vehicleVideos),...E(g.documentVideos),...E(g.damageVideos)];if(H.debug("🖼️ Gallery data prepared:",{imagesCount:Z.length,videosCount:ae.length}),Z.length===0&&ae.length===0){alert("Nenašli sa žiadne obrázky pre tento protokol!");return}o.setGalleryImages(Z),o.setGalleryVideos(ae);const Ce=Ve(k);o.setGalleryTitle(`${M==="handover"?"Prevzatie":"Vrátenie"} - ${Ce?`${Ce.brand} ${Ce.model}`:"Neznáme vozidlo"}`),o.galleryOpenRef.current=!0,H.debug("✅ Gallery opened successfully with protocol data")}catch(g){console.error("❌ Error opening gallery:",g),alert("Chyba pri otváraní galérie!")}},[k,M,o,Ke,Ve]);return L?e.jsxs(So,{sx:{textAlign:"center"},children:[e.jsx(x,{variant:"h6",color:"error",gutterBottom:!0,children:"Chyba pri načítavaní prenájmov"}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mb:2},children:L}),e.jsx(Dt,{onClick:()=>window.location.reload(),children:"Obnoviť stránku"})]}):e.jsxs(i,{sx:{p:{xs:0,md:0}},children:[e.jsx(Pa,{rentals:Q,protocols:o.protocols,isLoading:j,onQuickFilter:y}),e.jsx(Po,{create:"rentals",children:e.jsx(Sa,{isMobile:R,handleAdd:Pe})}),e.jsx(Da,{filteredRentals:Q,state:r,isMobile:R,setImportError:we}),e.jsx(Go,{searchQuery:p,setSearchQuery:d,showFilters:_,setShowFilters:U,advancedFilters:D,handleAdvancedFiltersChange:O,toggleFilterValue:ie,isFilterValueSelected:se,resetAllFilters:ee,uniquePaymentMethods:w,uniqueCompanies:ce,uniqueStatuses:V,uniqueVehicleBrands:J,uniqueInsuranceCompanies:Y,uniqueInsuranceTypes:X,filteredRentalsCount:Q.length,totalRentalsCount:A||0,showFiltersMobile:!1,setShowFiltersMobile:()=>{}}),e.jsx(Qo,{paginatedRentals:u?T:Q,isMobile:R,handleEdit:xe,handleDelete:ye,handleCreateHandover:o.handleCreateHandover,handleCreateReturn:o.handleCreateReturn,handleOpenProtocolMenu:(g,E)=>{H.debug("📋 Opening protocol menu",g.id,E);const Z=o.protocolStatusMap[g.id],ae=E==="handover"?Z?.hasHandoverProtocol:Z?.hasReturnProtocol;H.debug("🔍 Protocol check:",{rentalId:g.id,type:E,hasProtocol:ae,protocolStatus:Z}),ae?o.loadProtocolsForRental(g.id).then(()=>{I(g),t(E),c(!0)}):E==="handover"?o.handleCreateHandover(g):E==="return"&&o.handleCreateReturn(g)},handleViewRental:Fe,getVehicleByRental:Ve,protocolStatusMap:o.protocolStatusMap,protocols:o.protocols,getStatusIndicator:Je,filteredRentals:Q,desktopScrollRef:Re,mobileScrollRef:ot,isLoadingProtocolStatus:o.isLoadingProtocolStatus,protocolStatusLoaded:o.protocolStatusLoaded,handleCheckProtocols:g=>{o.loadProtocolsForRental(g.id)},loadingProtocols:o.loadingProtocols,VirtualizedRentalRow:null,onScroll:({scrollOffset:g})=>{window.__unifiedRentalScrollHandler&&window.__unifiedRentalScrollHandler({scrollOffset:g})}}),!j&&l&&e.jsx(i,{sx:{display:{xs:"none",md:"flex"},justifyContent:"center",p:3},children:e.jsxs(Dt,{onClick:Qe,size:"medium",startIcon:e.jsx(ao,{}),sx:{px:3},children:["Načítať ďalších ",Aa," prenájmov"]})}),!l&&T.length>0&&e.jsx(i,{sx:{textAlign:"center",p:3,backgroundColor:"rgba(76, 175, 80, 0.08)",borderRadius:2,m:2},children:e.jsxs(x,{variant:"body1",color:"success.main",fontWeight:500,children:["✅ Všetky prenájmy načítané (",T.length," celkom)"]})}),e.jsx(wa,{openDialog:te,openHandoverDialog:o.openHandoverDialog,openReturnDialog:o.openReturnDialog,openProtocolMenu:o.openProtocolMenu,pdfViewerOpen:o.pdfViewerOpen,galleryOpen:o.galleryOpenRef.current,editingRental:oe,selectedRentalForProtocol:o.selectedRentalForProtocol,selectedProtocolType:o.selectedProtocolType,selectedPdf:o.selectedPdf,galleryImages:o.galleryImages,galleryVideos:o.galleryVideos,galleryTitle:o.galleryTitle,protocols:o.protocols,setOpenDialog:K,setOpenHandoverDialog:o.setOpenHandoverDialog,setOpenReturnDialog:o.setOpenReturnDialog,handleSave:async g=>{try{oe?(await z(g),H.info("✅ Rental updated successfully:",g.id)):(await m(g),H.info("✅ Rental created successfully")),K(!1),re(null),Ie(),h()}catch(E){console.error("❌ Error saving rental:",E);const Z=E instanceof Error?E.message:"Neznáma chyba";alert(`Chyba pri ukladaní prenájmu: ${Z}`)}},handleCancel:Se,handleSaveHandover:async g=>{try{H.debug("💾 Handover protocol already saved, updating UI:",g),await o.onProtocolUpdate?.(g.rentalId,"handover",g),o.setOpenHandoverDialog(!1),o.setSelectedRentalForProtocol(null),H.debug("✅ Handover protocol UI updated successfully")}catch(E){console.error("❌ Error updating handover protocol UI:",E),alert("Chyba pri aktualizácii protokolu. Skúste to znovu.")}},handleSaveReturn:async g=>{try{H.debug("💾 Return protocol already saved, updating UI:",g),await o.onProtocolUpdate?.(g.rentalId,"return",g),o.setOpenReturnDialog(!1),o.setSelectedRentalForProtocol(null),H.debug("✅ Return protocol UI updated successfully")}catch(E){console.error("❌ Error updating return protocol UI:",E),alert("Protokol bol uložený, ale UI sa nepodarilo aktualizovať. Obnovte stránku.")}},handleClosePDF:o.handleClosePDF,handleCloseGallery:o.handleCloseGallery,handleCloseProtocolMenu:o.handleCloseProtocolMenu,handleDownloadPDF:o.handleDownloadPDF,handleViewGallery:o.handleViewGallery}),e.jsxs(Ue,{open:f,onClose:Ke,maxWidth:"xs",fullWidth:!0,children:[e.jsxs(He,{sx:{bgcolor:"primary.main",color:"white",display:"flex",alignItems:"center",gap:1},children:[M==="handover"?"🚗→":"←🚗",M==="handover"?"Odovzdávací protokol":"Preberací protokol"]}),e.jsx(Be,{sx:{p:{xs:2,sm:3}},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:{xs:1.5,sm:2}},children:[e.jsx(Do,{fullWidth:!0,startIcon:e.jsx(Tt,{}),onClick:kt,sx:{py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"}},children:"📄 Stiahnuť PDF protokol"}),e.jsx(Dt,{fullWidth:!0,startIcon:e.jsx(Et,{}),onClick:Ct,sx:{py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"}},children:"🖼️ Zobraziť fotky"}),e.jsx(vt,{fullWidth:!0,onClick:Ke,sx:{py:{xs:2,sm:1.5},fontSize:{xs:"1rem",sm:"0.875rem"}},children:"Zavrieť"})]})})]})]})}export{or as default};
