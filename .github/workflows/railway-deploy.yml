name: Deploy to Railway

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            apps/web/package-lock.json

      - name: Clear npm cache and fix registry
        run: |
          npm cache clean --force
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000

      - name: Install dependencies with retry
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm --version
          node --version
          ls -la package*.json
          rm -rf node_modules package-lock.json
          npm install
          echo "âœ… Frontend dependencies installed"
          ls -la node_modules/.bin/vite || echo "âŒ vite not found"

      - name: Build frontend
        run: npm run build
        env:
          CI: false

      - name: Prepare isolated backend build
        run: |
          echo "ðŸ”§ Preparing isolated backend build..."
          # Create temporary directory outside workspace
          mkdir -p /tmp/backend-build
          # Copy backend source files
          cp -r apps/backend/* /tmp/backend-build/
          # Remove any workspace-related files
          rm -f /tmp/backend-build/package-lock.json
          rm -f /tmp/backend-build/.npmrc
          ls -la /tmp/backend-build/

      - name: Build backend
        working-directory: /tmp/backend-build
        env:
          NPM_CONFIG_WORKSPACES: false
          NPM_CONFIG_INCLUDE_WORKSPACE_ROOT: false
        run: |
          echo "ðŸ”§ Building backend in isolated environment..."
          npm config set registry https://registry.npmjs.org/
          npm config set workspaces false
          npm config set include-workspace-root false
          npm install --no-optional --legacy-peer-deps
          echo "âœ… Backend dependencies installed"
          npm run build
          echo "âœ… Backend build completed"
          ls -la dist/

      - name: Test build
        run: |
          echo "âœ… Frontend build successful"
          echo "âœ… Backend build successful"
          echo "ðŸš€ Railway will auto-deploy from main branch"

      - name: Build summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend build: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend build: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Railway auto-deploy: TRIGGERED" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ URL: https://blackrent-app-production-4d6f.up.railway.app" >> $GITHUB_STEP_SUMMARY
