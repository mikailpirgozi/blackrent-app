# üöÄ IMPLEMENTAƒåN√ù PL√ÅN: HMR OPTIMALIZ√ÅCIA
## BlackRent Dev Server Performance Enhancement

### üìã **PREHƒΩAD PROBL√âMU**
- **Probl√©m**: Pomal√© HMR updates, zmeny sa prejavia a≈æ po ƒçase/refreshi
- **Pr√≠ƒçiny**: Service Worker cache, React Query stale data, suboptim√°lny Vite config
- **Cieƒæ**: R√Ωchle dev experience bez naru≈°enia produkƒçn√Ωch funkcional√≠t

---

## üéØ **IMPLEMENTAƒåN√Å STRAT√âGIA**

### **PRINC√çPY:**
1. ‚úÖ **DEV-ONLY changes** - ≈æiadne zmeny v production behavior
2. ‚úÖ **Postupn√© testovanie** - ka≈æd√Ω krok sa testuje pred pokraƒçovan√≠m  
3. ‚úÖ **Zachovanie funkcional√≠t** - PWA, push notifications, offline support
4. ‚úÖ **Rollback ready** - mo≈ænos≈• vr√°ti≈• zmeny ak nieƒço zlyh√°

---

## üìÖ **F√ÅZY IMPLEMENT√ÅCIE**

### **F√ÅZA 1: VITE CONFIGURATION OPTIMIZATION** ‚ö°
**ƒåas: 15 min√∫t | Riziko: N√çZKE**

#### **Kroky:**
1. **Backup aktu√°lnej konfigur√°cie**
   ```bash
   cp vite.config.ts vite.config.ts.backup
   ```

2. **Optimalizova≈• vite.config.ts**
   ```typescript
   export default defineConfig({
     server: {
       port: 3000,
       // OPTIMALIZ√ÅCIA FILE WATCHING
       watch: { 
         usePolling: true,
         interval: 100,  // R√Ωchlej≈°ie ne≈æ default 200ms
         ignored: ['**/node_modules/**', '**/.git/**']
       },
       // SEPAR√ÅTNY HMR PORT
       hmr: { 
         overlay: true,
         port: 3002,
         host: 'localhost'
       },
       // PROXY OPTIMALIZ√ÅCIA  
       proxy: {
         '/api': {
           target: 'http://localhost:3001',
           changeOrigin: true,
           secure: false,
           timeout: 5000  // R√Ωchlej≈°√≠ timeout
         }
       }
     },
     // DEV FLAGS
     define: {
       __DEV_DISABLE_SW_CACHE__: JSON.stringify(import.meta.env.MODE === 'development'),
       __DEV_FAST_REFRESH__: JSON.stringify(import.meta.env.MODE === 'development')
     }
   })
   ```

3. **Test F√ÅZY 1**
   ```bash
   # Re≈°tart dev servera
   npm run dev:stop
   npm run dev
   
   # Test HMR r√Ωchlosti
   # 1. Uprav ƒæubovoƒæn√Ω komponent
   # 2. Skontroluj ƒças do zobrazenia zmeny
   # 3. Skontroluj ≈æe aplik√°cia funguje norm√°lne
   ```

#### **Oƒçak√°van√© v√Ωsledky:**
- ‚ö° R√Ωchlej≈°ie file watching (100ms vs 200ms)
- üîÑ Separ√°tny HMR port (menej konfliktov)
- üì° Optimalizovan√Ω proxy (r√Ωchlej≈°ie API calls)

#### **Rollback ak zlyh√°:**
```bash
cp vite.config.ts.backup vite.config.ts
npm run dev:restart
```

---

### **F√ÅZA 2: SERVICE WORKER DEV BYPASS** üîß
**ƒåas: 20 min√∫t | Riziko: STREDN√â**

#### **Kroky:**
1. **Backup SW s√∫borov**
   ```bash
   cp src/hooks/usePWA.ts src/hooks/usePWA.ts.backup
   cp public/sw.js public/sw.js.backup
   ```

2. **Upravi≈• usePWA.ts - DEV MODE detection**
   ```typescript
   const registerServiceWorker = useCallback(async (): Promise<ServiceWorkerRegistration | null> => {
     if (!('serviceWorker' in navigator)) {
       console.warn('Service Worker not supported');
       return null;
     }

     try {
       // DEV MODE: Registruj SW ale s obmedzen√Ωm cache
       const swPath = import.meta.env.MODE === 'development' 
         ? '/sw-dev.js'  // ≈†peci√°lny dev SW
         : '/sw.js';     // Produkƒçn√Ω SW

       const registration = await navigator.serviceWorker.register(swPath, {
         scope: '/',
       });

       if (import.meta.env.MODE === 'development') {
         console.log('üîß DEV: Service Worker registered with LIMITED caching');
         console.log('üì± PWA features active, HMR cache DISABLED');
       } else {
         console.log('‚úÖ PROD: Service Worker registered with FULL caching');
       }

       return registration;
     } catch (error) {
       console.error('Service Worker registration failed:', error);
       return null;
     }
   }, []);
   ```

3. **Vytvori≈• sw-dev.js (development-only SW)**
   ```javascript
   // public/sw-dev.js
   const CACHE_VERSION = 'dev-2.1.0';
   const CACHE_NAME = `blackrent-dev-v${CACHE_VERSION}`;
   
   // DEV MODE: Minim√°lne ke≈°ovanie
   const CRITICAL_ASSETS = [
     '/offline.html',
     '/manifest.json'
   ];

   // Install - len kritick√© assety
   self.addEventListener('install', event => {
     console.log('üîß DEV SW: Installing with minimal cache...');
     event.waitUntil(
       caches.open(CACHE_NAME)
         .then(cache => cache.addAll(CRITICAL_ASSETS))
         .then(() => self.skipWaiting())
     );
   });

   // Fetch - BYPASS cache pre v≈°etko okrem kritick√Ωch
   self.addEventListener('fetch', event => {
     const { request } = event;
     
     // Len offline page a manifest
     if (request.url.includes('offline.html') || request.url.includes('manifest.json')) {
       event.respondWith(
         caches.match(request).then(response => response || fetch(request))
       );
     } else {
       // V≈°etko ostatn√© - PRIAMO zo siete (no cache)
       event.respondWith(fetch(request));
     }
   });

   // Push notifications - ZACHOVAN√â
   self.addEventListener('push', event => {
     // Pln√° funkcionalita push notifications
     if (!event.data) return;
     
     const data = event.data.json();
     event.waitUntil(
       self.registration.showNotification(data.title, {
         body: data.body,
         icon: '/logo192.png'
       })
     );
   });
   ```

4. **Test F√ÅZY 2**
   ```bash
   # Re≈°tart servera
   npm run dev:restart
   
   # Test PWA funkcional√≠t
   # 1. Skontroluj ≈æe push notifications funguj√∫
   # 2. Skontroluj offline indicator
   # 3. Test HMR r√Ωchlosti
   # 4. Skontroluj ≈æe PWA install prompt funguje
   ```

#### **Oƒçak√°van√© v√Ωsledky:**
- ‚ö° HMR bez SW cache interference
- üîî Push notifications zachovan√©
- üì± PWA install funkcionalita zachovan√°
- üåê Offline support pre kritick√© s√∫bory

#### **Rollback ak zlyh√°:**
```bash
cp src/hooks/usePWA.ts.backup src/hooks/usePWA.ts
rm public/sw-dev.js
npm run dev:restart
```

---

### **F√ÅZA 3: REACT QUERY DEV OPTIMIZATION** ‚ö°
**ƒåas: 15 min√∫t | Riziko: N√çZKE**

#### **Kroky:**
1. **Backup React Query config**
   ```bash
   cp src/lib/react-query/queryClient.ts src/lib/react-query/queryClient.ts.backup
   ```

2. **Optimalizova≈• queryClient.ts**
   ```typescript
   export const queryClient = new QueryClient({
     defaultOptions: {
       queries: {
         // DEV: ≈Ωiadne ke≈°ovanie, PROD: norm√°lne ke≈°ovanie
         staleTime: import.meta.env.MODE === 'development' ? 0 : 2 * 60 * 1000,
         gcTime: import.meta.env.MODE === 'development' ? 0 : 5 * 60 * 1000,
         
         // DEV: Vypnut√© auto-refetch, PROD: zapnut√©
         refetchOnWindowFocus: import.meta.env.MODE === 'development' ? false : true,
         refetchOnReconnect: import.meta.env.MODE === 'development' ? false : true,
         
         // Retry strat√©gia zachovan√°
         retry: (failureCount, error) => {
           if (error instanceof Error) {
             const message = error.message;
             if (message.includes('401') || message.includes('403')) {
               return false;
             }
           }
           return failureCount < 3;
         },
         retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
       },
       mutations: {
         retry: 1,
         retryDelay: 1000,
       },
     },
   });

   // DEV MODE: Debug info
   if (import.meta.env.MODE === 'development') {
     console.log('üîß React Query: DEV mode - caching DISABLED for faster HMR');
   }
   ```

3. **Test F√ÅZY 3**
   ```bash
   # Test React Query spr√°vania
   # 1. Naƒç√≠taj str√°nku s d√°tami
   # 2. Uprav komponent ktor√Ω zobrazuje d√°ta
   # 3. Skontroluj ≈æe zmeny sa prejavia okam≈æite
   # 4. Skontroluj ≈æe d√°ta sa naƒç√≠tavaj√∫ spr√°vne
   ```

#### **Oƒçak√°van√© v√Ωsledky:**
- ‚ö° Okam≈æit√© zobrazenie zmien v UI
- üîÑ ≈Ωiadne stale data v dev mode
- üìä Norm√°lne API volania zachovan√©

#### **Rollback ak zlyh√°:**
```bash
cp src/lib/react-query/queryClient.ts.backup src/lib/react-query/queryClient.ts
npm run dev:restart
```

---

### **F√ÅZA 4: CONSOLE LOG OPTIMIZATION** üßπ
**ƒåas: 10 min√∫t | Riziko: VEƒΩMI N√çZKE**

#### **Kroky:**
1. **Vytvori≈• smart logger**
   ```typescript
   // src/utils/devLogger.ts
   export const devLogger = {
     // Len kritick√© logy v dev mode
     debug: import.meta.env.MODE === 'development' && import.meta.env.VITE_DEBUG === 'true' 
       ? console.log 
       : () => {},
     
     info: console.info,
     warn: console.warn,
     error: console.error,
     
     // HMR specific logging
     hmr: import.meta.env.MODE === 'development' 
       ? (message: string) => console.log(`üîÑ HMR: ${message}`)
       : () => {}
   };
   ```

2. **Nahradi≈• kritick√© console.log**
   ```bash
   # N√°js≈• najƒçastej≈°ie logy
   grep -r "console.log" src/ | head -20
   
   # Nahradi≈• v kritick√Ωch s√∫boroch
   # - src/lib/react-query/websocket-integration.ts
   # - src/hooks/usePWA.ts
   # - src/services/pushNotifications.ts
   ```

3. **Test F√ÅZY 4**
   ```bash
   # Skontroluj console output
   # 1. Otvori≈• DevTools console
   # 2. Naƒç√≠ta≈• str√°nku
   # 3. Skontroluj ≈æe je menej logov
   # 4. Skontroluj ≈æe kritick√© logy st√°le funguj√∫
   ```

---

### **F√ÅZA 5: FINAL TESTING & VALIDATION** ‚úÖ
**ƒåas: 20 min√∫t | Riziko: ≈ΩIADNE**

#### **Kompletn√Ω test scen√°r:**
1. **HMR Performance Test**
   ```bash
   # Meranie ƒçasu HMR updates
   # 1. Uprav CSS v komponente
   # 2. Uprav TypeScript k√≥d
   # 3. Pridaj nov√Ω komponent
   # 4. Zma≈æ s√∫bor a vytvor nov√Ω
   ```

2. **PWA Functionality Test**
   ```bash
   # Test v≈°etk√Ωch PWA funkci√≠
   # 1. Push notifications
   # 2. Offline indicator
   # 3. Install prompt
   # 4. Service worker registration
   ```

3. **Production Build Test**
   ```bash
   # Overi≈• ≈æe production nie je ovplyvnen√°
   npm run build
   # Skontroluj ≈æe build prech√°dza
   # Skontroluj ≈æe SW cache funguje v prod
   ```

4. **Performance Metrics**
   ```bash
   # Pred optimaliz√°ciou vs po optimaliz√°cii
   # - ƒåas HMR update
   # - Poƒçet console logov
   # - Memory usage
   # - Network requests
   ```

---

## üìä **OƒåAK√ÅVAN√â V√ùSLEDKY**

### **Pred optimaliz√°ciou:**
- ‚è±Ô∏è HMR update: 2-5 sek√∫nd
- üìù Console logs: 627 v√Ωpisov
- üíæ Cache interference: √Åno
- üîÑ File watching: 200ms interval

### **Po optimaliz√°cii:**
- ‚ö° HMR update: 0.5-1 sekunda (80% zlep≈°enie)
- üìù Console logs: ~100 v√Ωpisov (85% redukcia)
- üíæ Cache interference: Nie
- üîÑ File watching: 100ms interval

---

## üõ°Ô∏è **BEZPEƒåNOSTN√â OPATRENIA**

### **Rollback strat√©gia:**
```bash
# Kompletn√Ω rollback v≈°etk√Ωch zmien
git stash  # Ak s√∫ zmeny uncommitted
# ALEBO
cp vite.config.ts.backup vite.config.ts
cp src/hooks/usePWA.ts.backup src/hooks/usePWA.ts
cp src/lib/react-query/queryClient.ts.backup src/lib/react-query/queryClient.ts
rm public/sw-dev.js
npm run dev:restart
```

### **Monitoring:**
- üìä Sledova≈• HMR performance
- üîç Monitorova≈• console errors
- üì± Testova≈• PWA funkcionalitu
- üåê Overi≈• offline support

---

## ‚úÖ **AKCEPTAƒåN√â KRIT√âRI√Å**

### **MUS√ç FUNGOVA≈§:**
- ‚úÖ HMR updates < 1 sekunda
- ‚úÖ Push notifications zachovan√©
- ‚úÖ PWA install prompt funkƒçn√Ω
- ‚úÖ Offline indicator spr√°vny
- ‚úÖ Production build bez zmien
- ‚úÖ V≈°etky existuj√∫ce funkcionality

### **M√î≈ΩE SA ZMENI≈§:**
- üìù Poƒçet console logov (menej)
- ‚ö° R√Ωchlos≈• file watching (r√Ωchlej≈°ie)
- üíæ Dev cache behavior (optimalizovan√©)

---

## üöÄ **SPUSTENIE IMPLEMENT√ÅCIE**

```bash
# Krok 1: Backup aktu√°lneho stavu
git add . && git commit -m "Backup before HMR optimization"

# Krok 2: Spusti≈• implement√°ciu po f√°zach
# Ka≈æd√∫ f√°zu testova≈• pred pokraƒçovan√≠m

# Krok 3: Final validation
npm run build  # Test production build
npm run dev    # Test development server
```

---

**Pripraven√Ω na implement√°ciu! üéØ**
