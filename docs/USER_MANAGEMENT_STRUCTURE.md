# üë• BlackRent User Management Structure

## üìã Obsah
1. [Prehƒæad syst√©mu](#prehƒæad-syst√©mu)
2. [User Roles](#user-roles)
3. [Platform Multi-Tenancy](#platform-multi-tenancy)
4. [Permission System](#permission-system)
5. [User-Company Relationships](#user-company-relationships)
6. [Investor Management](#investor-management)
7. [Database Schema](#database-schema)
8. [API Endpoints](#api-endpoints)
9. [Frontend Architecture](#frontend-architecture)

---

## üéØ Prehƒæad syst√©mu

BlackRent pou≈æ√≠va **3-vrstvov√Ω permission syst√©m**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. PLATFORM LEVEL (Multi-tenancy)      ‚îÇ
‚îÇ     - Super Admin: vid√≠ v≈°etky platformy‚îÇ
‚îÇ     - Platform Admin: vid√≠ 1 platformu  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. ROLE-BASED PERMISSIONS              ‚îÇ
‚îÇ     - Definovan√© v ROLE_PERMISSIONS     ‚îÇ
‚îÇ     - Default pr√≠stup pre ka≈æd√∫ rolu    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. COMPANY-BASED PERMISSIONS           ‚îÇ
‚îÇ     - Granular pr√≠stup k firm√°m         ‚îÇ
‚îÇ     - Read/Write/Delete per resource    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üë§ User Roles

### S√∫ƒçasn√© Role (November 2024)

| Role | Popis | Platform Access | Company Access |
|------|-------|-----------------|----------------|
| **super_admin** | Master admin, vid√≠ v≈°etko | ‚úÖ V≈°etky platformy | ‚úÖ V≈°etky firmy |
| **admin** | Platform admin | ‚ö†Ô∏è DEPRECATED | ‚ö†Ô∏è DEPRECATED |
| **company_admin** | Admin konkr√©tnej platformy | ‚úÖ Jedna platforma | ‚úÖ V≈°etky firmy platformy |
| **platform_admin** | Platform admin (nov√° rola) | ‚úÖ Jedna platforma | ‚úÖ V≈°etky firmy platformy |
| **platform_employee** | Zamestnanec platformy | ‚úÖ Jedna platforma | üîê Podƒæa permissions |
| **employee** | Zamestnanec | ‚ö†Ô∏è DEPRECATED | ‚ö†Ô∏è DEPRECATED |
| **investor** | Investor/spoluvlastn√≠k | ‚úÖ Jedna platforma | üîó Cez linkedInvestorId |
| **temp_worker** | Doƒçasn√Ω pracovn√≠k | ‚úÖ Jedna platforma | üîê Podƒæa permissions |
| **mechanic** | Mechanik | ‚úÖ Jedna platforma | üîê Podƒæa permissions |
| **sales_rep** | Obchodn√Ω z√°stupca | ‚úÖ Jedna platforma | üîê Podƒæa permissions |

### Deprecated Role
- `admin` ‚Üí pou≈æ√≠va≈• `company_admin` alebo `platform_admin`
- `employee` ‚Üí pou≈æ√≠va≈• `platform_employee`
- `company_admin` (star√Ω) ‚Üí pou≈æ√≠va≈• `company_admin` s `platformId`

---

## üåê Platform Multi-Tenancy

### ≈†trukt√∫ra

```typescript
interface Platform {
  id: string;              // UUID
  name: string;            // "Blackrent", "Impresario"
  isActive: boolean;
  createdAt: Date;
  updatedAt?: Date;
}

interface User {
  id: string;
  username: string;
  email: string;
  role: UserRole;
  platformId: string;      // ‚úÖ POVINN√â pre v≈°etk√Ωch (okrem super_admin)
  linkedInvestorId?: string; // Pre investor role
  // ... ostatn√© polia
}
```

### Platform Isolation Rules

#### 1. Super Admin
```typescript
// Vid√≠ V≈†ETKO naprieƒç v≈°etk√Ωmi platformami
if (user.role === 'super_admin') {
  return allData; // ≈Ωiadne filtrovanie
}
```

#### 2. Platform Admin / Company Admin
```typescript
// Vid√≠ LEN d√°ta svojej platformy
if (user.role === 'admin' || user.role === 'company_admin') {
  return data.filter(item => item.platformId === user.platformId);
}
```

#### 3. Regular Users
```typescript
// Vid√≠ LEN d√°ta podƒæa company permissions
if (user.role === 'employee' || user.role === 'mechanic') {
  const userCompanyAccess = await getUserCompanyAccess(user.id);
  return data.filter(item => 
    userCompanyAccess.some(access => 
      access.companyId === item.companyId
    )
  );
}
```

### Platform-Specific Features

#### Email Monitoring (Blackrent Only)
```typescript
// Layout.tsx
const BLACKRENT_PLATFORM_ID = '56d0d727-f725-47be-9508-d988ecfc0705';

{
  text: 'Email monitoring',
  icon: <MailIcon />,
  path: '/email-monitoring',
  resource: 'users' as const,
  blackrentOnly: true, // ‚úÖ Skryt√© pre ostatn√© platformy
}

// Filter logic
if ((item as any).blackrentOnly) {
  if (user?.role === 'super_admin') {
    return true; // Super admin vid√≠ v≈°etko
  }
  if (user?.role === 'admin' || user?.role === 'company_admin') {
    return user?.platformId === BLACKRENT_PLATFORM_ID;
  }
  return false; // Ostatn√≠ nevidia
}
```

---

## üîê Permission System

### 1. Role-Based Permissions (Default)

**S√∫bor:** `src/hooks/usePermissions.ts`

```typescript
const ROLE_PERMISSIONS: Record<UserRole, RolePermissions> = {
  super_admin: {
    vehicles: { read: true, write: true, delete: true },
    rentals: { read: true, write: true, delete: true },
    expenses: { read: true, write: true, delete: true },
    customers: { read: true, write: true, delete: true },
    users: { read: true, write: true, delete: true },
    insurances: { read: true, write: true, delete: true },
    finances: { read: true, write: true, delete: true },
    companies: { read: true, write: true, delete: true }
  },
  admin: {
    // V≈°etko TRUE
  },
  company_admin: {
    // V≈°etko TRUE pre svoju platformu
  },
  employee: {
    vehicles: { read: true, write: true, delete: false },
    rentals: { read: true, write: true, delete: false },
    expenses: { read: true, write: true, delete: false },
    customers: { read: true, write: true, delete: false },
    // ...
  },
  investor: {
    vehicles: { read: true, write: false, delete: false },
    rentals: { read: true, write: false, delete: false },
    expenses: { read: true, write: false, delete: false },
    finances: { read: true, write: false, delete: false },
    // Read-only pr√≠stup
  },
  // ... ostatn√© role
};
```

### 2. Company-Based Permissions (Granular)

**Database tabuƒæky:**
```sql
-- UserCompanyAccess: Ktor√© firmy vid√≠ user
CREATE TABLE user_company_access (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  company_id UUID REFERENCES companies(id),
  company_name TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- CompanyPermissions: ƒåo m√¥≈æe robi≈• s firmou
CREATE TABLE company_permissions (
  id UUID PRIMARY KEY,
  user_company_access_id UUID REFERENCES user_company_access(id),
  resource TEXT, -- 'vehicles', 'rentals', 'expenses'
  can_read BOOLEAN DEFAULT false,
  can_write BOOLEAN DEFAULT false,
  can_delete BOOLEAN DEFAULT false
);
```

**Pou≈æitie:**
```typescript
// Frontend
const { userCompanyAccess } = usePermissionsContext();
const { hasPermission } = usePermissions();

// Zisti ƒçi user m√° pr√≠stup k firme
const canAccessCompany = (companyId: string) => {
  return userCompanyAccess.some(access => 
    access.companyId === companyId
  );
};

// Zisti ≈°pecifick√© permissions
const result = hasPermission('vehicles', 'write');
// result = { hasAccess: true, allowedCompanyIds: ['uuid1', 'uuid2'] }
```

---

## üè¢ User-Company Relationships

### Deprecated: User.companyId
```typescript
// ‚ùå STAR√ù SYST√âM (deprecated)
interface User {
  companyId?: string; // NEPOU≈Ω√çVA≈§!
}

// ‚úÖ NOV√ù SYST√âM
interface User {
  platformId: string;        // Priradenie k platforme
  linkedInvestorId?: string; // Pre investorov
}
```

### Platform ‚Üí Companies ‚Üí Users Flow

```
Platform (Blackrent)
  ‚îú‚îÄ‚îÄ Company 1 (Autopo≈æiƒçov≈àa A)
  ‚îÇ     ‚îú‚îÄ‚îÄ Vehicles
  ‚îÇ     ‚îú‚îÄ‚îÄ Rentals
  ‚îÇ     ‚îî‚îÄ‚îÄ Expenses
  ‚îú‚îÄ‚îÄ Company 2 (Autopo≈æiƒçov≈àa B)
  ‚îÇ     ‚îú‚îÄ‚îÄ Vehicles
  ‚îÇ     ‚îî‚îÄ‚îÄ ...
  ‚îî‚îÄ‚îÄ Users
        ‚îú‚îÄ‚îÄ Admin (platformId = Blackrent) ‚Üí vid√≠ Company 1 + 2
        ‚îú‚îÄ‚îÄ Employee (platformId = Blackrent + permissions) ‚Üí vid√≠ len Company 1
        ‚îî‚îÄ‚îÄ Investor (platformId = Blackrent + linkedInvestorId) ‚Üí vid√≠ firmy podƒæa podielov
```

### Company Assignment Logic

#### Platform Admin/Company Admin
```typescript
// Automaticky vid√≠ V≈†ETKY firmy svojej platformy
if (user.role === 'company_admin' && user.platformId) {
  const companies = await getCompanies();
  const platformCompanies = companies.filter(
    c => c.platformId === user.platformId
  );
  return platformCompanies; // V≈°etky firmy platformy
}
```

#### Regular Employee
```typescript
// Vid√≠ len firmy kde m√° UserCompanyAccess
const userCompanyAccess = await getUserCompanyAccess(user.id);
const allowedCompanyIds = userCompanyAccess.map(a => a.companyId);

const companies = await getCompanies();
return companies.filter(c => allowedCompanyIds.includes(c.id));
```

---

## üí∞ Investor Management

### Investor vs CompanyInvestor

```typescript
// 1. CompanyInvestor - business entity
interface CompanyInvestor {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  phone?: string;
  isActive: boolean;
  // Shares cez CompanyInvestorShare tabuƒæku
}

// 2. CompanyInvestorShare - ownership
interface CompanyInvestorShare {
  id: string;
  companyInvestorId: string;
  companyId: string;
  ownershipPercentage: number; // 0-100
}

// 3. User (investor role) - system access
interface User {
  role: 'investor';
  platformId: string;            // Blackrent/Impresario
  linkedInvestorId: string;      // ‚Üí CompanyInvestor.id
}
```

### Investor Data Access Flow

```
1. User prihl√°s√≠ sa (role: investor)
   ‚Üì
2. System naƒç√≠ta linkedInvestorId
   ‚Üì
3. N√°jde CompanyInvestor
   ‚Üì
4. Naƒç√≠ta CompanyInvestorShare (kde m√° podiely)
   ‚Üì
5. Filter d√°ta len pre tieto firmy
   ‚Üì
6. Zobraz read-only dashboard
```

**Backend Implementation:**
```typescript
// routes/bulk.ts, routes/rentals.ts, atƒè.
if (user.role === 'investor' && user.linkedInvestorId) {
  // N√°jdi firmy kde m√° investor podiely
  const investorShares = await getInvestorShares(user.linkedInvestorId);
  const allowedCompanyIds = investorShares.map(s => s.companyId);
  
  // Filter vozidl√°, pren√°jmy, expenses
  data = data.filter(item => 
    allowedCompanyIds.includes(item.companyId)
  );
}
```

### Creating Investor User

**Frontend Flow:**
```typescript
// BasicUserManagement.tsx
const handleCreateUser = async () => {
  // 1. User vyber√° platformu
  const platformId = selectedPlatform;
  
  // 2. User vyber√° rolu = 'investor'
  const role = 'investor';
  
  // 3. User vyber√° CompanyInvestor zo zoznamu
  const linkedInvestorId = selectedInvestor.id;
  
  // 4. API call
  await createUser({
    username,
    email,
    password,
    role,
    platformId,        // ‚úÖ Povinn√©
    linkedInvestorId   // ‚úÖ Povinn√© pre investor
  });
};
```

---

## üóÑÔ∏è Database Schema

### Users Table
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  first_name TEXT,
  last_name TEXT,
  role TEXT NOT NULL, -- UserRole enum
  
  -- MULTI-TENANCY
  platform_id UUID REFERENCES platforms(id), -- ‚úÖ POVINN√â
  
  -- INVESTOR LINKING
  linked_investor_id UUID REFERENCES company_investors(id),
  
  -- DEPRECATED
  company_id TEXT, -- ‚ùå Nepou≈æ√≠va≈•!
  
  -- METADATA
  employee_number TEXT,
  hire_date DATE,
  is_active BOOLEAN DEFAULT true,
  last_login TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP
);

-- Indexy
CREATE INDEX idx_users_platform ON users(platform_id);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_linked_investor ON users(linked_investor_id);
```

### Platforms Table
```sql
CREATE TABLE platforms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT UNIQUE NOT NULL, -- "Blackrent", "Impresario"
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP
);

-- Data
INSERT INTO platforms (id, name) VALUES
  ('56d0d727-f725-47be-9508-d988ecfc0705', 'Blackrent'),
  ('11708f27-b492-4531-adc9-0694625c39d6', 'Impresario');
```

### Companies Table
```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  
  -- MULTI-TENANCY
  platform_id UUID REFERENCES platforms(id), -- Priradenie k platforme
  
  business_id TEXT, -- IƒåO
  tax_id TEXT, -- DIƒå
  address TEXT,
  email TEXT,
  phone TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP
);

CREATE INDEX idx_companies_platform ON companies(platform_id);
```

### Company Investors System
```sql
-- Investor business entity
CREATE TABLE company_investors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Investor ownership shares
CREATE TABLE company_investor_shares (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_investor_id UUID REFERENCES company_investors(id),
  company_id UUID REFERENCES companies(id),
  ownership_percentage NUMERIC(5,2) NOT NULL, -- 0.00 - 100.00
  start_date DATE NOT NULL,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_shares_investor ON company_investor_shares(company_investor_id);
CREATE INDEX idx_shares_company ON company_investor_shares(company_id);
```

### Permissions Tables
```sql
-- User-to-Company access
CREATE TABLE user_company_access (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  company_name TEXT, -- Denormalized pre performance
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, company_id)
);

-- Granular permissions per resource
CREATE TABLE company_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_company_access_id UUID REFERENCES user_company_access(id) ON DELETE CASCADE,
  resource TEXT NOT NULL, -- 'vehicles', 'rentals', 'expenses', atƒè.
  can_read BOOLEAN DEFAULT false,
  can_write BOOLEAN DEFAULT false,
  can_delete BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_company_access_id, resource)
);
```

---

## üîå API Endpoints

### User Management

#### GET /api/auth/users
**Filtrovanie podƒæa role:**
```typescript
// Super admin - vid√≠ v≈°etk√Ωch
if (user.role === 'super_admin') {
  return allUsers;
}

// Platform admin - vid√≠ len svojich users
if (user.role === 'admin' || user.role === 'company_admin') {
  return users.filter(u => u.platformId === user.platformId);
}
```

#### POST /api/auth/users
**Create user s platform assignment:**
```typescript
router.post('/users', authenticateToken, requireRole(['admin', 'super_admin', 'company_admin']), 
  async (req, res) => {
    const { username, email, password, role, platformId, linkedInvestorId } = req.body;
    
    // Valid√°cia
    if (!platformId && role !== 'super_admin') {
      return res.status(400).json({ error: 'platformId je povinn√Ω' });
    }
    
    if (role === 'investor' && !linkedInvestorId) {
      return res.status(400).json({ error: 'linkedInvestorId je povinn√Ω pre investor' });
    }
    
    // Create user
    const newUser = await createUser({
      username,
      email,
      password,
      role,
      platformId,
      linkedInvestorId
    });
    
    return res.json({ success: true, data: newUser });
  }
);
```

#### PUT /api/auth/users/:id
**Update user s platform update:**
```typescript
router.put('/users/:id', authenticateToken, requireRole(['admin', 'super_admin', 'company_admin']),
  async (req, res) => {
    const { platformId, linkedInvestorId, ...otherFields } = req.body;
    
    const updatedUser = {
      ...existingUser,
      ...otherFields,
      platformId: platformId !== undefined ? platformId : existingUser.platformId,
      linkedInvestorId: linkedInvestorId !== undefined ? linkedInvestorId : existingUser.linkedInvestorId,
    };
    
    await updateUser(updatedUser);
    return res.json({ success: true });
  }
);
```

### Platform Filtering Endpoints

#### GET /api/vehicles
```typescript
// Platform admin - len vozidl√° platformy
if (user.role === 'company_admin' && user.platformId) {
  vehicles = vehicles.filter(v => v.platformId === user.platformId);
}
```

#### GET /api/leasings
```typescript
// Platform admin - len leasingy platformy
if (user.role === 'admin' || user.role === 'company_admin') {
  leasings = leasings.filter(l => l.platformId === user.platformId);
}
```

#### GET /api/insurances
```typescript
// Platform admin - len insurances pre vozidl√° platformy
if (user.role === 'admin' || user.role === 'company_admin') {
  const platformVehicles = vehicles.filter(v => v.platformId === user.platformId);
  const platformVehicleIds = platformVehicles.map(v => v.id);
  insurances = insurances.filter(i => platformVehicleIds.includes(i.vehicleId));
}
```

---

## üé® Frontend Architecture

### Context Providers

#### AuthContext
```typescript
interface AuthContextType {
  user: User | null;
  login: (username: string, password: string) => Promise<void>;
  logout: () => void;
  canAccessCompany: (companyId: string) => boolean;
}

// Pou≈æitie
const { user, canAccessCompany } = useAuth();

if (user?.role === 'super_admin') {
  // Vid√≠ v≈°etko
}

if (user?.role === 'company_admin') {
  // Vid√≠ len svoju platformu
}
```

#### PermissionsContext
```typescript
interface PermissionsContextType {
  userCompanyAccess: UserCompanyAccess[];
  isLoading: boolean;
}

// Pou≈æitie
const { userCompanyAccess } = usePermissionsContext();

const allowedCompanyIds = userCompanyAccess.map(a => a.companyId);
```

### Hooks

#### usePermissions
```typescript
const { hasPermission } = usePermissions();

// Role-based check
const canViewVehicles = hasPermission('vehicles', 'read').hasAccess;

// Company-specific check
const result = hasPermission('vehicles', 'write');
// result = { 
//   hasAccess: true, 
//   allowedCompanyIds: ['uuid1', 'uuid2'],
//   bypassCompanyCheck: false 
// }
```

### Components

#### BasicUserManagement.tsx
**User creation with platform:**
```tsx
<Dialog>
  <DialogContent>
    {/* Platform Selector */}
    <Select
      value={userForm.platformId}
      onValueChange={(value) => setUserForm({...userForm, platformId: value})}
    >
      {platforms.map(p => (
        <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>
      ))}
    </Select>
    
    {/* Role Selector */}
    <Select
      value={userForm.role}
      onValueChange={(value) => setUserForm({...userForm, role: value})}
    >
      <SelectItem value="company_admin">Platform Admin</SelectItem>
      <SelectItem value="employee">Employee</SelectItem>
      <SelectItem value="investor">Investor</SelectItem>
    </Select>
    
    {/* Investor Selector (conditional) */}
    {userForm.role === 'investor' && (
      <Select
        value={userForm.linkedInvestorId}
        onValueChange={(value) => setUserForm({...userForm, linkedInvestorId: value})}
      >
        {investors.map(inv => (
          <SelectItem key={inv.id} value={inv.id}>
            {inv.firstName} {inv.lastName}
          </SelectItem>
        ))}
      </Select>
    )}
  </DialogContent>
</Dialog>
```

#### Platform Filtering in Lists
```tsx
// Automatic filtering via backend API
const { data: users } = useUsers(); // Already filtered by platformId

// Manual filtering (if needed)
const platformUsers = users?.filter(u => 
  user.role === 'super_admin' || u.platformId === user.platformId
);
```

---

## üîç Data Flow Examples

### Example 1: Platform Admin Login

```
1. User "jaro" prihl√°si sa
   ‚îú‚îÄ role: company_admin
   ‚îú‚îÄ platformId: "11708f27-..." (Impresario)
   ‚îî‚îÄ platformName: "Impresario"

2. Frontend naƒç√≠ta permissions
   ‚îú‚îÄ ROLE_PERMISSIONS['company_admin'] ‚Üí v≈°etko TRUE
   ‚îî‚îÄ userCompanyAccess ‚Üí pr√°zdne (nie je potrebn√©)

3. User ide na "Vozidl√°"
   ‚îú‚îÄ GET /api/vehicles
   ‚îú‚îÄ Backend filter: vehicles.filter(v => v.platformId === jaro.platformId)
   ‚îî‚îÄ Return: len Impresario vozidl√°

4. User ide na "Email monitoring"
   ‚îú‚îÄ Frontend check: blackrentOnly === true
   ‚îú‚îÄ jaro.platformId !== BLACKRENT_ID
   ‚îî‚îÄ Menu item skryt√Ω ‚ùå

5. User ide na "Spr√°va pou≈æ√≠vateƒæov"
   ‚îú‚îÄ GET /api/auth/users
   ‚îú‚îÄ Backend filter: users.filter(u => u.platformId === jaro.platformId)
   ‚îî‚îÄ Return: len Impresario users
```

### Example 2: Investor Access

```
1. User "miki" prihl√°si sa
   ‚îú‚îÄ role: investor
   ‚îú‚îÄ platformId: "56d0d727-..." (Blackrent)
   ‚îî‚îÄ linkedInvestorId: "investor-uuid-123"

2. Backend naƒç√≠ta investor shares
   ‚îú‚îÄ CompanyInvestor(investor-uuid-123)
   ‚îú‚îÄ CompanyInvestorShare: [
   ‚îÇ     { companyId: "company-A", ownership: 30% },
   ‚îÇ     { companyId: "company-B", ownership: 20% }
   ‚îÇ   ]
   ‚îî‚îÄ allowedCompanyIds = ["company-A", "company-B"]

3. User ide na "Vozidl√°"
   ‚îú‚îÄ GET /api/vehicles
   ‚îú‚îÄ Backend filter: 
   ‚îÇ     vehicles.filter(v => 
   ‚îÇ       v.ownerCompanyId === "company-A" || 
   ‚îÇ       v.ownerCompanyId === "company-B"
   ‚îÇ     )
   ‚îî‚îÄ Return: len vozidl√° firiem A a B

4. Frontend permissions
   ‚îú‚îÄ ROLE_PERMISSIONS['investor'] ‚Üí v≈°etko READ-ONLY
   ‚îú‚îÄ hasPermission('vehicles', 'write') ‚Üí FALSE
   ‚îî‚îÄ Edit buttons skryt√© ‚ùå
```

### Example 3: Super Admin Access

```
1. User "admin" prihl√°si sa
   ‚îú‚îÄ role: super_admin
   ‚îî‚îÄ platformId: null (alebo ƒæubovoƒæn√©)

2. Frontend naƒç√≠ta permissions
   ‚îî‚îÄ ROLE_PERMISSIONS['super_admin'] ‚Üí v≈°etko TRUE

3. User ide na "Vozidl√°"
   ‚îú‚îÄ GET /api/vehicles
   ‚îú‚îÄ Backend check: user.role === 'super_admin'
   ‚îú‚îÄ Skip v≈°etky filters
   ‚îî‚îÄ Return: V≈†ETKY vozidl√° (v≈°etky platformy)

4. User ide na "Email monitoring"
   ‚îú‚îÄ Frontend check: user.role === 'super_admin'
   ‚îî‚îÄ Menu item viditeƒæn√Ω ‚úÖ

5. User ide na "Spr√°va pou≈æ√≠vateƒæov"
   ‚îú‚îÄ GET /api/auth/users
   ‚îú‚îÄ Backend check: user.role === 'super_admin'
   ‚îî‚îÄ Return: V≈†ETCI users (v≈°etky platformy)
```

---

## üìù Best Practices

### 1. Creating New User
```typescript
// ‚úÖ CORRECT
const newUser = {
  username: 'john',
  email: 'john@example.com',
  role: 'employee',
  platformId: selectedPlatform.id, // POVINN√â
};

// ‚ùå WRONG
const newUser = {
  username: 'john',
  companyId: 'some-company-id', // DEPRECATED!
};
```

### 2. Checking Permissions
```typescript
// ‚úÖ CORRECT - Use hook
const { hasPermission } = usePermissions();
if (hasPermission('vehicles', 'write').hasAccess) {
  // Show edit button
}

// ‚ùå WRONG - Direct check
if (user.role === 'admin') { // Pr√≠li≈° broad
  // Show edit button
}
```

### 3. Filtering Data
```typescript
// ‚úÖ CORRECT - Backend filtering
const vehicles = await getVehicles(); // Already filtered by backend

// ‚ùå WRONG - Client-side filtering
const allVehicles = await getAllVehicles();
const filtered = allVehicles.filter(...); // Performance issue
```

### 4. Platform-Specific Features
```typescript
// ‚úÖ CORRECT - Check platformId
if (user.platformId === BLACKRENT_PLATFORM_ID) {
  return <EmailMonitoring />;
}

// ‚ùå WRONG - Check role only
if (user.role === 'admin') { // Pr√≠li≈° broad
  return <EmailMonitoring />;
}
```

---

## üêõ Troubleshooting

### Problem: User nevid√≠ ≈æiadne d√°ta
```typescript
// Check 1: M√° user platformId?
console.log('User platformId:', user.platformId);

// Check 2: Maj√∫ d√°ta platformId?
console.log('Vehicle platformId:', vehicle.platformId);

// Check 3: Zhoda?
console.log('Match:', user.platformId === vehicle.platformId);

// Fix: Update user platformId
UPDATE users SET platform_id = 'correct-platform-id' WHERE id = 'user-id';
```

### Problem: User vid√≠ d√°ta inej platformy
```typescript
// Check: Backend filtering
// Backend route (vehicles.ts, leasings.ts, atƒè.)
if (req.user?.role === 'company_admin' && req.user.platformId) {
  data = data.filter(item => item.platformId === req.user.platformId);
}
```

### Problem: Investor nevid√≠ firmy
```typescript
// Check 1: M√° linkedInvestorId?
console.log('linkedInvestorId:', user.linkedInvestorId);

// Check 2: M√° CompanyInvestor shares?
SELECT * FROM company_investor_shares 
WHERE company_investor_id = 'linkedInvestorId';

// Fix: Create share
INSERT INTO company_investor_shares (
  company_investor_id, company_id, ownership_percentage
) VALUES ('investor-id', 'company-id', 30.00);
```

---

## üìö Related Documentation

- `PLATFORM_MULTI_TENANCY_IMPLEMENTATION_COMPLETE.md` - Implementation details
- `backend/migrations/001_add_platform_multi_tenancy.sql` - Database migration
- `backend/migrations/002_add_linked_investor_id.sql` - Investor linking
- `backend/migrations/003_add_platform_to_leasings.sql` - Leasings platform
- `src/hooks/usePermissions.ts` - Permission logic
- `src/context/PermissionsContext.tsx` - Permission context

---

**Vytvoren√©:** 10. okt√≥bra 2025  
**Posledn√° aktualiz√°cia:** 10. okt√≥bra 2025  
**Autor:** BlackRent Development Team  
**Verzia:** 2.0 (Multi-Tenancy Implementation)

